var app=angular.module("CMCApp",["ngRoute"]),locaNotifyFun=function(type,message){$.extend($.gritter.options,{position:"bottom-right"}),$.gritter.add({title:type,text:message,sticky:!0,fade:!0,time:6,class_name:"my-sticky-class"})};app.service("request",function($http,$rootScope){this.sync=function(sendType,urlToPost,dataToSend,fsuccess,ffailed,asyncIs=!1){return $.ajax({async:asyncIs,type:sendType,url:urlToPost,data:dataToSend,success:fsuccess,error:ffailed})},this.backend=function(routeName,data={},successFunction=null,successMessage="",isForm=!1){var urlToPost="backend/"+routeName;if(isForm)$.ajax({url:urlToPost,type:"POST",data,async:!0,success:function(msg){msg.success?(successFunction&&successFunction(msg.data?msg.data:[]),successMessage.length>=2&&locaNotifyFun("Sukces",successMessage)):(msg.error&&locaNotifyFun("Bład",msg.error),"Nie masz wystarczających uprawnień"==msg.error&&(Cookies.remove("tq"),document.location="login"))},error:function(jqXHR,textStatus){console.log("Blad podczas laczenia z serverem: "+textStatus),locaNotifyFun("Bład","Niestety nie udało się połączyć z serverem")},cache:!1,contentType:!1,processData:!1});else{var dataToSend=Object.assign({token:Cookies.get("tq")},data);$.ajax({url:urlToPost,type:"POST",data:dataToSend,async:!0,success:function(msg){msg.success?(successFunction&&successFunction(msg.data?msg.data:[]),successMessage.length>2&&locaNotifyFun("Sukces",successMessage)):(msg.error&&locaNotifyFun("Bład",msg.error),"Nie masz wystarczających uprawnień"==msg.error&&(Cookies.remove("tq"),document.location="login"))},error:function(jqXHR,textStatus){console.log("Blad podczas laczenia z serverem: "+textStatus),locaNotifyFun("Bład","Niestety nie udało się połączyć z serverem")}})}}}),app.service("auth",function($http,$rootScope,request){this.logIn=function(login,password){var toReturn,dataToSend={email:login,pass:password};return request.sync("POST","backend/login",dataToSend,function(reqData){console.log(reqData),reqData.success&&(Cookies.remove("tq"),Cookies.set("tq",reqData.token,{expires:1})),toReturn=reqData},function(jqXHR,textStatus){console.log("Bład podczas komunikacji z serverem: "+textStatus),toReturn=!1}),toReturn},this.logout=function(){Cookies.remove("tq"),document.location="login"},this.checkIsLogged=function(){var token=Cookies.get("tq");if(null!=token&&token.length>5){var dataToSend={token};request.sync("POST","backend/checkIsLoged",dataToSend,function(reqData){reqData.success?toReturn=!0:toReturn=!1},function(jqXHR,textStatus){console.log("Bład podczas komunikacji z serverem: "+textStatus),toReturn=!1})}else toReturn=!1;return toReturn},this.getUserData=function(){var tq=Cookies.get("tq"),toReturn=!1;if(null!=tq&&tq.length>5){var dataToSend={token:tq};request.sync("POST","backend/getUserData",dataToSend,function(reqData){toReturn=reqData,$rootScope.user.email=reqData.data.email,$rootScope.user.token=Cookies.get("tq"),$rootScope.user.role=reqData.data.name,$rootScope.user.id=reqData.data.user_id,$rootScope.user.firstname=reqData.data.firstname,$rootScope.user.lastname=reqData.data.lastname,$rootScope.user.birthdate=reqData.data.birthdate,$rootScope.user.imgPath=reqData.data.user_img_path,$rootScope.user.addAccountDate=reqData.data.create_account_date,$rootScope.user.addAccountDate=reqData.data.create_account_date,$rootScope.user.height=reqData.data.height,$rootScope.user.tel=reqData.data.tel,$rootScope.user.parentTel=reqData.data.parent_tel,$rootScope.user.weight=reqData.data.weight,$rootScope.user.mainLeg=reqData.data.main_leg,$rootScope.user.mainPosition=reqData.data.main_position,$rootScope.user.bodyType=reqData.data.body_type,$rootScope.user.address=reqData.data.address,$rootScope.user.license_type=reqData.data.license_type},function(jqXHR,textStatus){console.log("Bład podczas komunikacji z serverem: "+textStatus),toReturn=!1})}return toReturn},this.checkPerm=function(permission){if(null==$rootScope.user||null==$rootScope.user.role)return!1;for(var i=0;i<permission.length;i++)if(permission[i]===$rootScope.user.role)return!0}}),app.service("notify",function($http,$rootScope,request){this.Notification=function(_title,_to,_url="",_toAll=!1){this.title=_title,this.to=_to,this.toAll=_toAll,this.url=_url},this.localNotify=locaNotifyFun,this.addNew=function(notifyObj){var dataToSend={token:$rootScope.user.token,usid:$rootScope.user.id,tmid:$rootScope.user.tmid,title:notifyObj.title,to:notifyObj.to,toAll:notifyObj.toAll,url:notifyObj.url};request.sync("POST","backend/addNotify",dataToSend,function(e){},function(jqXHR,textStatus){console.log("Bład podczas komunikacji z serverem: "+textStatus)},!0)},this.getNew=function(firstIs=!1){var dataToSend={token:$rootScope.user.token,usid:$rootScope.user.id,tmid:$rootScope.user.tmid};local=this.localNotify,request.sync("POST","backend/getNewNotify",dataToSend,function(reqData){reqData.success&&$rootScope.$apply(function(){if(reqData.data)if(reqData.data[0]){if(reqData.data[0].id===$rootScope.lastNotId)return;$rootScope.lastNotId=reqData.data[0].id,$rootScope.newNotify=reqData.data;let count=0,toShow=null;for(var i=0;i<$rootScope.newNotify.length;i++)"1"===reqData.data[i].is_new&&(count++,toShow=reqData.data[i]);if(toShow&&!firstIs&&(local("Otrzymano powiadomienie",toShow.title),Notification))if("granted"===Notification.permission)new Notification(toShow.title);else Notification.requestPermission(function(permission){if("granted"===permission)new Notification(toShow.title)});$rootScope.notifyCount=count}else $rootScope.notifyCount=0})},function(jqXHR,textStatus){console.log("Bład podczas komunikacji z serverem: "+textStatus)},!0)},this.getAll=function(){var dataToSend={token:$rootScope.user.token,usid:$rootScope.user.id,tmid:$rootScope.user.tmid};request.sync("POST","backend/getAllNotify",dataToSend,function(reqData){reqData.success&&$rootScope.$apply(function(){$rootScope.allNotify=reqData.data})},function(jqXHR,textStatus){console.log("Bład podczas komunikacji z serverem: "+textStatus)},!0)},this.setNewOff=function(){if(!($rootScope.notifyCount<=0)){for(var notIds=[],i=0;i<$rootScope.newNotify.length;i++)notIds.push($rootScope.newNotify[i].id);var dataToSend={token:$rootScope.user.token,usid:$rootScope.user.id,tmid:$rootScope.user.tmid,ntid:notIds};request.sync("POST","backend/setNewNotifyOff",dataToSend,function(msg){$rootScope.$apply(function(){$rootScope.notifyCount=0})},function(jqXHR,textStatus){console.log("Bład podczas komunikacji z serverem: "+textStatus)},!0)}}}),app.service("statistic",function($http,$rootScope,request){this.getStats=function(userId,functionSuccess,async=!0){var dataToSend={token:$rootScope.user.token,usid:userId,tmid:$rootScope.user.tmid},toReturn=[];return request.sync("POST","backend/getStats",dataToSend,function(reqData){reqData.success?$rootScope.$apply(function(){$rootScope.actualStats=reqData.data,toReturn=reqData.data,functionSuccess()}):console.log("blad")},function(jqXHR,textStatus){console.log("Bład podczas komunikacji z serverem: "+textStatus)},async),toReturn},this.getTeamForm=function(usersId=[],isMatchTeamForm=!1){if(!usersId||0==usersId.length)return 0;var returnedData=this.getStats(usersId,function(){},!1);return parseFloat(100*(isMatchTeamForm?returnedData.teamForm/1100:returnedData.teamForm/(100*usersId.length))).toFixed(2)},this.getTeamStats=function(usersId=[],functionAfter){$rootScope.actualStats=this.getStats(usersId,function(){},!1),$rootScope.actualStats=$rootScope.actualStats.users,functionAfter()}}),app.controller("accountController",function($scope,auth,$rootScope,request,notify){$scope.logout=auth.logout;let interval=null;$scope.initAccount=function(){auth.checkIsLogged()?(interval&&clearInterval(interval),interval=setInterval(function(){$(".prettydate").each(function(){$(this).prettydate()})},200)):auth.logout()},$scope.$on("$viewContentLoaded",function(){if(!auth.checkPerm($rootScope.viewPerm)){if(!auth.checkIsLogged())return void auth.logout();document.location="#!badPerm"}}),$scope.setPerm=function(perm){$rootScope.viewPerm=perm},$scope.updateUserDate=function(isPass=!1){var id=isPass?"#userUpdateDataFormPassImg":"#userUpdateDataForm";request.backend("updateUserData",new FormData($(id)[0]),function(data){$rootScope.$apply(function(){auth.getUserData()})},"Twoje dane zostały pomyślnie zaktualizowane. Niektóre zmiany mogą być widoczne dopiero po odświeżeniu strony.( ctrl+f5 )",!0)},$(document).off("change","#userImgFile"),$(document).on("change","#userImgFile",function(event){if(event.target.files[0].size/1024/1024>1.5)return notify.localNotify("Walidacja","Zdjęcie jest zbyt dużę. Maksymalny dozwolony rozmiar to 1.5 MB "),void $(this).val("");var tmppath=URL.createObjectURL(event.target.files[0]);$("#imgPrev").fadeIn("fast").attr("src",tmppath),request.backend("updateUserData",new FormData($("#userUpdateDataFormPassImg")[0]),function(data){$rootScope.$apply(function(){auth.getUserData(),$rootScope.user.imgPath=tmppath})},"Twoje zdjęcie zostało zmienione.",!0)})}),app.controller("feedbackController",function($scope,auth,$rootScope,notify,request){$scope.showContent=!1,$scope.raportsList=[],$scope.initFeedback=function(){$scope.showContent=!0},$scope.sendFeedback=function(){var content=$("#contentFeed").val(),type=$rootScope.feedType;!content||content.length<=5?notify.localNotify("Walidacja","Prosimy o wpisanie dłuższej wiadomości."):request.backend("sendFeedback",{firstname:$rootScope.user.firstname,lastname:$rootScope.user.lastname,tmid:$rootScope.user.tmid,content,type},function(data){$("#contentFeed").val("")},"Dziękujemy za udział w poprawie standardów naszej platformy.")}}),app.controller("showPlayersController",function($scope,auth,$rootScope,notify,request){function getUserRaports($userId){request.backend("getRaport",{usid:$userId,tmid:$rootScope.user.tmid},function(data){$scope.$apply(function(){$scope.actualSelectedUserRaports=data,$scope.showPlayerNow=!0,$scope.showPreLoad=!1})})}$scope.players,$scope.actualSelectedUserData,$scope.actualSelectedUserStats,$scope.actualSelectedUserRaports,$scope.showPlayerNow=!1,$scope.showPreLoad=!1,$scope.personShow=!1,$scope.personAddShow=!1,$scope.openCard=function(name){$("#"+name).toggle("blind",null,"fast"),$scope.personShow=!$scope.personShow},$scope.openCardFt=function(name){$("#"+name).toggle("blind",null,"fast"),$scope.personAddShow=!$scope.personAddShow},$scope.addPersonFromApp=function(){var selected=$("#selectPersonFromApp").val();selected&&null!=selected&&""!=selected?request.backend("addPlayerToTeam",{tmid:$rootScope.user.tmid,usid:$scope.teamPlayer[selected].usid},function(data){$scope.getAllPlayers(),notify.addNew(new notify.Notification("Zostałeś przypisany do nowej sekcji: ",[$scope.teamPlayer[selected].usid]))},"Zawodnik dodany pomyslnie do tej sekcji"):notify.localNotify("Walidacja","Wybierz najpierw zawodnika z listy dostępnych")},$scope.getAllPlayers=function(){$rootScope.showContent=!1,request.backend("getAllPlayers",{tmid:$rootScope.user.tmid},function(data){$scope.$apply(function(){$scope.players=data,$scope.showContent=!0})}),request.backend("getAllPlayersFromApp",{tmid:$rootScope.user.tmid},function(data){$scope.$apply(function(){$scope.teamPlayer=data,$("#selectPersonFromApp").html(""),$("#selectPersonFromApp").append("<option value='' disabled> Wybierz użytkownika </option>");for(var i=0;i<data.length;i++)$("#selectPersonFromApp").append("<option value='"+i+"'>"+data[i].firstname+" "+data[i].lastname+"</option>");$("select").material_select()})})},$scope.showThisPlayer=function(usidN){$scope.showPreLoad=!0,request.backend("getAllUserData",{usid:usidN},function(data){$scope.$apply(function(){$scope.actualSelectedUserData=data,$scope.actualSelectedUserData.id=usidN}),getUserRaports(usidN)})},$scope.deleteUser=function(usidN){$rootScope.showModalWindow("Usunięcie użytkownika z sekcji",function(){request.backend("deleteUser",{usid:usidN,tmid:$rootScope.user.tmid},function(){$scope.getAllPlayers(),notify.addNew(new notify.Notification("Zostałeś usunięty z sekcji: "+$rootScope.teamNameStr,[usidN],"#!/"))},"Osoba usunięta z sekcji")})},$scope.addPerson=function(){var firstname=$("#addedFirstname").val(),lastname=$("#addedLastname").val(),email=$("#addedEmail").val();/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(email)?firstname.length<3||lastname.length<3?notify.localNotify("Bład","Imię lub nazwisko jest zbyt krótkie"):request.backend("addPerson",{tmid:$rootScope.user.tmid,fname:firstname,lname:lastname,mail:email,isPersonel:!1,isAdmin:"false"},function(){$("#addedFirstname").val(""),$("#addedLastname").val(""),$("#addedEmail").val(""),$scope.getAllPlayers()},"Osoba została dodana. Na jej adres email zostało wysłane hasło. Wiadomość może trafić do folderu spam"):notify.localNotify("Bład","Popraw wpisany adres email")},$scope.resendPassword=function(id){request.backend("recreatePassword",{usid:id},function(){},"Pomyślnie zmieniono hasło i wysłano maila z hasłem")},$scope.addRaport=function(){$name=$("#raportName").val(),$name.length<=3?notify.localNotify("Walidacja","Wpisz nazwę raportu"):request.backend("addRaport",new FormData($("#raportForm")[0]),function(data){notify.addNew(new notify.Notification("Uzyskałeś raport: "+$name,[$scope.actualSelectedUserData.id],"#!/myRaports")),getUserRaports($scope.actualSelectedUserData.id)},"Twoj plik został przesłany pomyślnie.",!0)},$scope.deleteRaport=function(rpid){$rootScope.showModalWindow("Usunięcie raportu użytkownika",function(){request.backend("deleteRaport",{id:rpid},function(){getUserRaports($scope.actualSelectedUserData.id)},"Plik zostal usuniety")})}}),app.controller("notifyController",function($scope,auth,$rootScope,notify,request){$scope.allNotify=[],request.backend("getAllNotify",{usid:$rootScope.user.id,tmid:$rootScope.user.tmid},function(data){$scope.$apply(function(){$scope.allNotify=data,setTimeout(function(){$(".prettydate").prettydate(),$.fn.prettydate.setDefaults()},500)})})}),app.controller("myRaportsController",function($scope,auth,$rootScope,notify,request){$scope.showContent=!1,$scope.raportsList=[],$scope.initRaports=function(){var $userId;$userId=$rootScope.user.id,request.backend("getRaport",{usid:$userId,tmid:$rootScope.user.tmid},function(data){$scope.$apply(function(){$scope.raportsList=data,$scope.showContent=!0})})}}),app.controller("settingsController",function($scope,auth,$rootScope,request,notify){function getInstalledModules(){request.backend("getInstalledModules",{},function(data){$scope.$apply(function(){for(var i=0;i<data.length;i++){for(var req="",j=0;j<data[i].require.length;j++)req+=" "+data[i].require[j];data[i].require=req}$scope.installedModules=data})})}function getAvilableModules(){request.backend("getAvailableModules",{},function(data){$scope.$apply(function(){for(var i=0;i<data.length;i++){for(var req="",j=0;j<data[i].require.length;j++)req+=" "+data[i].require[j];data[i].require=req}$scope.notInstalledModules=data,$scope.showContent=!0})})}function getMainSettings(){request.backend("getMainPageSettings",{},function(data){$rootScope.$apply(function(){$rootScope.mainSettings=data,$(document).ready(function(){Materialize.updateTextFields()})}),$scope.$apply(function(){$scope.showContent=!0})})}$scope.showContent=!1,$scope.installedModules=[],$scope.notInstalledModules=[],$scope.toUpdateModule=[],$scope.actualTheme="",$scope.allThemes=[],$scope.initSettings=function(){getInstalledModules(),getAvilableModules()},$scope.initThemes=function(){request.backend("getCurrentThemes",{},function(data){$scope.$apply(function(){$scope.actualTheme=data}),request.backend("getAvailableThemes",{},function(data){$scope.$apply(function(){$scope.allThemes=data,$scope.showContent=!0,$("#selectThemes").html(""),$("#selectThemes").append("<option value='' disabled >Szablony</option>");for(var i=0;i<$scope.allThemes.length;i++)$scope.allThemes[i]==$scope.actualTheme?$("#selectThemes").append("<option value='"+$scope.allThemes[i]+"' selected>"+$scope.allThemes[i]+"</option>"):$("#selectThemes").append("<option value='"+$scope.allThemes[i]+"'>"+$scope.allThemes[i]+"</option>");$("select").material_select()})})})},$scope.initMainSettings=function(){getMainSettings()},$scope.installModule=function(moduleName){request.backend("installModule",{name:moduleName},function(data){getInstalledModules(),getAvilableModules()},"Moduł zainstalowany. Odświerz stronę, aby zobaczyć zmiany")},$scope.uninstallModule=function(moduleName){request.backend("uninstallModule",{name:moduleName},function(data){getInstalledModules(),getAvilableModules()},"Moduł odinstalowany. Odświerz stronę, aby zobaczyć zmiany")},$scope.addModule=function(){if(0!==$("#moduleFile").get(0).files.length){var data=new FormData($("#addModuleForm")[0]);request.backend("addModule",data,function(){getAvilableModules()},"Moduł dodany pomyślnie",!0)}else notify.localNotify("Walidacja","Dodaj najpierw plik modułu")},$scope.checkAppUpdate=function(){notify.localNotify("Update","Posiadasz aktualną wersję aplikacji")},$scope.checkUpdateModule=function(){request.backend("checkModuleUpdate",{},function(data){$scope.$apply(function(){$scope.toUpdateModule=data})})},$scope.updateModule=function(moduleName){request.backend("installUpdateToModule",{moduleName},function(data){},"Moduł zaktualizowany pomyślnie. Odświerz stronę, aby zobaczyć zmiany.")},$(document).off("change","#selectThemes"),$(document).on("change","#selectThemes",function(){request.backend("setCurrentTheme",{name:$(this).val()},null,"Pomyślnie zmieniono szablon. Odśwież stronę, aby zobaczyć zmiany. (ctrl+f5)")}),$(document).off("change","#logoFile"),$(document).on("change","#logoFile",function(){if(0!==$("#logoFile").get(0).files.length){var data=new FormData($("#addLogoForm")[0]);request.backend("changePageLogo",data,function(){var reader=new FileReader;reader.onload=function(e){$("#prevLogo").attr("src",e.target.result)},reader.readAsDataURL($("#logoFile").get(0).files[0])},"Logo zmienione pomyślnie",!0)}else notify.localNotify("Walidacja","Dodaj poprawnie plik loga")}),$(document).off("change","#moduleFile"),$(document).on("change","#moduleFile",function(){$scope.addModule()}),$(document).off("change","#backFile"),$(document).on("change","#backFile",function(){if(0!==$("#backFile").get(0).files.length){var data=new FormData($("#addBackgroundForm")[0]);request.backend("changePageBackground",data,function(){var reader=new FileReader;reader.onload=function(e){$("#prevBack").attr("src",e.target.result)},reader.readAsDataURL($("#backFile").get(0).files[0])},"Tło strony logowania zmienione pomyślnie",!0)}else notify.localNotify("Walidacja","Dodaj poprawnie plik tła")}),$(document).off("change","#icoFile"),$(document).on("change","#icoFile",function(){if(0!==$("#icoFile").get(0).files.length){var data=new FormData($("#addIconForm")[0]);request.backend("changePageIcon",data,function(){var reader=new FileReader;reader.onload=function(e){$("#prevIconPage").attr("src",e.target.result)},reader.readAsDataURL($("#icoFile").get(0).files[0])},"Ikona strony zmieniona pomyślnie",!0)}else notify.localNotify("Walidacja","Dodaj poprawnie plik tła")}),$(document).off("change","#appName"),$(document).on("change","#appName",function(){$("#appName").val().length<3?notify.localNotify("Walidacja","Wpisz dłuższą nazwę aplikacji"):request.backend("changeAppMainSettings",{appName:$("#appName").val()},function(){getMainSettings()},"Pomyślnie zapisano")})}),app.controller("staffController",function($scope,auth,$rootScope,notify,request){$scope.lastId=0,$scope.staffMembers=[],$scope.personelMembers=[],$scope.koordsInSite=[],$scope.getStaffMembers=function(){$rootScope.showContent=!1,request.backend("getFullPersonel",{tmid:$rootScope.user.tmid},function(data){$scope.personelMembers=data,$("#prBar").attr("aria-valuenow",50),$("#prBar").css("width","50%"),$("#addStaffMembersSelect").html("");for(var i=0;i<data.length;i++)$("#addStaffMembersSelect").append("<option value='"+data[i].usid+"'>"+data[i].firstname+" "+data[i].lastname+" [ "+data[i].rlname+" ] </option>");$("select").material_select()}),request.backend("getKoords",{},function(data){$scope.$apply(function(){$scope.koordsInSite=data})}),request.backend("getTeamStaff",{tmid:$rootScope.user.tmid},function(data){$scope.$apply(function(){$scope.staffMembers=data,$scope.showContent=!0})})},$scope.addPerson=function(){var firstname=$("#addedFirstname").val(),lastname=$("#addedLastname").val(),email=$("#addedEmail").val();/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(email)?firstname.length<3||lastname.length<3?notify.localNotify("Bład","Imię lub nazwisko jest zbyt krótkie"):request.backend("addPerson",{tmid:$rootScope.user.tmid,fname:firstname,lname:lastname,mail:email,isPersonel:!0,isAdmin:"false"},function(){$("#addedFirstname").val(""),$("#addedLastname").val(""),$("#addedEmail").val(""),$scope.getStaffMembers()},"Osoba została dodana. Na jej adres email zostało wysłane hasło. Wiadomość może trafić do folderu spam"):notify.localNotify("Bład","Popraw wpisany adres email")},$scope.addStaff=function(){var addUserId=$("#addStaffMembersSelect").val(),addName=$("#typeStaff").val();request.backend("addStaff",{tmid:$rootScope.user.tmid,name:addName,usid:addUserId},function(data){$scope.getStaffMembers(),notify.addNew(new notify.Notification("Dodano nowy personel: "+addName,null,"#!/staff",!0))},"Personel dodany pomyślnie")},$scope.deleteStaff=function(staffId){$rootScope.showModalWindow("Nieodwracalne usunięcie personelu",function(){request.backend("deleteStaff",{stid:staffId},function(data){$scope.getStaffMembers()},"Personel usunięty pomyślnie")})}}),app.controller("masterMenagerController",function($scope,auth,$rootScope,notify,request){$scope.showContent=!1,$scope.masters=[],$scope.getAllMasters=function(){request.backend("getAllMaster",{},function(data){$scope.$apply(function(){$scope.masters=data,$scope.showContent=!0})})},$scope.deleteUser=function(usidN){$rootScope.showModalWindow("Usunięcie użytkownika",function(){request.backend("deleteUser",{usid:usidN},function(){$scope.$apply(function(){$scope.getAllMasters()})},"Osoba usunięta wraz z powiązaniami")})},$scope.addPerson=function(){var firstname=$("#addedFirstname").val(),lastname=$("#addedLastname").val(),email=$("#addedEmail").val();/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(email)?firstname.length<3||lastname.length<3?notify.localNotify("Bład","Imię lub nazwisko jest zbyt krótkie"):request.backend("addPerson",{fname:firstname,lname:lastname,mail:email,isAdmin:!0,tmid:-1,isPersonel:!1},function(){$("#addedFirstname").val(""),$("#addedLastname").val(""),$("#addedEmail").val(""),$scope.$apply(function(){$scope.getAllMasters()})},"Osoba została dodana. Na jej adres email zostało wysłane hasło."):notify.localNotify("Bład","Popraw wpisany adres email")}}),app.controller("sectionGetController",function($scope,auth,$rootScope,notify,request){function getSectionApplayer(){request.backend("getSectionApplayer",{tmid:$rootScope.user.tmid},function(data){$scope.$apply(function(){$scope.sectionApplayer=data})})}$scope.showContent=!1,$scope.isGetEnabled=!1,$scope.sectionData=[],$scope.sectionApplayer=[],$scope.availableSection=[],$scope.turnOnSectionGet=function(){var minY=parseInt($("#sectionYMin").val()),maxY=parseInt($("#sectionYMax").val()),description=$("#sectionDesc").val();minY>=maxY?notify.localNotify("Walidacja","Maksymalny wiek musi być większy od "+minY):!description||description.length<=10?notify.localNotify("Walidacja","Wpisz dłuższy opis sekcji ( min. 10 znaków )"):request.backend("turnOnSectionGet",{tmid:$rootScope.user.tmid,max:maxY,min:minY,desc:description},function(data){$scope.$apply(function(){$scope.isGetEnabled=!0,getSectionApplayer()})})},$scope.addPersonToTeamApplicant=function(tmid){request.backend("addPersonToTeamApplicant",{usid:$rootScope.user.id,tmid},function(data){},"Twoja aplikacja została dodana, oczekuj na powiadomienia związane z decyzją")},$scope.getAvailableSection=function(){request.backend("getAvailableSection",{usid:$rootScope.user.id},function(data){$scope.$apply(function(){$scope.availableSection=data,$scope.showContent=!0})})},$scope.turnOffSectionGet=function(){request.backend("turnOffSectionGet",{tmid:$rootScope.user.tmid},function(data){$scope.$apply(function(){$scope.isGetEnabled=!1});for(var usArray=[],index=0;index<$scope.sectionApplayer.length;index++)usArray.push($scope.sectionApplayer[index].usid);notify.addNew(new notify.Notification("Nabór do sekcji "+$rootScope.teamNameStr+" został zakończony. Nie zostałeś przyjęty.",usArray,"#!/sectionGetForPlayer"))})},$scope.getSectionData=function(){request.backend("getSectionData",{tmid:$rootScope.user.tmid},function(data){$scope.$apply(function(){$scope.sectionData=data,$scope.isGetEnabled=1==$scope.sectionData.isGetEnabled,$scope.isGetEnabled&&getSectionApplayer(),$scope.showContent=!0})})},$scope.deletePlayerApplay=function(aplId,usid){$rootScope.showModalWindow("Oddalenie prośby o dołączenie do sekcji",function(){request.backend("deletePlayerAplay",{tmid:$rootScope.user.tmid,aplId,usid},function(data){$scope.$apply(function(){$scope.sectionApplayer=data}),notify.addNew(new notify.Notification("Twoja prośba o dołączenie do sekcji: "+$rootScope.teamNameStr+" została odrzucona",[usid],"#!/sectionGetForPlayer"))},"Pomyślnie usunięto prośbę. Zostanie ona odpowiednio powiadomiona.")})},$scope.addPlayerToTeam=function(aplId,usid){request.backend("applayPlayerToTeam",{tmid:$rootScope.user.tmid,aplId,usid},function(data){$scope.$apply(function(){$scope.sectionApplayer=data}),notify.addNew(new notify.Notification("Prośba o dołączenie do sekcji: "+$rootScope.teamNameStr+" rozpatrzona pomyślnie. Zostałeś przypisany",[usid],"#!/sectionGetForPlayer"))},"Pomyślnie dodano osobę do teamu. Zostanie ona odpowiednio powiadomiona.")}}),app.controller("teamsMenagerController",function($scope,auth,$rootScope,notify,request){function getAllTeams(){request.backend("getAllTeams",{},function(data){$scope.$apply(function(){$scope.teams=data})})}$scope.showContent=!1,$scope.teams=[],$scope.teamMasters=[],$scope.masters=[],$scope.showPlayerNow=!1,$scope.showPreLoad=!1,$scope.personShow=!1,$scope.actualSelectedTeamId=-1,$scope.openCard=function(name){$("#"+name).toggle("blind",null,"fast"),$scope.personShow=!$scope.personShow},$scope.initTeams=function(){getAllTeams(),request.backend("getAllMaster",{},function(data){$scope.$apply(function(){$scope.showContent=!0,$scope.masters=data;for(var i=0;i<data.length;i++)$("#mastersSelect").append("<option value='"+data[i].usid+"'>"+data[i].firstname+" "+data[i].lastname+"</option>");$("select").material_select()})})},$scope.showThisTeam=function(id){$scope.showPreLoad=!0,$scope.showPlayerNow=!1,function(id,functionSuccess){$scope.actualSelectedTeamId=id,request.backend("getAllMastersFromTeam",{tmid:id},function(data){$scope.teamMasters=[],$scope.$apply(function(){$scope.teamMasters=data}),functionSuccess()})}(id,function(){$scope.$apply(function(){$scope.showPreLoad=!1,$scope.showPlayerNow=!0})})},$scope.deleteTeam=function(id){$rootScope.showModalWindow("Usunięcie drużyny",function(){request.backend("deleteTeam",{id},function(){getAllTeams(),$scope.$apply(function(){$scope.showPlayerNow=!1})},"Udało się usunąc drużynę wraz z zawartością")})},$scope.addTeam=function(){var name=$("#teamName").val();if(name.length<3)notify.localNotify("Walidacja","Wpisz dłuższą nazwę");else{var weight=Number.isInteger(parseInt($("#teamWeight").val()))?parseInt($("#teamWeight").val()):999;request.backend("addTeam",{name,weight},function(data){getAllTeams(),request.backend("getTeams",{},function(data){if(0==data.length)notify.localNotify("Uwaga","Twoje konto będzie ograniczone dopóki nie zostaniesz przypisany do drużyny");else{$("#teamSelect").html(""),$("#teamSelect").append("<option value='' disabled> Wybierz drużynę </option>");for(var i=0;i<data.length;i++)$("#teamSelect").append("<option value='"+data[i].tmid+"'"+(0==i?"selected":"")+">"+data[i].name+"</option>");null!=data[0]&&null!=data[0].tmid&&($rootScope.user.tmid=data[0].tmid),setInterval(function(){notify.getNew()},2e3)}$("select").material_select()})},"Dodano nową drużynę, możesz przydzielić teraz trenerów")}},$scope.deleteMaster=function(id){$rootScope.showModalWindow("Usunięcie trenera z drużyny",function(){request.backend("deleteMasterFromTeam",{mid:id,tmid:$scope.actualSelectedTeamId},function(data){$scope.showThisTeam($scope.actualSelectedTeamId);for(var actualTeamName="",index=0;index<$scope.teams.length;index++)$scope.teams[index].id==$scope.actualSelectedTeamId&&(actualTeamName=$scope.teams[index].name);notify.addNew(new notify.Notification("Zostałeś usunięty z drużyny: "+actualTeamName,[id],""))},"Udało się usunąc trenera z danej drużyny")})},$scope.addTeamMaster=function(){var mid=$("#mastersSelect").val();!mid||mid<0?notify.localNotify("Bład","Wybierz trenera do dodania"):request.backend("addMasterToTeam",{mid,tmid:$scope.actualSelectedTeamId},function(data){$scope.showThisTeam($scope.actualSelectedTeamId);for(var actualTeamName="",index=0;index<$scope.teams.length;index++)$scope.teams[index].id==$scope.actualSelectedTeamId&&(actualTeamName=$scope.teams[index].name);notify.addNew(new notify.Notification("Przypisano Cię do nowej drużyny: "+actualTeamName,[mid],""))},"Dodano trenera do drużyny")},$(document).off("change",".changeWeight"),$(document).on("change",".changeWeight",function(){var idTeam=$(this).attr("id").split("-")[1],weight=parseInt($(this).val());Number.isInteger(weight)&&weight<=999&&weight>=0?request.backend("changeWeightTeam",{tmid:idTeam,weight},function(data){getAllTeams()},"Zmieniono pozycję pomyślnie"):notify.localNotify("Walidacja","Wpisz liczbę całkowitą z przedzialu 0 - 999")})}),app.controller("calendarController",function($scope,auth,$rootScope,request,notify){$scope.actualEdit="",$scope.allEvents="",$scope.selectedColor="#0099ff",$scope.initAllEv=function(){$rootScope.showContent=!1,$scope.getAllEvents()},$scope.getAllEvents=function(){request.backend("getNews",{tmid:$rootScope.user.tmid},function(data){$scope.$apply(function(){$scope.allEvents=data,$scope.showContent=!0,setTimeout(function(){!function(){var date=new Date;date.getDate(),date.getMonth(),date.getFullYear();$("#calendar").html(""),$("#calendar").fullCalendar({header:{left:"prev,next today",center:"title",right:"month,basicWeek,basicDay"},editable:"TRENER"==$rootScope.user.role||"KOORD"==$rootScope.user.role,droppable:!0,displayEventTime:!0,drop:function(date,allDay){var originalEventObject=$(this).data("eventObject"),copiedEventObject=$.extend({},originalEventObject);copiedEventObject.start=date,copiedEventObject.allDay=allDay,$("#calendar").fullCalendar("renderEvent",copiedEventObject,!0),$(this).remove()},eventClick:function(calEvent,jsEvent,view){$scope.$apply(function(){$scope.actualEdit=calEvent}),$(".editEvent").show(),$(this).css("border-color","red")},eventDrop:function(event){request.backend("editNews",{id:event.id,start:moment(event.start).format("YYYY-MM-DD HH:mm:ss"),end:moment(event.end).format("YYYY-MM-DD HH:mm:ss")},function(data){$scope.getAllEvents()},"Wydarzenie edytowane pomyślnie")},eventResize:function(event,delta,revertFunc){request.backend("editNews",{id:event.id,start:moment(event.start).format("YYYY-MM-DD HH:mm:ss"),end:moment(event.end).format("YYYY-MM-DD HH:mm:ss")},function(data){$scope.getAllEvents()},"Wydarzenie edytowane pomyślnie")},events:$scope.allEvents,timeFormat:"H(:mm)"})}()},500)})})},$scope.addEvent=function(valid){var title1=$("#addTitleNews").val(),start1=$("#addStartNews").val(),end1=$("#addEndNews").val();title1.length>1&&start1.length>1&&end1.length>1&&request.backend("addNews",{tmid:$rootScope.user.tmid,title:title1,start:start1,end:end1,color:$scope.selectedColor},function(data){$scope.getAllEvents(),$(".editEvent").hide(),$("#addTitleNews").val(""),$("#addStartNews").val(""),$("#addEndNews").val(""),notify.addNew(new notify.Notification("Dodano wydarzenie: '"+title1+"'",null,"#!/calendar",!0))},"Dodano wydarzenie pomyślnie")},$scope.editEvent=function(){""!=$scope.actualEdit&&$("#editTitle").val().length>2&&request.backend("editNews",{id:$scope.actualEdit.id,title:$("#editTitle").val()},function(data){$scope.getAllEvents()},"Wydarzenie edytowane pomyślnie"),$(".editEvent").hide(),$scope.actualEdit=""},$scope.deleteEvent=function(){""!=$scope.actualEdit&&request.backend("deleteNews",{tmid:$scope.actualEdit.id_team,id:$scope.actualEdit.id},function(data){$scope.getAllEvents()},"Wydarzenie usunięte pomyślnie"),$(".editEvent").hide(),$scope.actualEdit=""},$scope.selectColor=function(color){$(".borderSelectedColor").css("border-color",color),$scope.selectedColor=color}}),app.controller("teamFreqController",function($scope,auth,$rootScope,request,notify){$scope.showContent=!1,$scope.isSelectedCorrectDate=!0,$scope.inDaysFreq=[],$scope.loadedData=!1;var currentTime=new Date;function loadFrequencyData(year,month,day){$scope.loadedData=!1,$scope.inDaysFreq=[],request.backend("getFrequency",{tmid:$rootScope.user.tmid,year,month,day},function(data){$scope.$apply(function(){$scope.inDaysFreq=data,$scope.loadedData=!0})})}function resetDayInMonthMax(){var dayCount=new Date($("#yearDate").val(),$("#monthDate").val(),0).getDate();$("#dayDate").attr("max",dayCount)}$scope.initFreq=function(){$scope.showContent=!0,$("#yearDate").val(currentTime.getFullYear()),$("#yearDate").attr("max",currentTime.getFullYear()),$("#monthDate").val(currentTime.getMonth()+1),$("#dayDate").val(currentTime.getDate()),loadFrequencyData($("#yearDate").val(),$("#monthDate").val(),$("#dayDate").val()),resetDayInMonthMax(),Materialize.updateTextFields()},$(document).off("change","#yearDate"),$(document).on("change","#yearDate",function(){var count=parseInt($("#yearDate").val());if(count<2017||count>currentTime.getFullYear())return notify.localNotify("Walidacja","Rok musi być w przedzial 2017-aktualny"),void($scope.isSelectedCorrectDate=!1);$scope.isSelectedCorrectDate=!0,resetDayInMonthMax(),$("#dayDate").val("1"),loadFrequencyData($("#yearDate").val(),$("#monthDate").val(),$("#dayDate").val())}),$(document).off("change","#monthDate"),$(document).on("change","#monthDate",function(){var count=parseInt($("#monthDate").val());if(count<1||count>12)return notify.localNotify("Walidacja","Wpisany nieistniejący miesiąc"),void($scope.isSelectedCorrectDate=!1);$scope.isSelectedCorrectDate=!0,resetDayInMonthMax(),$("#dayDate").val("1"),loadFrequencyData($("#yearDate").val(),$("#monthDate").val(),$("#dayDate").val())}),$(document).off("change","#dayDate"),$(document).on("change","#dayDate",function(){var count=parseInt($("#dayDate").val());if(count<1||count>$("#dayDate").attr("max"))return notify.localNotify("Walidacja","Podany dzień nie istnieje w danym miesiącu"),void($scope.isSelectedCorrectDate=!1);$scope.isSelectedCorrectDate=!0,loadFrequencyData($("#yearDate").val(),$("#monthDate").val(),$("#dayDate").val())}),$(document).off("change",".onTrainingChecbox"),$(document).on("change",".onTrainingChecbox",function(){var usid=$(this).attr("id").split("-")[1],year=$("#yearDate").val(),month=$("#monthDate").val(),day=$("#dayDate").val(),isChecked=$(this).is(":checked");"ZAWODNIK"!=$rootScope.user.role&&(isChecked?(request.backend("setOnTraining",{tmid:$rootScope.user.tmid,year,month,day,usid}),$(this).prop("checked",!0)):(request.backend("setOffTraining",{tmid:$rootScope.user.tmid,year,month,day,usid}),$(this).prop("checked",!1)))})}),app.controller("compositionController",function($scope,auth,$rootScope,request,notify,statistic){$scope.users=[],$scope.notOnField=[],$scope.showContent=!1,$scope.selectedOnFieldId=-1;var mainChart=null;function saveComposition(typeOfChange,tmid,value,usid){request.backend("changeCollection",{tmid,val:value,type:typeOfChange},function(data){notify.addNew(new notify.Notification("Twój numer na boisku został zmieniony na: "+value,[usid],"#!/teamComposition"))})}function savePositionOnField(usid,pos_x,pos_y,sendAlert=!0){request.backend("savePositionOnField",{usid,pos_x:parseInt(pos_x),pos_y:parseInt(pos_y)},function(data){sendAlert&&notify.addNew(new notify.Notification("Twoja pozycja na boisku została zmieniona",[usid],"#!/teamComposition"))})}$scope.getTeam=function(){request.backend("getUserFromTeam",{tmid:$rootScope.user.tmid},function(data){$scope.$apply(function(){for(var index=0;index<data.length;index++)data[index].isSelected=!1,data[index].pos_x<0||data[index].pos_y<0?$scope.notOnField.push(data[index]):$scope.users.push(data[index])}),function(){$scope.lastCanvasInterval&&window.clearInterval($scope.lastCanvasInterval);$scope.lastCanvasInterval=setInterval(update,updateTime),$scope.showContent=!0}(),setTimeout(function(){teamFormChartInit()},1e3)})},$(document).off("change",".changeNumber"),$(document).on("change",".changeNumber",function(){for(var teamMembersId=$(this).attr("id").split("-")[1],changedNumber=($(this).attr("id").split("-")[2],$(this).val()),i=0;i<$scope.notOnField.length;i++)if($scope.notOnField[i].tmmid==teamMembersId){var usid=$scope.notOnField[i].usid;$scope.$apply(function(){$scope.notOnField[i].nr_on_tshirt=changedNumber,saveComposition("nr_on_tshirt",teamMembersId,changedNumber,usid)});break}}),$(document).off("dragstart",".dragedUser"),$(document).on("dragstart",".dragedUser",function(evt){if("ZAWODNIK"!=$rootScope.user.role){var usid=$(this).attr("id").split("-")[1];$rootScope.movedData=usid}}),$(document).off("dragover","#canvas"),$(document).on("dragover","#canvas",function(evt){evt.preventDefault()}),$(document).off("drop","#canvas"),$(document).on("drop","#canvas",function(evt){if(evt.preventDefault(),"ZAWODNIK"!=$rootScope.user.role&&$rootScope.movedData)for(var mousePosOnCanvas=getMousePos(evt),actualWidth=$("#canvas_container").width(),percentPosition={x:mousePosOnCanvas.x/actualWidth*100,y:mousePosOnCanvas.y/actualWidth*100},usid=$rootScope.movedData,i=0;i<$scope.notOnField.length;i++)if($scope.notOnField[i].usid==usid){$scope.notOnField[i].pos_x=percentPosition.x,$scope.notOnField[i].pos_y=percentPosition.y,savePositionOnField($scope.notOnField[i].tmmid,percentPosition.x,percentPosition.y),$scope.$apply(function(){$scope.users.push($scope.notOnField[i]),$scope.notOnField.splice(i,1)}),teamFormChartInit();break}});var actualKey=-1;function resetSelect(){for(var i=$scope.users.length-1;i>=0;i--)$scope.users[i].isSelected=!1;actualKey=-1}$(document).off("mousedown touchstart","#canvas"),$(document).on("mousedown touchstart","#canvas",function(evt){if(evt.preventDefault(),"ZAWODNIK"!=$rootScope.user.role)for(var Px,Py,Qx,Qy,actualWidth=$("#canvas_container").width(),actualCircleSize=parseInt(.06*actualWidth),mousePos=getMousePos(evt),i=$scope.users.length-1;i>=0;i--)if(Px=$scope.users[i].pos_x/100*actualWidth,Py=$scope.users[i].pos_y/100*actualWidth,Qx=mousePos.x,Qy=mousePos.y,Math.sqrt(Math.pow(Px-Qx,2)+Math.pow(Py-Qy,2))<=actualCircleSize){$scope.users[i].isSelected=!0,updateTime=50,actualKey=i;break}}),$(document).off("mouseup touchend","#canvas"),$(document).on("mouseup touchend","#canvas",function(evt){if(evt.preventDefault(),"ZAWODNIK"!=$rootScope.user.role){if(-1!=actualKey){var mousePosOnCanvas=getMousePos(evt),actualWidth=$("#canvas_container").width(),percentPosition={x:mousePosOnCanvas.x/actualWidth*100,y:mousePosOnCanvas.y/actualWidth*100};$scope.users[actualKey].pos_x=percentPosition.x,$scope.users[actualKey].pos_y=percentPosition.y,savePositionOnField($scope.users[actualKey].tmmid,$scope.users[actualKey].pos_x,$scope.users[actualKey].pos_y,!1)}resetSelect()}else resetSelect()}),$(document).off("mouseup touchend","#notOnFieldCard"),$(document).on("mouseup touchend","#notOnFieldCard",function(evt){evt.preventDefault(),"ZAWODNIK"!=$rootScope.user.role?(-1!=actualKey&&($scope.users[actualKey].pos_x=-1,$scope.users[actualKey].pos_y=-1,$scope.users[actualKey].isSelected=!1,savePositionOnField($scope.users[actualKey].tmmid,$scope.users[actualKey].pos_x,$scope.users[actualKey].pos_y,!1),$scope.notOnField.push($scope.users[actualKey]),$scope.users.splice(actualKey,1),teamFormChartInit()),resetSelect()):resetSelect()}),$(document).off("mouseup touchend","window"),$(document).on("mouseup touchend","window",function(evt){evt.preventDefault(),resetSelect()}),$(document).off("mousemove touchmove","window"),$(document).on("mousemove touchmove","window",function(event){event.preventDefault()});var updateTime=50,actualPosMouse={x:0,y:0},canvas=document.getElementById("canvas"),ctx=document.getElementById("canvas").getContext("2d",{alpha:!0}),backgorund=new Image;backgorund.src="./files/img/canvas/background.png";var tshirt=new Image;function update(){var actualWidth=$("#canvas_container").width();canvas.width=actualWidth,canvas.height=.78*actualWidth;var actualCircleSize=parseInt(.04*actualWidth),actualFontSize=parseInt(.025*actualWidth);ctx.drawImage(backgorund,0,0,backgorund.width,backgorund.height,10,10,actualWidth-20,.78*actualWidth-10);for(var i=0;i<$scope.users.length;i++){var pos;pos=$scope.users[i].isSelected?actualPosMouse:{x:$scope.users[i].pos_x/100*actualWidth,y:$scope.users[i].pos_y/100*actualWidth};var tshirtWidth=actualWidth/11,tshirtHeight=1.2*tshirtWidth;ctx.drawImage(tshirt,0,0,tshirt.width,tshirt.height,pos.x-tshirtWidth/2,pos.y-.2*tshirtHeight,tshirtWidth,tshirtHeight),ctx.fillStyle="#fff",ctx.textAlign="center",ctx.font=actualFontSize+"px Arial",ctx.fillText($scope.users[i].nr_on_tshirt,pos.x,parseInt(pos.y)+1.5*actualFontSize),ctx.fillStyle="#fff",ctx.font=actualFontSize+"px Arial",ctx.fillText($scope.users[i].firstname[0]+". "+$scope.users[i].lastname,pos.x,parseInt(pos.y)+actualCircleSize+3*actualFontSize)}}function checkHelpfulnessInTeam(teamForm){if($scope.notOnField&&$scope.notOnField.length>0){for(var userNotOnF=[],userOnF=[],i=0;i<$scope.users.length;i++)userOnF.push($scope.users[i].usid);for(i=0;i<$scope.notOnField.length;i++)userNotOnF.push($scope.notOnField[i].usid);request.backend("getUsersHelpfulness",{tmid:$rootScope.user.tmid,teamForm,matchTeam:userOnF,otherTeam:userNotOnF},function(data){$scope.$apply(function(){for(var i=0;i<$scope.notOnField.length;i++)$scope.notOnField[i].help=data[i].help}),$(".helpTd").each(function(){var actualHelp=$(this).html();if($(this).css("color","#ec1800"),"osiągnięto limit zawodników"!=actualHelp){var word=actualHelp.split(" ")[0];$(this).css("font-weight","800"),$(this).css("font-size","12px"),"+"==word&&$(this).css("color","#34cd33")}})})}}function teamFormChartInit(){for(var matchPersonsId=[],i=0;i<$scope.users.length;i++)matchPersonsId.push($scope.users[i].usid);var fullTeamScore=statistic.getTeamForm(matchPersonsId,!0);mainChart&&null!=mainChart?(mainChart.data.datasets=[{data:[fullTeamScore,100-fullTeamScore],backgroundColor:["#ec1800","#4e4e4e"]}],mainChart.update()):mainChart=new Chart($("#teamStat"),{type:"doughnut",data:{datasets:[{data:[fullTeamScore,100-fullTeamScore],backgroundColor:["#ec1800","#4e4e4e"]}],labels:["Poziom zawodników na boisku","Braki do maksimum"]}}),checkHelpfulnessInTeam(fullTeamScore)}function getMousePos(evt){var rect=canvas.getBoundingClientRect();return{x:evt.clientX-rect.left,y:evt.clientY-rect.top}}tshirt.src="./files/img/canvas/tshirt.png",$(document).off("mousemove","#canvas"),$(document).on("mousemove","#canvas",function(evt){actualPosMouse=getMousePos(evt)})}),app.controller("mainDashboardController",function($scope,auth,$rootScope,request,notify){$scope.nowEvents=[],$scope.nextEvents=[],$scope.lastPost=[],$scope.showContent=!0,$scope.isLoadedPost=!1,$scope.todayInt=(new Date).getDay(),$scope.licenseDate=[],$scope.getAllEvents=function(){$rootScope.user.tmid&&""!=$rootScope.user.tmid&&($scope.getNextEvents(),$scope.getNowStartEvents(),$scope.getLastPost())},$scope.getNextEvents=function(){$rootScope.user.tmid&&""!=$rootScope.user.tmid&&request.backend("getNextEvents",{tmid:$rootScope.user.tmid},function(data){$scope.$apply(function(){$scope.nextEvents=data})})},$scope.getLicenseDate=function(){$rootScope.user.tmid&&""!=$rootScope.user.tmid&&request.backend("getCountOfLicenseData",{tmid:$rootScope.user.tmid},function(data){$scope.$apply(function(){$scope.licenseDate=data})})},$scope.getNowStartEvents=function(){$rootScope.user.tmid&&""!=$rootScope.user.tmid&&request.backend("getNowEvents",{tmid:$rootScope.user.tmid},function(data){$scope.$apply(function(){$scope.nowEvents=data})})},$scope.getLastPost=function(){$rootScope.user.tmid&&""!=$rootScope.user.tmid&&request.backend("getLastPost",{tmid:$rootScope.user.tmid},function(data){$scope.$apply(function(){$scope.lastPost=data,data.length>0&&($scope.isLoadedPost=!0)})})};var monthName,day=(new Date).getDate();switch((new Date).getMonth()+1){case 1:monthName="Stycznia";break;case 2:monthName="Lutego";break;case 3:monthName="Marca";break;case 4:monthName="Kwietnia";break;case 5:monthName="Maja";break;case 6:monthName="Czerwca";break;case 7:monthName="Lipca";break;case 8:monthName="Sierpnia";break;case 9:monthName="Wrzesnia";break;case 10:monthName="Października";break;case 11:monthName="Listopada";break;case 12:monthName="Grudnia"}$(".today-date").html(day+" "+monthName)}),app.controller("paymentController",function($scope,auth,$rootScope,notify,request){function getSettings(){request.backend("getPaymentOptions",{},function(data){$scope.$apply(function(){$scope.merchantPosId=data.merchantPosId,$scope.merchantKey=data.merchantKey,$scope.isPayuEnabled="false"!=data.availablePaymentPayu,$scope.isPayuEnabled?$("#turnOffOnPayu").prop("checked",!0):$("#turnOffOnPayu").prop("checked",!1),$scope.showContent=!0,setTimeout(function(){Materialize.updateTextFields(),$("select").material_select(),$("ul.tabs").tabs(),$(".collapsible").collapsible()},500)})})}function getUserFromTeam(){request.backend("getUserFromTeam",{tmid:$rootScope.user.tmid},function(data){$scope.$apply(function(){$scope.allUsers=data,setTimeout(function(){$scope.showContent=!0,Materialize.updateTextFields(),$("select").material_select(),$("ul.tabs").tabs(),$(".collapsible").collapsible()},200)})})}$scope.showContent=!1,$scope.loadHistory=!1,$scope.selectedUserHistory=[],$scope.selectedPayment=[],$scope.selectedUser=null,$scope.showPay=!1,$scope.ip=0,$scope.signature=0,$scope.isPayuEnabled=!1,$scope.merchantPosId="",$scope.merchantKey="",$scope.paymentSummary=[],$scope.allCyclPayments=[],$scope.paymentDate="",$scope.payDay="",$scope.payWeek="",$scope.payMonth="",$scope.userIsSelected=!1,$scope.initPaymentSettings=function(){getSettings()},$scope.initPayment=function(){getUserFromTeam(),getSettings(),$(".datetimepicker").datetimepicker({format:"Y:m:d",lang:"pl",timepicker:!1})},$scope.initPaymentHistory=function(){getUserFromTeam(),$scope.getUsersHistory([0])},$scope.sendReminder=function(payId){request.backend("sendPaymentReminder",{payId},function(data){},"Ponaglenie wysłane")},$scope.initPaymentCyclic=function(){request.backend("getAllCyclePayment",{tmid:$rootScope.user.tmid},function(data){$scope.$apply(function(){$scope.allCyclPayments=data,$scope.showContent=!0})})},$scope.deleteCyclePay=function(id){$rootScope.showModalWindow("Usunięcie płatności",function(){request.backend("deleteCyclePayment",{id,tmid:$rootScope.user.tmid},function(data){$scope.initPaymentCyclic()},"Płatność została usunięta")})},$scope.addCyclePay=function(){var title=$("#cyclikPayTitle").val(),startDate=$("#dataInput").val(),amount=parseFloat($("#payValue").val().replace(",","."));if(!startDate||startDate.length<=0)notify.localNotify("Walidacja","Wproawdź ilość dni wyprzedzenia");else if(title.length<=3)notify.localNotify("Walidacja","Wpisz dłuższy tytuł płatności");else if(0==amount.length||0==amount||amount<=0)notify.localNotify("Walidacja","Wprowadź poprawnie kwotę płatności");else{if($scope.payDay>=0&&$scope.payDay<=23)var interval=$scope.payDay,intervalName="dzień";else if($scope.payWeek>=0&&$scope.payWeek<=6)interval=$scope.payWeek,intervalName="tydzień";else{if(!($scope.payMonth>=1&&$scope.payMonth<=31))return void notify.localNotify("Walidacja","Podaj poprawny odstęp czasowy");interval=$scope.payMonth,intervalName="miesiąc"}request.backend("addCyclePayment",{tmid:$rootScope.user.tmid,title,howLongBefore:startDate,interval,intervalName,amount},function(data){$scope.initPaymentCyclic()},"Płatność została dodana")}},$scope.getPaymentSummary=function(){""!=$rootScope.user.tmid&&"ZAWODNIK"!=$rootScope.user.role&&request.backend("getPaymentSummary",{tmid:$rootScope.user.tmid},function(data){$scope.$apply(function(){$scope.paymentSummary=data})})},$scope.initPaymentClient=function(){request.backend("getClientIp",{tmid:$rootScope.user.tmid,usids:[$rootScope.user.id]},function(data){$scope.$apply(function(){$scope.ip=data})}),$scope.host=window.location.protocol+"//"+window.location.hostname,request.backend("getUserPaymentHistory",{tmid:$rootScope.user.tmid,usids:[$rootScope.user.id]},function(data){$scope.$apply(function(){$scope.selectedUserHistory=data[0]?data[0]:[],$scope.showContent=!0})}),getSettings()},$(document).off("change","#turnOffOnPayu"),$(document).on("change","#turnOffOnPayu",function(){request.backend("turnOffOnPayuPay",{payStatus:$("#turnOffOnPayu").is(":checked")},function(data){$scope.$apply(function(){$scope.isPayuEnabled=$("#turnOffOnPayu").is(":checked")})},"Płatności Payu ustawione pomyślnie")}),$scope.showPayment=function(index){$scope.selectedPayment=$scope.selectedUserHistory.data[index],$scope.selectedPayment&&($scope.showPay=!0,$scope.getSignatureVerify())},$scope.payWithPayu=function(){request.backend("payWithPayu",{pmid:$scope.selectedPayment.id},function(data){request.backend("getUserPaymentHistory",{tmid:$rootScope.user.tmid,usids:[$rootScope.user.id]},function(data){$scope.$apply(function(){$scope.selectedUserHistory=data[0]?data[0]:[],$scope.showContent=!0})})})},$scope.getSignatureVerify=function(){var sigData=new Object;sigData.customerIp=$scope.ip,sigData.merchantPosId=$scope.merchantPosId,sigData.extOrderId=$scope.selectedPayment.id,sigData.description=$scope.selectedPayment.name,sigData.totalAmount=100*$scope.selectedPayment.amount,sigData.currencyCode="PLN",sigData["products.name"]=$scope.selectedPayment.name,sigData["products.unitPrice"]=100*$scope.selectedPayment.amount,sigData["products.quantity"]="1",sigData["products.virtual"]="true",sigData["buyer.email"]=$rootScope.user.email,sigData["buyer.firstName"]=$rootScope.user.firstname,sigData["buyer.lastName"]=$rootScope.user.lastname,sigData["buyer.language"]="pl",sigData.notifyUrl=$scope.host+"/backend/paymentNotification",sigData.continueUrl=$scope.host,request.backend("getPaySignature",{sigData,posId:$scope.merchantPosId,merchantKey:$scope.merchantKey},function(data){$scope.$apply(function(){$scope.signature=data})})},$scope.sendPayment=function(){var paymentName=$("#payName").val();if(paymentName.length<3)notify.localNotify("Walidacja","Zbyt krótki tytuł płatności");else{var paymentAmount=parseFloat($("#payAmount").val().replace(",",".")).toFixed(2);if(!$.isNumeric(paymentAmount)||paymentAmount<=0)notify.localNotify("Walidacja","Błędna kwota");else if($(".userSelectInput:checked").length<=0)notify.localNotify("Walidacja","Zaznacz przynajmniej jedną osobę");else if(!$scope.paymentDate||$scope.paymentDate.length<5)notify.localNotify("Walidacja","Wprowadź datę płatnośći");else{var selectedUserId=[];$(".userSelectInput:checked").each(function(){selectedUserId.push($(this).attr("id").split("-")[1])}),request.backend("addPaymentToUser",{date_to_pay:$scope.paymentDate,tmid:$rootScope.user.tmid,userIds:selectedUserId,amount:paymentAmount,name:paymentName},function(data){notify.addNew(new notify.Notification("Nowe płatność. Tytuł: "+paymentName+" Kwota: "+paymentAmount+" zł",selectedUserId,"#!/clientPayment"))},"Pomyślnie dodano płatnośc do kont użytkowników oraz wysłano powiadomienie")}}},$scope.getUsersHistory=function(usid){request.backend("getUserPaymentHistory",{tmid:$rootScope.user.tmid,usids:usid},function(data){$scope.$apply(function(){$scope.selectedUserHistory=data.data?data.data:[];new Chart($("#userPaymentStat"),{type:"doughnut",data:{datasets:[{data:[data.payed,data.notPayed,data.delayed],backgroundColor:["#89c33e","#4e4e4e","#ec5536"]}],labels:["Rozliczone","Nierozliczone","Opóźnione"]}});setTimeout(function(){$(".paymentDateToPay").each(function(){let toPayDate=$(this).text();$scope.checkIsBefore(toPayDate)&&$(this).css("color","#d01d1d")}),$(".paymentStatus").each(function(){"Zakończono"===$(this).text()&&$(this).css("color","#82ce2a")}),$(".tooltipped").tooltip({delay:50})},50)})})},$scope.checkIsBefore=function(date){return moment(date).isBefore(moment())},$scope.deletePayment=function(id){$rootScope.showModalWindow("Usunięcie płatności",function(){request.backend("deletePayment",{pmid:id},function(data){$scope.getUsersHistory($("#selectUserToGetHistory").val())},"Pomyślnie usunięto płatność")})},$scope.endPayment=function(id){request.backend("endPayment",{pmid:id},function(data){$scope.getUsersHistory($("#selectUserToGetHistory").val())},"Zakończono płatność")},$(document).off("change","#selectUserToGetHistory"),$(document).on("change","#selectUserToGetHistory",function(){let value=parseInt($("#selectUserToGetHistory").val());$scope.getUsersHistory(value<0?[0]:value),$scope.$apply(function(){$scope.userIsSelected=value>=0})}),$(document).off("change",".payOption"),$(document).on("change",".payOption",function(){request.backend("editOptions",{posId:$("#posId").val(),merKey:$("#merKey").val()},function(data){getSettings()},"Pomyslnie zmieniono dane payu")})}),app.controller("mySkillTreeController",function($scope,auth,$rootScope,notify,request){$scope.showContent=!1,$scope.mySkills=[];var resizeTimeout=null;function createElementRoot(data){var rootElement={text:{name:data.name},HTMLclass:"skillRootElement",children:[],connectors:{style:{stroke:data.color}}};return data.skills&&function createSkillElements(pushElement,skills,parentColor){for(let i=0;i<skills.length;i++){var skill={innerHTML:getIconHtml(skills[i]),HTMLclass:"skillParent",children:[],connectors:{style:{stroke:skills[i].isComplete?parentColor:"#b3b3b3"}}};skills[i].skills&&createSkillElements(skill.children,skills[i].skills,parentColor),pushElement.push(skill)}}(rootElement.children,data.skills,data.color),rootElement}function loadSkillToModal(skill){var mo=$("#skillModal");!function(){var mo=$("#skillModal");mo.find(".popMainSkill").first().html("\n            <div class='popMainSkill'>\n                <small class='popSkillMainStatus'></small>\n                <h4 class='popSkillMainCat'></h4>\n                <h6 class='popSkillMainName'></h6>\n                <p class='popSkillMainDesc'></p>\n            </div>\n        "),mo.find(".popReqSkill").first().html("\n            <h4 class='popReq'>Wymagania:</h4>\n            <ul class='popReqList'></ul>\n        ")}(),mo.modal("open");var level=parseInt(skill.level)>0?" - poziom: "+skill.level:"";mo.find(".popMainSkill").first().prepend(getIconHtml(skill)),mo.find(".popMainSkill .popSkillMainStatus").first().html(getStatusHtml(skill)),mo.find(".popMainSkill .popSkillMainCat").first().text(skill.category.name),mo.find(".popMainSkill .popSkillMainName").first().text(skill.name+level),mo.find(".popMainSkill .popSkillMainDesc").first().text(skill.description),0==skill.reqs.length&&mo.find(".popReqList").first().append("<li class='noReg'>Brak wymagań</li>");for(let i=0;i<skill.reqs.length;i++){level=parseInt(skill.reqs[i].level)>0?" - poziom: "+skill.reqs[i].level:"";mo.find(".popReqList").first().append("\n            <li class='popReqListElement' data-skill-id='"+skill.reqs[i].id+"'>\n                <div class='popReqListElementLeft'>\n                "+getIconHtml(skill.reqs[i])+"\n                </div>\n                <div class='popReqListElementRight'>\n                    <h4 class='popSkillMainCat'>"+skill.reqs[i].category.name+"</h4>\n                    <h6 class='popSkillMainName'>"+skill.reqs[i].name+level+"</h6>\n                    <small class='popSkillMainStatus'>"+getStatusHtml(skill.reqs[i])+"</small>\n                </div>\n            </li>\n            ")}replaceImgBySvg()}function getIconHtml(skill){var level=parseInt(skill.level),parentColor=skill.category.color,classIn=skill.isComplete?"completedSkill":skill.isEnabled?"enabledSkill":"notEnabledSkill",fillColor=skill.isComplete?"white":skill.isEnabled?"black":"#adadad",borderColor=skill.isComplete?parentColor:skill.isEnabled?parentColor:"#adadad",background=skill.isComplete?parentColor:skill.isEnabled?"white":"#e7e7e7",spanWithLevel="<span class='levelSpan' style='background-color:"+(skill.isEnabled?parentColor:"#adadad")+"'>"+level+"</span>",classType=skill.isComplete?"completePathSvg":skill.isEnabled?"enabledPathSvg":"notEnabledPathSvg";return"<div data-skill-id='"+skill.id+"' class='skillIn tooltipped "+classIn+"' style='background-color:"+background+";border-color:"+borderColor+"' data-position='bottom data-delay='20' data-tooltip='"+skill.name+"'>\n            <img class='svg "+classType+"' style='fill:"+fillColor+" !important; stroke:"+fillColor+" !important' src='"+skill.icon_path+"' alt='"+skill.name+"'/>\n            "+(level>0?spanWithLevel:"")+"</div>"}function getStatusHtml(skill){return skill.isComplete?'<span style="color:#8AC163" >Zaliczone</span>':skill.isEnabled?'<span style="color:#D5B75D" >Do zaliczenia</span>':'<span style="color:#D1D1D1" >Niedostępne</span>'}function getSkillById($id,$load=!0){for(let i=0;i<$scope.mySkills.all.length;i++)if($scope.mySkills.all[i].id==$id){var element=$.extend(!0,{},$scope.mySkills.all[i]);if($load){var req=loadSkillFromReq($scope.mySkills.all[i]);element.reqs=req}return element}return null}function loadSkillFromReq(skill){var allReq=[];if(skill.req)for(let i=0;i<skill.req.length;i++){var all=getSkillById(skill.req[i],!1);allReq.push(all)}return allReq}function replaceImgBySvg(){$("img.svg").each(function(){var $img=$(this),imgID=$img.attr("id"),imgClass=$img.attr("class"),imgURL=$img.attr("src"),imgStyle=$img.attr("style");$.get(imgURL,function(data){var $svg=$(data).find("svg");void 0!==imgID&&($svg=$svg.attr("id",imgID)),void 0!==imgClass&&($svg=$svg.attr("class",imgClass+" replaced-svg")),void 0!==imgStyle&&($svg=$svg.attr("style",imgStyle)),!($svg=$svg.removeAttr("xmlns:a")).attr("viewBox")&&$svg.attr("height")&&$svg.attr("width")&&$svg.attr("viewBox","0 0 "+$svg.attr("height")+" "+$svg.attr("width")),$img.replaceWith($svg)},"xml")})}$rootScope.treeConfig={chart:{container:"#skillTree",levelSeparation:45,rootOrientation:"WEST",nodeAlign:"CENTER",connectors:{type:"curve",style:{"stroke-width":3,stroke:"#adadad"}}},nodeStructure:{HTMLclass:"skillTreeRootElement",children:[],connectors:{type:"step",style:{stroke:"#ffffff","stroke-opacity":0}}}},$(document).off("click",".sidebar-toggle-box"),$(document).on("click",".sidebar-toggle-box",function(){$("#skillTree").html(""),new Treant($rootScope.treeConfig,function(){replaceImgBySvg(),$(".tooltipped").tooltip({delay:20})}),$(".modal").modal()}),$scope.loadSkill=function(){request.backend("getMySkillsInTree",{},function(data){$scope.$apply(function(){$scope.mySkills=data;for(let i=0;i<data.struct.length;i++)$rootScope.treeConfig.nodeStructure.children.push(createElementRoot(data.struct[i]));$scope.showContent=!0,setTimeout(()=>{new Treant($rootScope.treeConfig,function(){replaceImgBySvg(),$(".tooltipped").tooltip({delay:20})}),$(".modal").modal()},500)})})},$(window).resize(function(){$("#skillTree").html(""),clearTimeout(resizeTimeout),$scope.$apply(function(){$scope.showContent=!1}),resizeTimeout=setTimeout(()=>{$scope.$apply(function(){$scope.showContent=!0}),setTimeout(()=>{new Treant($rootScope.treeConfig,function(){replaceImgBySvg(),$(".tooltipped").tooltip({delay:20})}),$(".modal").modal()},500)},1e3)}),$(document).off("click",".skillIn"),$(document).on("click",".skillIn",function(){var skill=getSkillById($(this).data("skill-id"));skill&&loadSkillToModal(skill)}),$(document).off("click",".popReqListElement"),$(document).on("click",".popReqListElement",function(){var skill=getSkillById($(this).data("skill-id"));skill&&loadSkillToModal(skill)})}),app.controller("skillTreeListController",function($scope,auth,$rootScope,notify,request){$scope.showContent=!1,$scope.skillTreeCategories=[],$scope.skillTreeSkills=[];var updatedId=0;function checkSkillReqIs(id,array){if(!array)return!1;if(array.length<=0)return!1;for(let i=0;i<array.length;i++)if(array[i]==id)return!0;return!1}function validateSkillForm(){var name=$("#skillNameForm").val(),about=$("#skillAboutForm").val(),level=$("#skillLevelForm").val(),isRootElement="on"==$("#isRootSkill").val(),skillRoot=$("#skillTreeSkillRootSelect").val(),category=($("#skillTreeReqSelect").val(),$("#skillTreeCatSelect").val()),file=$("#skillFile").val(),error=!1;return(error=validateMustBe(name))||(error=validateMustBe(about)),error||(error=validateMustBe(level)),error||(error=validateMustBe(category)),$scope.isUpdate||error||(error=validateMustBe(file)),isRootElement||error||(error=validateMustBe(skillRoot)),!error}function validateMustBe(element){return(!element||null==element)&&(notify.localNotify("Walidacja","Nie wszystkie pola zostały odpowiednio wypełnione"),!0)}$scope.isUpdate=!1,$scope.loadSkillTreeData=function(){request.backend("getSkillTreeData",{},function(data){$scope.$apply(function(){$scope.skillTreeCategories=data.categories,$scope.skillTreeSkills=data.skills,$scope.showContent=!0})})},$scope.openAddCategoryModal=function(){$("#addCategoryModal").modal("open"),setTimeout(function(){$("#categoryColorForm").parent().parent().colorpicker({component:".btn"})},200)},$scope.addCategory=function(){$("#addCategoryModal").modal("close");var name=$("#categoryNameForm").val(),color=$("#categoryColorForm").val();$("#categoryNameForm").val(""),$("#categoryColorForm").val(""),request.backend("addCategorySkillTree",{name,color},function(data){$scope.$apply(function(){$scope.skillTreeCategories.push({id:data,name,color})}),notify.localNotify("Sukces","Pomyślnie dodano kategorię")})},$scope.editCategoryModal=function(category){$("#addCategoryModal").modal("open"),updatedId=category.id,$scope.isUpdate=!0,$("#categoryNameForm").val(category.name),$("#categoryColorForm").val(category.color),setTimeout(function(){$("#categoryColorForm").parent().parent().colorpicker({component:".btn",format:"hex",color:category.color}),$("#categoryColorForm").parent().parent().colorpicker("setValue",category.color)},200)},$scope.deleteCategory=function(){$("#addCategoryModal").modal("close"),$("#categoryNameForm").val(""),$("#categoryColorForm").val(""),$scope.isUpdate=!1,$rootScope.showModalWindow("Usunięcie kategorii w skilltree",function(){request.backend("deleteCategorySkillTree",{id:updatedId},function(data){$scope.$apply(function(){for(let i=0;i<$scope.skillTreeCategories.length;i++)if($scope.skillTreeCategories[i].id==updatedId){$scope.skillTreeCategories.splice(i,1);break}updatedId=0}),notify.localNotify("Sukces","Pomyślnie usunięto kategorię")})})},$scope.closeModals=function(){$("#addCategoryModal").modal("close"),$("#addSkillModal").modal("close"),$("#skillNameForm").val(""),$("#skillAboutForm").val(""),$("#skillLevelForm").val("0"),$("#skillFile").val(""),$("#skillTreeSkillRootSelect").val(""),$("#skillTreeReqSelect").val(""),$("#skillTreeCatSelect").val(""),updatedId=0,$scope.isUpdate=!1},$scope.saveCategory=function(){$("#addCategoryModal").modal("close");var name=$("#categoryNameForm").val(),color=$("#categoryColorForm").val();$("#categoryNameForm").val(""),$("#categoryColorForm").val(""),request.backend("saveCategorySkillTree",{id:updatedId,name,color},function(data){$scope.$apply(function(){for(let i=0;i<$scope.skillTreeCategories.length;i++)if($scope.skillTreeCategories[i].id==updatedId){$scope.skillTreeCategories[i].name=name,$scope.skillTreeCategories[i].color=color;break}updatedId=0}),notify.localNotify("Sukces","Pomyślnie zapisano zmiany")}),$scope.isUpdate=!1},$(document).off("change","#skillTreeCatSelect"),$(document).on("change","#skillTreeCatSelect",function(){var id=$(this).val();$("#skillTreeSkillRootSelect").html(""),$("#skillTreeSkillRootSelect").append('<option value="" disabled selected>Wybierz umiejętność</option>');for(let i=0;i<$scope.skillTreeSkills.length;i++)if($scope.skillTreeSkills[i].category_id==id){var name=parseInt($scope.skillTreeSkills[i].level)>0?$scope.skillTreeSkills[i].name+" - poziom: "+$scope.skillTreeSkills[i].level:$scope.skillTreeSkills[i].name;$("#skillTreeSkillRootSelect").append('<option value="'+$scope.skillTreeSkills[i].id+'"  >'+name+"</option>")}$("#skillTreeSkillRootSelect").material_select()}),$scope.openAddSkillModal=function(){$("#addSkillModal").modal("open"),$("#skillTreeCatSelect").html(""),$("#skillTreeCatSelect").append('<option value="" disabled selected>Wybierz kategorię umiejętności</option>');for(let i=0;i<$scope.skillTreeCategories.length;i++)$("#skillTreeCatSelect").append('<option value="'+$scope.skillTreeCategories[i].id+'"  >'+$scope.skillTreeCategories[i].name+"</option>");$("#skillTreeReqSelect").html(""),$("#skillTreeReqSelect").append('<option value="" disabled selected>Wybierz dodatkowe zależności</option>'),$("#skillTreeSkillRootSelect").html(""),$("#skillTreeSkillRootSelect").append('<option value="" disabled selected>Wybierz najpierw kategorie</option>');for(let i=0;i<$scope.skillTreeSkills.length;i++){var name=parseInt($scope.skillTreeSkills[i].level)>0?$scope.skillTreeSkills[i].name+" - poziom: "+$scope.skillTreeSkills[i].level:$scope.skillTreeSkills[i].name;$("#skillTreeReqSelect").append('<option value="'+$scope.skillTreeSkills[i].id+'"  >'+name+"</option>")}$("select").material_select()},$scope.editSkill=function(){if($("#addSkillModal").modal("close"),$("#SkillUpdateIdForm").val(updatedId),validateSkillForm()){let dataToSend=new FormData($("#SkillTreeSkillForm")[0]);request.backend("saveSkillInTree",dataToSend,function(data){$scope.$apply(function(){$scope.skillTreeSkills=data})},"Umiejętność zapisana",!0)}$("#skillNameForm").val(""),$("#skillAboutForm").val(""),$("#skillLevelForm").val("0"),$("#skillFile").val(""),$("#skillTreeSkillRootSelect").val(""),$("#skillTreeReqSelect").val(""),$("#skillTreeCatSelect").val(""),$scope.isUpdate=!1},$scope.editSkillModal=function(element){$("#addSkillModal").modal("open"),$("#skillFile").val(""),$scope.isUpdate=!0,updatedId=element.id,request.backend("getSkillToEdit",{id:updatedId},function(skillThis){$("#skillTreeCatSelect").html(""),$("#skillTreeCatSelect").append('<option value="" disabled >Wybierz kategorię umiejętności</option>');for(let i=0;i<$scope.skillTreeCategories.length;i++){var isThis=$scope.skillTreeCategories[i].id==skillThis.category_id;$("#skillTreeCatSelect").append("<option "+(isThis?"selected":"")+' value="'+$scope.skillTreeCategories[i].id+'"  >'+$scope.skillTreeCategories[i].name+"</option>")}$("#skillTreeReqSelect").html(""),$("#skillTreeReqSelect").append('<option value="" disabled >Wybierz dodatkowe zależności</option>'),$("#skillTreeSkillRootSelect").html(""),$("#skillTreeSkillRootSelect").append('<option value="" disabled >Wybierz umiejętność</option>');for(let i=0;i<$scope.skillTreeSkills.length;i++){var isInSkillArray=checkSkillReqIs($scope.skillTreeSkills[i].id,skillThis.req),name=parseInt($scope.skillTreeSkills[i].level)>0?$scope.skillTreeSkills[i].name+" - poziom: "+$scope.skillTreeSkills[i].level:$scope.skillTreeSkills[i].name;if($("#skillTreeReqSelect").append("<option "+(isInSkillArray?"selected":"")+' value="'+$scope.skillTreeSkills[i].id+'"  >'+name+"</option>"),$scope.skillTreeSkills[i].category_id==skillThis.category_id){var isThisRoot=$scope.skillTreeSkills[i].id==skillThis.root_skill_id;$("#skillTreeSkillRootSelect").append("<option "+(isThisRoot?"selected":"")+' value="'+$scope.skillTreeSkills[i].id+'"  >'+name+"</option>")}}$scope.rootSkill=parseInt(skillThis.root_skill_id)<=0,$("select").material_select()}),$("#skillNameForm").val(element.name),$("#skillAboutForm").val(element.description),$("#skillLevelForm").val(element.level)},$scope.deleteSkill=function(){$("#skillNameForm").val(""),$("#skillAboutForm").val(""),$("#skillLevelForm").val("0"),$("#skillFile").val(""),$("#skillTreeSkillRootSelect").val(""),$("#skillTreeReqSelect").val(""),$("#skillTreeCatSelect").val(""),$scope.isUpdate=!1,$rootScope.showModalWindow("Usunięcie umiejętności w skilltree",function(){request.backend("deleteSkillInTree",{id:updatedId},function(data){$scope.$apply(function(){for(let i=0;i<$scope.skillTreeSkills.length;i++)if($scope.skillTreeSkills[i].id==updatedId){$scope.skillTreeSkills.splice(i,1);break}updatedId=0}),notify.localNotify("Sukces","Pomyślnie usunięto umiejętność")})})},$scope.addSkill=function(){if($("#addSkillModal").modal("close"),validateSkillForm()){let dataToSend=new FormData($("#SkillTreeSkillForm")[0]);request.backend("addSkillTreeSkill",dataToSend,function(data){$scope.$apply(function(){$scope.skillTreeSkills=data})},"Umiejętność dodana",!0)}$("#skillNameForm").val(""),$("#skillAboutForm").val(""),$("#skillLevelForm").val("0"),$("#skillFile").val(""),$("#skillTreeSkillRootSelect").val(""),$("#skillTreeReqSelect").val(""),$("#skillTreeCatSelect").val("")}}),app.controller("userSkillTreeController",function($scope,auth,$rootScope,notify,request){$scope.showContent=!1,$scope.availableSkill=[],$scope.userSelected=!1,$scope.skillLoaded=!1,$scope.userIdNow=0,$scope.loadUserFromTeam=function(){request.backend("getUserFromTeam",{tmid:$rootScope.user.tmid},function(data){$("#userSelect").html(""),$("#userSelect").append("<option value='' disabled selected>Wybierz zawodnika</option>");for(var j=0;j<data.length;j++)$("#userSelect").append("<option value='"+data[j].usid+"'>"+data[j].firstname+" "+data[j].lastname+"</option>");$("select").material_select(),$scope.showContent=!0})},$(document).off("change","#userSelect"),$(document).on("change","#userSelect",function(){let userId=$(this).val();$scope.userIdNow=userId,$scope.userSelected=!0,$scope.skillLoaded=!1,request.backend("getUserAvailableSkill",{usid:userId},function(data){$scope.$apply(function(){$scope.availableSkill=data,$scope.skillLoaded=!0})})}),$(document).off("change",".selectSkillStatus"),$(document).on("change",".selectSkillStatus",function(){$(this).val();let skillId=$(this).attr("id").split("-")[1];$("#"+$(this).attr("id")).first().is(":checked")?($scope.userSelected=!0,$scope.skillLoaded=!1,request.backend("completeUserSkillTreeSkill",{usid:$scope.userIdNow,sid:skillId},function(data){$scope.$apply(function(){$scope.availableSkill=data,$scope.skillLoaded=!0})},"Status umiejętności zmieniony na: zdana")):($scope.userSelected=!0,$scope.skillLoaded=!1,request.backend("uncompleteUserSkillTreeSkill",{usid:$scope.userIdNow,sid:skillId},function(data){$scope.$apply(function(){$scope.availableSkill=data,$scope.skillLoaded=!0})},"Status umiejętności zmieniony"))})}),app.controller("myStatsController",function($scope,auth,$rootScope,notify,statistic,request){function initMainSummary(){if($scope.acutalSelectedGroupTest)new Chart($("#main-summary-chart"),{type:"doughnut",data:{datasets:[{data:[$scope.userForm,100-$scope.userForm],backgroundColor:["#ec1800","#4e4e4e"]}],labels:["Aktualna forma","Braki do maksimum"]},options:{tooltips:{callbacks:{afterLabel:item=>"%"}}}})}function checkTableScoreProgress(){$(".statTable tbody").each(function(){for(var allTr=$(this).find("tr"),i=0;i<allTr.length-1;i++){var progress=parseFloat($(this).find("tr").eq(i).find("td").eq(0).html())-parseFloat($(this).find("tr").eq(i+1).find("td").eq(0).html());if(0!=progress){var word=progress>0?"+":"-";progress=(progress=Math.abs(progress)).toFixed(2),$(this).find("tr").eq(i).find("td").eq(0).append("<span class='"+("+"==word?"tableProgressElementPositive":"tableProgressElementNegative")+"'> "+word+" "+progress+"</span>")}}})}$rootScope.showContent=!1,$scope.showPreLoad=!0,$rootScope.actualStats=[],$scope.acutalSelectedGroup=0,$scope.acutalSelectedGroupTest=[],$scope.dataViewAsTable=!0,$(document).ready(function(){$(window).width()<=768?$(".adw").each(function(){$(this).removeClass("adwWith"),$(this).addClass("adwWithout")}):$(".adw").each(function(){$(this).removeClass("adwWithout"),$(this).addClass("adwWith")})}),$scope.initMyStats=function(){request.backend("getStats",{usid:$rootScope.user.id,tmid:$rootScope.user.tmid},function(data){if($scope.$apply(function(){$scope.showContent=!0,$rootScope.actualStats=data.potential,$scope.userForm=data.form}),$("#selectPotential").html(""),$("#selectPotential").append("<option value='' disabled selected>Grupy testowe</option>"),$rootScope.actualStats)for(var i=0;i<$rootScope.actualStats.length;i++)$("#selectPotential").append("<option value='"+i+"'>"+$rootScope.actualStats[i].name+"</option>");$("select").material_select(),$scope.showTestAndType=!0,$rootScope.showContent=!0,initMainSummary(),function(){for(var label=[],dataSe=[],i=0;i<$rootScope.actualStats.length;i++)label.push($rootScope.actualStats[i].name),dataSe.push($rootScope.actualStats[i].summary);new Chart($("#main-summary-chart-radar"),{type:"radar",data:{datasets:[{label:"Wyniki w poszczególnych kategoriach",data:dataSe,backgroundColor:"rgba(236, 24, 0, 0.2)",borderColor:"#ec1800"}],labels:label},options:{legend:{position:"top"},scale:{ticks:{beginAtZero:!0}},tooltips:{callbacks:{afterLabel:item=>"%"}}}})}(),checkTableScoreProgress()})},$(document).off("click",".optionsToShow"),$(document).on("click",".optionsToShow",function(){$scope.initChart()}),$(document).off("change","#selectPotential"),$(document).on("change","#selectPotential",function(){$scope.showPreLoad=!1,$scope.$apply(function(){$scope.acutalSelectedGroup=$("#selectPotential").val(),$scope.acutalSelectedGroupTest=$rootScope.actualStats[$scope.acutalSelectedGroup].tests}),$(".collapsible").collapsible(),$scope.initChart(),setTimeout(function(){!function(){if($scope.acutalSelectedGroupTest)for(var i=0;i<$scope.acutalSelectedGroupTest.length;i++)if(void 0!=$scope.acutalSelectedGroupTest[i].id)new Chart($("#chart-percent-"+$scope.acutalSelectedGroupTest[i].id),{type:"doughnut",data:{datasets:[{data:[$scope.acutalSelectedGroupTest[i].summary,100-$scope.acutalSelectedGroupTest[i].summary],backgroundColor:["#ec1800","#4e4e4e"]}],labels:["Aktualna średnia","Braki do maksimum"]},options:{tooltips:{callbacks:{afterLabel:item=>"%"}}}})}(),initMainSummary(),checkTableScoreProgress()},50)}),$(document).off("change","#selectDataType"),$(document).on("change","#selectDataType",function(){$scope.dataViewAsTable="tabele"==$("#selectDataType").val(),$scope.initChart()}),$scope.initChart=function(){if(moment.locale("pl"),!$scope.dataViewAsTable&&$scope.acutalSelectedGroupTest)for(var i=0;i<$scope.acutalSelectedGroupTest.length;i++){var data=[],labels=[];if(null!=$scope.acutalSelectedGroupTest[i].scores){for(var j=0;j<$scope.acutalSelectedGroupTest[i].scores.length;j++){var thisDate=moment($scope.acutalSelectedGroupTest[i].scores[j].data);labels.push(thisDate.format("LL")),data.push({t:thisDate,y:$scope.acutalSelectedGroupTest[i].scores[j].wynik})}new Chart($("#chart-"+$scope.acutalSelectedGroupTest[i].id),{type:"line",data:{labels,datasets:[{label:"Wyniki testów",data,borderColor:"#ec1800"}],options:{scales:{xAxes:[{type:"time",distribution:"series",ticks:{source:"labels"}}]}}}})}}}}),app.controller("newScoreController",function($scope,auth,$rootScope,notify,request){$rootScope.showContent=!1,$scope.categories=[],$scope.isSelectedCategory=!1,$scope.users=[];var selectedTestId=-1,selectedUserId=-1,selectedCategoryKey=-1,selectedTestKey=-1;function getAllCategoryWitchTest(){request.backend("getCategoryWitchTest",{tmid:$rootScope.user.tmid},function(data){$scope.$apply(function(){for(key in $scope.categories=data,$scope.categories)$("#catSelect").append('<option value="'+key+'">'+$scope.categories[key].name+"</option>");Materialize.updateTextFields(),$("select").material_select()})})}function checkChange(){$scope.isSelectedUser&&$scope.isSelectedTest&&$scope.isSelectedCategory&&getUserScore()}function getUserScore(){$scope.scores=[],request.backend("getScoreFromTestId",{tmid:$rootScope.user.tmid,tsid:selectedTestId,usid:selectedUserId},function(data){$scope.$apply(function(){$scope.scores=data})})}$scope.isSelectedTest=!1,$scope.isSelectedUser=!1,$scope.scores=[],$scope.initScores=function(){getAllCategoryWitchTest(),request.backend("getAllPlayers",{tmid:$rootScope.user.tmid},function(data){$scope.$apply(function(){for(key in $scope.users=data,data)"ZAWODNIK"==data[key].roleName&&$("#userSelect").append('<option value="'+key+'">'+data[key].firstname+" "+data[key].lastname+"</option>");Materialize.updateTextFields(),$("select").material_select(),$scope.showContent=!0})})},$(document).ready(function(){$(window).width()<=768?$(".adw").each(function(){$(this).removeClass("adwWith"),$(this).addClass("adwWithout")}):$(".adw").each(function(){$(this).removeClass("adwWithout"),$(this).addClass("adwWith")})}),$scope.addScore=function(){if($.isNumeric($("#scoreInput").val().replace(",","."))){var score=parseFloat($("#scoreInput").val().replace(",","."));request.backend("addScore",{tmid:$rootScope.user.tmid,usid:selectedUserId,tsid:selectedTestId,score},function(data){getUserScore(),$("#scoreInput").val(""),notify.addNew(new notify.Notification("Otrzymałeś nowy wynik z kategorii : "+$scope.categories[selectedCategoryKey].name+" -- "+$scope.categories[selectedCategoryKey].tests[selectedTestKey].name,[selectedUserId],"#!/myStats"))},"Pomyślnie dodano nowy wynik testu")}else notify.localNotify("Walidacja","Wpisz najpierw wynik. Musi być on liczbą.")},$scope.deleteScore=function(id){$rootScope.showModalWindow("Nieodwracalne usunięcie wyniku testu",function(){request.backend("deleteScore",{tmid:$rootScope.user.tmid,tsid:id},function(data){$scope.$apply(function(){for(key in $scope.scores)if($scope.scores[key].id==id)return void $scope.scores.splice(key,1)})},"Pomyślnie usunięto wynik testu")})},$(document).off("change","#catSelect"),$(document).on("change","#catSelect",function(){0!=$scope.categories.length&&($scope.isSelectedCategory=!0,selectedCategoryKey=$(this).val(),$scope.categories[selectedCategoryKey].id,function(){if($("#testSelect").html(""),$("#testSelect").append('<option value="" disabled selected>Test</option>'),$scope.isSelectedTest=!1,selectedTestId=-1,$scope.categories[selectedCategoryKey].tests)for(key in $scope.categories[selectedCategoryKey].tests)$("#testSelect").append('<option value="'+key+'">'+$scope.categories[selectedCategoryKey].tests[key].name+"</option>");Materialize.updateTextFields(),$("select").material_select()}())}),$(document).off("change","#testSelect"),$(document).on("change","#testSelect",function(){$scope.isSelectedTest=!0,selectedTestId=$scope.categories[selectedCategoryKey].tests[$(this).val()].id,selectedTestKey=$(this).val(),checkChange()}),$(document).off("change","#userSelect"),$(document).on("change","#userSelect",function(){$scope.isSelectedUser=!0,selectedUserId=$scope.users[$(this).val()].usid,checkChange()}),$scope.deleteUserScore=function(id){$rootScope.showModalWindow("Nieodwracalne usunięcie kategorii",function(){$scope.showTest=!1,$scope.selectedCategoryId=-1,request.backend("deleteCategoryTest",{id},function(data){getAllCategoryWitchTest()},"Pomyślnie usunięto kategorie")})},$scope.addUserScore=function(){var categoryName=$("#categoryName").val();categoryName.length<2?$.gritter.add({title:"Walidacja",text:"Wpisz dłuższą nazwę kategorii",image:"",sticky:!0,time:3,class_name:"my-sticky-class"}):request.backend("addCategoryTest",{name:categoryName},function(data){getAllCategoryWitchTest()},"Pomyślnie dodano nową kategorie")},$scope.selectCategory=function(id){$scope.selectedCategoryId=id,$scope.showTest=!0,getActualTest()}}),app.controller("teammateCompareController",function($scope,auth,$rootScope,notify,statistic,request){$scope.showContent=!1,$scope.selected1=!1,$scope.selected2=!1,$scope.selected3=!1,$scope.loadStat=!0,$rootScope.actualStats=[],$scope.dataViewAsTable=!0,$scope.acutalSelectedGroup=0,$scope.notSelectedPerson=!0,$scope.actualStatGroup=null,$scope.actualPotentialGroup=null;var allUsers=[],firstUsid=0,secondUsid=0,thirdUsid=0,usidList=[],noPrcIs=!0;function checkStatBest(){$("table tbody tr").each(function(){var scoreInElements=$(this).find(".scoreIn");if(!(scoreInElements.legend<=0)){var max,maxScore=(max=0,scoreInElements.each(function(){parseFloat($(this).text())>max&&(max=parseFloat($(this).text()))}),max);scoreInElements.each(function(){parseFloat($(this).text())<maxScore?($(this).find("span").first().remove(),$(this).append("<span style='color: red;font-size: 10px;font-weight:600'>-"+(maxScore-parseFloat($(this).text())).toFixed(2)+"</span>")):parseFloat($(this).text())==maxScore&&($(this).css("color","rgb(22, 193, 22)"),$(this).css("font-weight","600"))})}})}function changePotential(){$scope.showPreLoad=!1,$scope.$apply(function(){if($scope.acutalSelectedGroup=$("#selectPotential").val(),$scope.actualStatGroup=[],$rootScope.actualStats.users[0].data.potential[$scope.acutalSelectedGroup].tests)for(let i=0;i<$rootScope.actualStats.users[0].data.potential[$scope.acutalSelectedGroup].tests.length;i++){const elName=$rootScope.actualStats.users[0].data.potential[$scope.acutalSelectedGroup].tests[i].name;$scope.actualStatGroup.push({name:elName,users:[]});for(let x=0;x<$rootScope.actualStats.users.length;x++)noPrcIs?$scope.actualStatGroup[i].users.push($rootScope.actualStats.users[x].data.potential[$scope.acutalSelectedGroup].tests[i].noPrc+""+$rootScope.actualStats.users[x].data.potential[$scope.acutalSelectedGroup].tests[i].unit.substring(0,1)+"."):$scope.actualStatGroup[i].users.push($rootScope.actualStats.users[x].data.potential[$scope.acutalSelectedGroup].tests[i].summary+"%")}})}$scope.initTeammate=function(){request.backend("getUserFromTeam",{tmid:$rootScope.user.tmid},function(data){$scope.showContent=!0,allUsers=data,$("#firstUserSelect").html(""),$("#firstUserSelect").append("<option value='' disabled selected>Zawodnik 1</option>");for(var i=0;i<allUsers.length;i++){var userName=allUsers[i].firstname+" "+allUsers[i].lastname;$("#firstUserSelect").append("<option value='"+allUsers[i].usid+"'>"+userName+"</option>")}Materialize.updateTextFields(),$("select").material_select(),$("ul.tabs").tabs()})},$scope.showStat=function(){$scope.notSelectedPerson=!1,$("#mainChartContainer").html(""),usidList=[firstUsid,secondUsid],$scope.selected3&&usidList.push(thirdUsid),request.backend("getStats",{usid:usidList,tmid:$rootScope.user.tmid,prc:"none"},function(data){$rootScope.actualStats=data,function(){var elementClass="col s12 m6";$scope.selected3&&(elementClass="col s12 m4");$("#mainChartContainer").html(""),$("#mainChartContainer").css("max-width","600px"),$scope.selected3&&$("#mainChartContainer").css("max-width","1000px");for(let i=0;i<($scope.selected3?3:2);i++){var element='<div class="'+elementClass+'">';element+='<canvas class="col s12" style="padding:0 !important" id="main-summary-chart-'+i+'"></canvas>',element+='<canvas class="col s12" style="padding:0 !important" id="main-summary-chart-radar-'+i+'"></canvas>',element+="</div>",$("#mainChartContainer").append(element)}}(),function(){for(let i=0;i<($scope.selected3?3:2);i++){var userForm=$rootScope.actualStats.users[i].data.form;$("#main-summary-chart-"+i).parent().prepend("<h5>"+$rootScope.actualStats.users[i].userName+"</h5>");new Chart($("#main-summary-chart-"+i),{type:"doughnut",data:{datasets:[{data:[userForm,100-userForm],backgroundColor:["#ec1800","#4e4e4e"]}],labels:["Forma","Braki"]},options:{tooltips:{callbacks:{afterLabel:item=>"%"}}}})}}(),function(){for(let i=0;i<($scope.selected3?3:2);i++){for(var label=[],dataSe=[],j=0;j<$rootScope.actualStats.users[i].data.potential.length;j++)label.push($rootScope.actualStats.users[i].data.potential[j].name),dataSe.push($rootScope.actualStats.users[i].data.potential[j].summary);new Chart($("#main-summary-chart-radar-"+i),{type:"radar",data:{datasets:[{label:"Kierunek rozwoju",data:dataSe,backgroundColor:"rgba(236, 24, 0, 0.2)",borderColor:"#ec1800"}],labels:label},options:{legend:{position:"top"},scale:{ticks:{beginAtZero:!0}},tooltips:{callbacks:{afterLabel:item=>"%"}}}})}}(),$scope.$apply(function(){$scope.loadStat=!1,$("#selectPotential").html(""),$("#selectPotential").append("<option value='' disabled selected>Kategoria</option>");for(let i=0;i<$rootScope.actualStats.users[0].data.potential.length;i++){const element=$rootScope.actualStats.users[0].data.potential[i].name;$("#selectPotential").append("<option value='"+i+"'>"+element+"</option>")}$scope.actualPotentialGroup=[];for(let i=0;i<$rootScope.actualStats.users[0].data.potential.length;i++){const elName=$rootScope.actualStats.users[0].data.potential[i].name;$scope.actualPotentialGroup.push({name:elName,users:[]});for(let x=0;x<$rootScope.actualStats.users.length;x++)$scope.actualPotentialGroup[i].users.push($rootScope.actualStats.users[x].data.potential[i].summary)}}),checkStatBest(),Materialize.updateTextFields(),$("select").material_select(),$("ul.tabs").tabs()})},$scope.hideStat=function(){$scope.notSelectedPerson=!0,$scope.loadStat=!0,$scope.actualStatGroup=[],$scope.actualPotentialGroup=[]},$(document).off("change","#selectPotential"),$(document).on("change","#selectPotential",function(){changePotential(),checkStatBest()}),$(document).off("change","#selectPrcType"),$(document).on("change","#selectPrcType",function(){var value=$(this).val();noPrcIs="prc"!=value,changePotential(),checkStatBest()}),$(document).off("change","#selectDataType"),$(document).on("change","#selectDataType",function(){$scope.dataViewAsTable="tabele"==$("#selectDataType").val()}),$(document).off("change","#firstUserSelect"),$(document).on("change","#firstUserSelect",function(){firstUsid=$(this).val(),$("#secondUserSelect").html(""),$("#secondUserSelect").append("<option value='' disabled selected>Zawodnik 2</option>");for(var i=0;i<allUsers.length;i++)if(allUsers[i].usid!=firstUsid){var userName=allUsers[i].firstname+" "+allUsers[i].lastname;$("#secondUserSelect").append("<option value='"+allUsers[i].usid+"'>"+userName+"</option>")}Materialize.updateTextFields(),$("select").material_select(),$("ul.tabs").tabs(),$scope.$apply(function(){$scope.selected1=!0,$scope.selected2=!1,$scope.selected3=!1})}),$(document).off("change","#secondUserSelect"),$(document).on("change","#secondUserSelect",function(){secondUsid=$(this).val(),$("#thirdUserSelect").html(""),$("#thirdUserSelect").append("<option value='' disabled selected>Zawodnik 3</option>");for(var i=0;i<allUsers.length;i++)if(allUsers[i].usid!=firstUsid&&allUsers[i].usid!=secondUsid){var userName=allUsers[i].firstname+" "+allUsers[i].lastname;$("#thirdUserSelect").append("<option value='"+allUsers[i].usid+"'>"+userName+"</option>")}Materialize.updateTextFields(),$("select").material_select(),$("ul.tabs").tabs(),$scope.$apply(function(){$scope.selected2=!0,$scope.selected3=!1})}),$(document).off("change","#thirdUserSelect"),$(document).on("change","#thirdUserSelect",function(){$scope.$apply(function(){$scope.selected3=!0}),thirdUsid=$(this).val()}),$(document).ready(function(){$(window).width()<=768?$(".adw").each(function(){$(this).removeClass("adwWith"),$(this).addClass("adwWithout")}):$(".adw").each(function(){$(this).removeClass("adwWithout"),$(this).addClass("adwWith")})})}),app.controller("teamStatisticController",function($scope,auth,$rootScope,notify,statistic,request){$rootScope.showContent=!1,$rootScope.actualStats=[],$rootScope.teamCategorySummary=[],$rootScope.teamMatchCategorySummary=[],$scope.showTestSelect=!1;var fullTeamScore=0,matchTeamScore=0,mainChartToCheck=null,colorIndex=0,selectedTestCategory=-1;dataToChartTestInCategory=[];var testChart=null;function getRandomColor(){var list=["#DAF7A6","#FFC300","#FF5733","#C70039","#581845"];return++colorIndex>=list.length&&(colorIndex=0),list[colorIndex]}$(document).ready(function(){$(window).width()<=768?$(".adw").each(function(){$(this).removeClass("adwWith"),$(this).addClass("adwWithout")}):$(".adw").each(function(){$(this).removeClass("adwWithout"),$(this).addClass("adwWith")})}),$scope.initTeamStats=function(){request.backend("getUserFromTeam",{tmid:$rootScope.user.tmid},function(data){for(var allPersonsId=[],matchPersonsId=[],fullPersonId=[],i=0;i<data.length;i++)allPersonsId.push({usid:data[i].usid,userName:data[i].firstname+" "+data[i].lastname}),fullPersonId.push(data[i].usid),data[i].pos_x>=0&&data[i].pos_y>=0&&matchPersonsId.push(data[i].usid);fullTeamScore=statistic.getTeamForm(fullPersonId),matchTeamScore=statistic.getTeamForm(matchPersonsId,!0),statistic.getTeamStats(matchPersonsId,function(){if($rootScope.teamMatchCategorySummary=[],$rootScope.actualStats)for(var j=0;j<$rootScope.actualStats[0].data.potential.length;j++){for(var testLabel=$rootScope.actualStats[0].data.potential[j].name,score=0,i=0;i<$rootScope.actualStats.length;i++)score+=$rootScope.actualStats[i].data.potential[j].summary;score/=$rootScope.actualStats.length,score=Math.round(score),$rootScope.teamMatchCategorySummary.push({name:testLabel,summary:score})}statistic.getTeamStats(fullPersonId,function(){$rootScope.$apply(function(){if($rootScope.showContent=!0,$rootScope.teamCategorySummary=[],$rootScope.actualStats){$("#categoryTestSelect").html(""),$("#categoryTestSelect").append("<option value='' disabled selected>Wybierz kategorię testów</option>");for(var j=0;j<$rootScope.actualStats[0].data.potential.length;j++){var testLabel=$rootScope.actualStats[0].data.potential[j].name,score=0;$rootScope.actualStats[0].data.potential[j].tests&&$rootScope.actualStats[0].data.potential[j].tests.length>0&&$("#categoryTestSelect").append("<option value='"+j+"'>"+testLabel+"</option>");for(var i=0;i<$rootScope.actualStats.length;i++)score+=$rootScope.actualStats[i].data.potential[j].summary;score/=$rootScope.actualStats.length,score=Math.round(score),$rootScope.teamCategorySummary.push({name:testLabel,summary:score})}}}),function(){new Chart($("#fullTeamForm"),{type:"doughnut",data:{datasets:[{data:[fullTeamScore,100-fullTeamScore],backgroundColor:["#ec1800","#4e4e4e"]}],labels:["Poziom całej drużyny","Braki do maksimum"]},options:{tooltips:{callbacks:{afterLabel:item=>"%"}}}}),new Chart($("#actualTeamForm"),{type:"doughnut",data:{datasets:[{data:[matchTeamScore,100-matchTeamScore],backgroundColor:["#ec1800","#4e4e4e"]}],labels:["Poziom składu meczowego","Braki do maksimum"]},options:{tooltips:{callbacks:{afterLabel:item=>"%"}}}});if($rootScope.teamCategorySummary.length>0){for(var label=[],dataSe=[],i=0;i<$rootScope.teamCategorySummary.length;i++)label.push($rootScope.teamCategorySummary[i].name),dataSe.push($rootScope.teamCategorySummary[i].summary);new Chart($("#teamChartRadar"),{type:"radar",data:{datasets:[{label:"Predyspozycje drużyny",data:dataSe,backgroundColor:"rgba(236, 24, 0, 0.2)",borderColor:"#ec1800"}],labels:label},options:{legend:{position:"top"},scale:{ticks:{beginAtZero:!0}},tooltips:{callbacks:{afterLabel:item=>"%"}}}})}if($rootScope.teamMatchCategorySummary.length>0){for(var label=[],dataSe=[],i=0;i<$rootScope.teamMatchCategorySummary.length;i++)label.push($rootScope.teamMatchCategorySummary[i].name),dataSe.push($rootScope.teamMatchCategorySummary[i].summary);new Chart($("#teamMatchChartRadar"),{type:"radar",data:{datasets:[{label:"Predyspozycje składu meczowego",data:dataSe,backgroundColor:"rgba(236, 24, 0, 0.2)",borderColor:"#ec1800"}],labels:label},options:{legend:{position:"top"},scale:{ticks:{beginAtZero:!0}},tooltips:{callbacks:{afterLabel:item=>"%"}}}})}}(),$scope.initChart()})})})},$(document).off("change","#categoryTestSelect"),$(document).on("change","#categoryTestSelect",function(){const categoryId=$(this).val();selectedTestCategory=categoryId,$scope.showTestSelect=!0,$("#testSelect").html(""),$("#testSelect").append("<option value='' disabled selected>Wybierz test</option>");for(var j=0;j<$rootScope.actualStats[0].data.potential[categoryId].tests.length;j++){var testLabel=$rootScope.actualStats[0].data.potential[categoryId].tests[j].name;$("#testSelect").append("<option value='"+j+"'>"+testLabel+"</option>")}setTimeout(function(){Materialize.updateTextFields(),$("select").material_select()},500)}),$(document).off("change","#testSelect"),$(document).on("change","#testSelect",function(){const testId=$(this).val();for(var data=[{label:$rootScope.actualStats[0].data.potential[selectedTestCategory].tests[testId].name,backgroundColor:getRandomColor(),data:[]}],label=[],j=0;j<$rootScope.actualStats.length;j++){label.push($rootScope.actualStats[j].userName);var score=$rootScope.actualStats[j].data.potential[selectedTestCategory].tests[testId].summary;data[0].data.push(score)}testChart&&null!=testChart?(testChart.data.labels=label,testChart.data.datasets=data,testChart.update()):testChart=new Chart($("#testChart"),{type:"horizontalBar",data:{datasets:data,labels:label},options:{responsive:!0,maintainAspectRatio:!1}})}),$scope.initChart=function(){var data=[],label=[];if($rootScope.actualStats){for(var j=0;j<$rootScope.actualStats.length;j++)label.push($rootScope.actualStats[j].userName);for(j=0;j<$rootScope.actualStats[0].data.potential.length;j++){for(var testLabel=$rootScope.actualStats[0].data.potential[j].name,allScore=[],i=0;i<$rootScope.actualStats.length;i++)allScore.push($rootScope.actualStats[i].data.potential[j].summary);data.push({label:testLabel,data:allScore,backgroundColor:getRandomColor()})}mainChartToCheck&&null!=mainChartToCheck?(mainChartToCheck.data.labels=label,mainChartToCheck.data.datasets=data,mainChartToCheck.update()):mainChartToCheck=new Chart($("#chart-main"),{type:"horizontalBar",data:{datasets:data,labels:label},options:{responsive:!0,maintainAspectRatio:!1,tooltips:{callbacks:{afterLabel:item=>"%"}}}})}}}),app.controller("testMenagerController",function($scope,auth,$rootScope,notify,request){function getAllCategoryWitchTest(){request.backend("getCategoryWitchTest",{tmid:$rootScope.user.tmid},function(data){$scope.$apply(function(){$scope.showContent=!0,$scope.categories=data;for(var i=0;i<$scope.categories.length;i++)$scope.categories[i].testCount=$scope.categories[i].tests?$scope.categories[i].tests.length:0;$scope.selectedCategoryId&&-1!=$scope.selectedCategoryId&&getActualTest()})})}function getActualTest(){$(".category-item").each(function(){$(this).css("background","")}),$("#category-"+$scope.selectedCategoryId).css("background","rgba(255, 255, 255, 0.1)");for(var i=0;i<$scope.categories.length;i++)if($scope.categories[i].id==$scope.selectedCategoryId){$scope.tests=$scope.categories[i].tests;break}}function changeTest(id,value,changeType){request.backend("changeTest",{id,value,changeType},function(data){$scope.$apply(function(){getAllCategoryWitchTest()})},"Pomyślnie edytowano test")}$rootScope.showContent=!1,$scope.categories=[],$scope.tests=[],$scope.showTest=!1,$scope.selectedCategoryId=-1,$(document).ready(function(){$(window).width()<=768?$(".adw").each(function(){$(this).removeClass("adwWith"),$(this).addClass("adwWithout")}):$(".adw").each(function(){$(this).removeClass("adwWithout"),$(this).addClass("adwWith")})}),$scope.initTestMenager=function(){getAllCategoryWitchTest()},$scope.deleteCategory=function(id){$rootScope.showModalWindow("Nieodwracalne usunięcie kategorii",function(){$scope.showTest=!1,$scope.selectedCategoryId=-1,request.backend("deleteCategoryTest",{id},function(data){$scope.$apply(function(){getAllCategoryWitchTest()})},"Pomyślnie usunięto kategorie")})},$scope.deleteTest=function(id){$rootScope.showModalWindow("Nieodwracalne usunięcie testu",function(){request.backend("deleteTestFromCat",{id},function(data){$scope.$apply(function(){getAllCategoryWitchTest()})},"Pomyślnie usunięto test")})},$scope.addCategory=function(){var categoryName=$("#categoryName").val();categoryName.length<2?$.gritter.add({title:"Walidacja",text:"Wpisz dłuższą nazwę kategorii",image:"",sticky:!0,time:3,class_name:"my-sticky-class"}):request.backend("addCategoryTest",{name:categoryName},function(data){$scope.$apply(function(){getAllCategoryWitchTest()})},"Pomyślnie dodano nową kategorie")},$scope.addTest=function(){var best=$("#maxScore").val(),worst=$("#minScore").val(),name=$("#testName").val(),unit=$("#unitType").val();if(best&&worst&&$.isNumeric(best)&&$.isNumeric(worst)){if(name&&!(name.length<3))return $scope.selectedCategoryId&&-1!=$scope.selectedCategoryId?void(!unit||unit.length>10?$.gritter.add({title:"Walidacja",text:"Jednostka może mieć maks 10 znaków",image:"",sticky:!0,time:3,class_name:"my-sticky-class"}):request.backend("addTestToCategory",{unit,best,worst,caid:$scope.selectedCategoryId,name,tmid:$rootScope.user.tmid},function(data){$scope.$apply(function(){getAllCategoryWitchTest(),$("#minScore").val(""),$("#testName").val(""),$("#unitType").val(""),$("#maxScore").val("")})},"Pomyślnie dodano nowy test do kategorii")):($.gritter.add({title:"Walidacja",text:"Coś poszło nie tak. Wybierz ponownie kategorie z tabeli",image:"",sticky:!0,time:3,class_name:"my-sticky-class"}),$scope.selectedCategoryId=-1,void($scope.showTest=!1));$.gritter.add({title:"Walidacja",text:"Wpisz poprawnie nazwe testu. Minimum 3 znaki",image:"",sticky:!0,time:3,class_name:"my-sticky-class"})}else $.gritter.add({title:"Walidacja",text:"Pola najlepszego i najgorszego wyniku muszą być liczbą",image:"",sticky:!0,time:3,class_name:"my-sticky-class"})},$scope.selectCategory=function(id){$scope.selectedCategoryId=id,$scope.showTest=!0,getActualTest()},$(document).off("change",".changeBest"),$(document).on("change",".changeBest",function(){var newBest=$(this).val();$.isNumeric(newBest)?changeTest($(this).attr("id").split("-")[1],newBest,"best"):notify.localNotify("Walidacja","Najwiekszy możliwy wynik musi być liczbą")}),$(document).off("change",".changeWorst"),$(document).on("change",".changeWorst",function(){var newWorst=$(this).val();$.isNumeric(newWorst)?changeTest($(this).attr("id").split("-")[1],newWorst,"worst"):notify.localNotify("Walidacja","Najgorszy możliwy wynik musi być liczbą")}),$(document).off("change",".changeUnit"),$(document).on("change",".changeUnit",function(){var newUnit=$(this).val();newUnit.length>10?notify.localNotify("Walidacja","Wpisz maks 10 znaków"):changeTest($(this).attr("id").split("-")[1],newUnit,"unit")})}),app.controller("trainingBaseController",function($scope,auth,$rootScope,notify,statistic,request){$rootScope.showContent=!0,$(document).ready(function(){$(window).width()<=768?$(".adw").each(function(){$(this).removeClass("adwWith"),$(this).addClass("adwWithout")}):$(".adw").each(function(){$(this).removeClass("adwWithout"),$(this).addClass("adwWith")})}),$scope.trainingBase=[{name:"Beep Test",ageCategory:"od 13 roku życia wzwyż",equipment:"2 linie (lub inne znaczniki), urządzenie audio do sygnalizowania (np. laptop)",execution:["1. Linie oddalone są od siebie na odległość 20m.","2. Zawodnik staje na jednej z nich.","3. Zadaniem zawodnika jest biec od linii do linii w wyznaczonych przedziałach czasu.","4. Każdy start z linii musi być zsynchronizowany z sygnałem dźwiękowym („Beep”).","5. Zawodnik biega tak długo, dopóki nie zrezygnuje (nie da rady więcej biec) lub w chwili gdy po raz drugi nie dotrze do linii na czas.","6. Zapisywany jest ostatni etap oraz odcinek, w którym zawodnik dotarł do linii.","7. Zaczynamy od tempa 8.5km/h. Prędkość się zwiększa.","8. Jeśli zawodnik dotrze do linii za szybko, powinien poczekać na sygnał."],scoring:["Im więcej zaliczonych etapów i odcinków 20-metrowych – tym lepiej.","Do e-platformy Club Management Center wynik wprowadzamy w następujący sposób:","liczba przed kropką oznacza etap, a po kropce – odcinek.","Takim sposobem, gdy zawodnik ukończył test na 10 etapie i 2 odcinku, zapisujemy wynik jako 10.02.","Analogicznie jeśli ukończył test na 9 etapie i 10 odcinku, zapisujemy wynik jako 9.1.","W razie niepewności prosimy o kontakt z działem technicznym."]},{name:"Bieg bez piłki",ageCategory:"od 8 do 13 roku życia",equipment:"8 tyczek (lub innych znaczników)",execution:["1. Zawodnik staje na linii startu.","2. Ma przebiec po wyznaczonej trasie (obiegając każdą z tyczek) w jak najszybszym czasie.","3. Rozpoczęcie biegu następuje po komendzie trenera – wtedy również zaczynamy liczenie czasu.","4. Zatrzymujemy czas w momencie przebiegnięcia zawodnika przez linię mety."],scoring:["Im krótszy czas wykonania – tym lepiej.","Niepoprawne wykonanie testu oznacza dyskwalifikację.","Należy wtedy powtórzyć cały test od nowa."]},{name:"FMS - Mobilność barków",ageCategory:"wszyscy",equipment:"taśma centymetrowa (lub inny przyrząd do pomiaru odległości)",execution:["1. Należy zmierzyć zawodnikowi odległość między podstawą dłoni a końcem środkowego palca.","2. Zawodnik zaciska pięści w obu dłoniach.","3. Teraz sięga jedną ręką od góry, drugą od dołu – tak, aby ułożyć je jak najbliżej siebie za plecami.","4. Zawodnik ma wykonać to jednym, płynnym ruchem i utrzymać ręce za plecami.","5. Należy zmierzyć odległość między pięściami, a następnie wykonać całość odwrotnym ustawieniem rąk."],scoring:["3pkt: Odległość między pięściami nie przekracza odległości pomiędzy podstawą dłoni i końcem środkowego palca zawodnika.","2pkt: Odległość między pięściami nie przekracza półtorej długości dłoni zawodnika.","1pkt: Odległość między pięściami przekracza półtorej długości dłoni zawodnika."]},{name:"FMS - Pompka",ageCategory:"wszyscy",equipment:"brak",execution:["1. Zawodnik przyjmuje pozycję do pompki z rękoma rozstawionymi na szerokość barków.","2. Mężczyźni: kciuki mają znajdować się na wysokości czubka głowy.","Kobiety: kciuki mają znajdować się na wysokości policzków.","3. Zawodnik wykonuje pompkę.","4. Należy zwrócić uwagę, aby zawodnik uniósł całe ciało bez wyginania kręgosłupa."],scoring:["3pkt: Mężczyźni: Poprawnie wykonana pompka.","Kobiety: Poprawnie wykonana pompka.","2pkt: Mężczyźni: Poprawnie wykonana pompka, ale z kciukami na wysokości policzków.","Kobiety: Poprawnie wykonana pompka, ale z kciukami na wysokości obojczyków.","1pkt: Brak poprawnie wykonanej pompki."]},{name:"FMS - Przejście pod płotkiem",ageCategory:"wszyscy",equipment:"drążek (może być tyczka lub kij), płotek (lub sznurek)",execution:["1. Zawodnik stoi przed płotkiem (palce stóp pod płotkiem).","2. Zawodnik trzyma oburącz drążek, opiera go na barkach.","3. Rozpoczyna się zadanie – zawodnik ma przenieść nogę nad płotkiem, bez dotykania go.","4. Należy postawić nogę po drugiej stronie płotka i dotknąć piętą podłoża.","5. Zawodnik wraca do pozycji wyjściowej, a następnie powtarza całość wykonując drugą nogą."],scoring:["3pkt: Biodro, kolano i stopa nogi znajdującej się po drugiej stronie płotka są w jednej osi. Odcinek lędźwiowy kręgosłupa ma być nieruchomy, a drążek z listwą ustawione do siebie równolegle.","2pkt: Brak osi wzdłuż nogi znajdującej się po drugiej stronie płotka. Odcinek lędźwiowy kręgosłupa nie jest nieruchomy, a drążek z listwą nie są ustawione równolegle.","1pkt: Zawodnik dotknął płotka i tracił równowagę."]},{name:"FMS - Przysiad głęboki",ageCategory:"wszyscy",equipment:"drążek (może być tyczka lub kij)",execution:["1. Zawodnik stoi w rozkroku na szerokość bioder.","2. Zawodnik trzyma nad głową drążek – ręce wyprostowane w łokciach.","3. Rozpoczyna się zadanie – zawodnik ma wykonać maksymalny przysiad.","4. Należy zwrócić uwagę na to, aby ciało zawodnika było skierowane na wprost, a jego pięty mają przylegać do ziemi."],scoring:["3pkt: Zawodnik zszedł na tyle nisko, że jego biodra znalazły się poniżej linii kolan, kolana znajdują się osi nóg, uda ułożone są równolegle do tułowia, a drążek jest na wysokości stóp.","2pkt: Zawodnik wykonał przysiad, ale z pomocą – z podstawką położoną pod piętami, kolana nie znajdują się w osi nóg.","1pkt: Zawodnik nie wykonuje poprawnie przysiadu nawet z pomocą, dodatkowo zgięcie w części lędźwiowej kręgosłupa."]},{name:"FMS - Przysiad w wykroku",ageCategory:"wszyscy",equipment:"drążek (może być tyczka lub kij), podstawa (lub listwa), taśma centymetrowa (lub inny przyrząd do pomiaru odległości)",execution:["1. Należy zacząć od zmierzenia długości podudzia zawodnika.","2. Zawodnik stoi na początku podstawy, od tego miejsca (od czubka stopy) należy odmierzyć na podstawie odległość równą długości podudzia i zaznaczyć ją na podstawie.","3. Zawodnik otrzymuje drążek, ma go trzymać oburącz i przyłożyć go do pleców.","4. Teraz zawodnik stawia piętę jednej z nóg w wyznaczonym punkcie i wykonuje przysiad.","5. Należy dotknąć kolanem podstawy (za piętą postawioną w wyznaczonym punkcie).","6. Zawodnik wraca do pozycji wyjściowej i wykonuje to samo drugą nogą."],scoring:["3pkt: Stopy i kolana podczas wykonywania ćwiczenia utrzymane były w jednej linii, dotknięto kolanem podstawy, ruch tułowia był minimalny.","2pkt: Nie utrzymano jednej linii stóp i kolan, nie dotknięto kolanem podstawy, pochylono się do przodu podczas wykonywania ćwiczenia.","1pkt: Zawodnik całkowicie utracił równowagę."]},{name:"FMS - Stabilność rotacyjna tułowia",ageCategory:"wszyscy",equipment:"brak",execution:["1. Zawodnik ustawia się w następujący sposób: klęczy w podporze na ziemi tak, aby biodra i barki były ustawione do tułowia pod kątem 90 stopni. Stopy mają być wyprostowane.","2. Zawodnik ma jednocześnie unieść lewą rękę i lewą nogę, a następnie wyprostować obie kończyny w powietrzu.","3. Teraz zawodnik musi ugiąć kończyny i dotknąć łokciem kolana.","4. Następnie należy znowu wyprostować kończyny.","5. Na koniec powrót do pozycji wyjściowej i powtórzenie testu drugą parą kończyn."],scoring:["3pkt: Poprawne wykonanie, zawodnik utrzymał tułów równolegle do podłoża, a kolano i łokieć były w jednej linii.","2pkt: Poprawne wykonanie skośnej wersji testu (przeciwległe kończyny, czyli kiedy podnosimy lewą rękę, musimy podnieść prawą nogę), zawodnik utrzymał tułów równolegle do podłoża.","1pkt: Brak poprawnego wykonania skośnej wersji testu."]},{name:"FMS - Uniesienie wyprostowanej nogi",ageCategory:"wszyscy",equipment:"deska, drążek (lub tyczka)",execution:["1. Zawodnik kładzie się na plecach.","2. Pod kolanami umieszczamy deskę.","3. Należy znaleźć kolec biodrowy przedni górny oraz szparę stawu kolanowego zawodnika.","4. Zawodnik unosi wyprostowaną nogę. Stopa zgięta w taki sposób, aby tworzyła z nogą kąt 90 stopni (jakbyśmy chcieli pokazać palcami stopy na siebie).","5. Teraz należy przyłożyć do kostki zawodnika drążek, tak aby był prostopadle do ziemi.","6. Zauważamy miejsce padania drążka i powtarzamy test drugą nogą."],scoring:["3pkt: Miejsce padania drążka znajduje się między kolcem biodrowym przednim górnym zawodnika, a środkiem uda.","2pkt: Miejsce padania drążka znajduje się między środkiem uda, a linią stawu kolanowego.","1pkt: Miejsce padania drążka znajduje się za szparą stawu kolanowego."]},{name:"Ławeczki",ageCategory:"od 13 do 16 roku życia",equipment:"2 tyczki (lub inne znaczniki), ławeczka, piłka",execution:["1. Zawodnik przez 90 sekund ma za zadanie uderzać piłką o ławeczkę.","2. Uderzenie ma być wykonane wewnętrzną częścią stopy, na przemian lewą i prawą nogą.","3. Odległość od miejsca wykonania uderzenia do ławeczki wynosi 3m.","4. Po uderzeniu zawodnik ma dowolnie przyjąć piłkę, przeprowadzić ją przez „bramkę” z tyczek i wykonać kolejne powtórzenie.","5. Liczymy ilość poprawnych uderzeń."],scoring:["5pkt: powyżej 21 uderzeń","4pkt: 21-20 uderzeń","3pkt: 20-19 uderzeń","2pkt: 18-17 uderzeń","1pkt: 16-15 uderzeń","0pkt: poniżej 15 uderzeń"]},{name:"Prowadzenie piłki",ageCategory:"od 8 do 13 roku życia",equipment:"8 tyczek (lub innych znaczników), piłka",execution:["1. Zawodnik staje z piłką na linii startowej.","2. Ma przebiec po wyznaczonej trasie (obiegając każdą z tyczek) w jak najszybszym czasie – jednocześnie prowadząc piłkę.","3. Rozpoczęcie biegu następuje po komendzie trenera – wtedy również zaczynamy liczenie czasu.","4. Zatrzymujemy czas w momencie przebiegnięcia zawodnika przez linię mety."],scoring:["Im krótszy czas wykonania – tym lepiej.","Niepoprawne wykonanie testu oznacza dyskwalifikację.","Należy wtedy powtórzyć cały test od nowa."]},{name:"RAST",ageCategory:"od 16 roku życia wzwyż",equipment:"4 tyczki (lub inne znaczniki), fotokomórki",execution:["1. Odległość między liniami startu i mety wynosi 30m.","2. Test polega na jak najszybszym wykonaniu siedmiu sprintów na tym dystansie.","3. Pomiędzy powtórzeniami występuje przerwa (trucht) o długości 25s.","4. Zawodnik ustawia się na jednej z linii.","5. Zawodnik ma wykonać jak najszybszy sprint, a po nim wrócić na linię startową truchtem.","6. Mierzymy czas średni wszystkich biegów oraz procentowy spadek czasu.","7. Procentowy spadek czasu jest różnicą między najszybszym, a najwolniejszym sprintem."],scoring:["Im krótszy czas średni i im mniejszy spadek procentowy czasu – tym lepiej."]},{name:"Skok w dal z miejsca",ageCategory:"od 8 do 13 roku życia",equipment:"jedna linia, taśma centymetrowa",execution:["1. Zawodnik staje dwoma nogami przed linią.","2. Wzdłuż przestrzeni przeznaczonej do skoku rozkładamy taśmę centymetrową.","3. Wyskok jak i lądowanie powinno być wykonane obunóż.","4. Zadaniem zawodnika jest wykonanie jak najdalszego skoku w dal z miejsca.","5. Wynik jest odległością od linii skoku do pięty zawodnika."],scoring:["Im dalsza odległość od linii wyskoku – tym lepiej.","Niepoprawne wykonanie testu oznacza dyskwalifikację.","Zawodnik musi wyskoczyć i wylądować obunóż, przy lądowaniu nie może pomagać sobie opierając się rękoma.","Należy wtedy powtórzyć cały test od nowa."]},{name:"Szybkość (30m)",ageCategory:"od 13 roku życia wzwyż",equipment:"2 linie, fotokomórki",execution:["1. Zawodnik staje na linii startu w pozycji wykroczno-zakrocznej (ok. 5cm od linii).","2. Linię startu wyznacza światło fotokomórek.","3. Czas mierzymy fotokomórkami (dokładność min. do 0.01s).","4. Czas mierzymy na dystansie 30m.","5. Opcjonalnie, jeśli mamy wystarczającą ilość fotokomórek, możemy zmierzyć zmierzyć czas na dystansach 5m i 20m."],scoring:["Im krótszy czas wykonania – tym lepiej.","Niepoprawne wykonanie testu oznacza dyskwalifikację.","Należy wtedy powtórzyć cały test od nowa."]},{name:"Wyskok dosiężny",ageCategory:"od 13 roku życia wzwyż",equipment:"tablica, kreda, taśma centymetrowa",execution:["1. Zawodnik staje przy tablicy.","2. Wyciąga ramię i dotyka palcami tablicy.","3. Teraz, stojąc bokiem do ściany, robi przysiad.","4. Wyskakuje w górę z przedmachem ramion w tył.","5. Stara się dotknąć tablicy w jak najwyższym punkcie.","6. Teraz mierzymy odległość od punktu zaznaczonego podczas stania w miejscu do punktu zaznaczonego podczas wyskoku."],scoring:["5pkt: powyżej 54cm","4pkt: 54-50cm","3pkt: 49-45cm","2pkt: 44-40cm","1pkt: 39-35cm","0pkt: poniżej 35cm"]},{name:"Zwroty z piłką",ageCategory:"od 8 do 13 roku życia",equipment:"dwie linie (lub pachołki), piłka",execution:["1. Zawodnik staje z piłką na jednej z linii.","2. Linie oddalone są od siebie o 5m.","3. Zawodnik jak najszybciej biegnie, prowadząc piłkę w kierunku drugiej linii.","4. Za drugą linią zawodnik ma wykonać zwrot z piłką.","5. Następnie bez przerwy biegnie do poprzedniej linii i znowu wykonuje zwrot.","6. Należy jak najszybciej wykonać 6 zwrotów.","7. Czas liczony jest od momentu wystartowania zawodnika, a zatrzymany w momencie przebiegnięcia zawodnika za linię podczas ostatniego powtórzenia.","8. Piłka za każdym razem musi znajdować się za linią całym swoim obwodem."],scoring:["Im krótszy czas wykonania – tym lepiej.","Niepoprawne wykonanie testu oznacza dyskwalifikację.","Należy wtedy powtórzyć cały test od nowa."]},{name:"Żonglerka piłką",ageCategory:"od 8 do 13 roku życia",equipment:"cztery pachołki (lub inne znaczniki), piłka",execution:["1. Zawodnik staje z piłką wewnątrz wyznaczonego pola – kwadrat 5m x 5m.","2. Test polega na podbijaniu piłki dowolną częścią ciała (poza rękoma). Liczymy ilość podbić.","3. Test trwa 30 sekund. Jeśli piłka wyleci poza pole, zawodnik biegnie po nią i kontynuuje test, ale czas nie jest wstrzymywany.","4. Zawodnicy z kategorii wiekowej Orlik i Młodzik rozpoczynają żonglowanie od podniesienia piłki z ziemi nogą oraz żonglują tylko w powietrzu (piłka nie może dotknąć podłoża).","5. Zawodnicy z kategorii wiekowej Żak i Skrzat rozpoczynają żonglowanie od opuszczenia piłki z rąk, a piłka może dotknąć ziemi."],scoring:["Im większa ilość podbić piłki – tym lepiej."]}]}),app.controller("usersStatisticController",function($scope,auth,$rootScope,notify,statistic,request){function changePotential(){$scope.showPreLoad=!1,$scope.$apply(function(){$scope.acutalSelectedGroup=$("#selectPotential").val(),$scope.acutalSelectedGroupTest=$rootScope.actualStats[$scope.acutalSelectedGroup].tests}),$(".collapsible").collapsible(),$scope.initChart(),function(){if($scope.acutalSelectedGroupTest)for(var i=0;i<$scope.acutalSelectedGroupTest.length;i++)if(void 0!=$scope.acutalSelectedGroupTest[i].id)new Chart($("#chart-percent-"+$scope.acutalSelectedGroupTest[i].id),{type:"doughnut",data:{datasets:[{data:[$scope.acutalSelectedGroupTest[i].summary,100-$scope.acutalSelectedGroupTest[i].summary],backgroundColor:["#ec1800","#4e4e4e"]}],labels:["Aktualna średnia","Braki do maksimum"]},options:{tooltips:{callbacks:{afterLabel:item=>"%"}}}})}(),$(".statTable tbody").each(function(){var thisBest=$(this).parent().parent().find(".bestSc").first().html(),thisWorst=$(this).parent().parent().find(".worstSc").first().html(),bestIsMore=!1;thisBest>thisWorst&&(bestIsMore=!0);for(var allTr=$(this).find("tr"),i=0;i<allTr.length-1;i++){var actual=parseFloat($(this).find("tr").eq(i).find("td").eq(0).html()),before=parseFloat($(this).find("tr").eq(i+1).find("td").eq(0).html()),progress=actual-before;if(0!=progress){var word=progress>0?"+":"-";progress=Math.abs(progress);var className="+"==word?"tableProgressElementPositive":"tableProgressElementNegative";className=bestIsMore?className:"tableProgressElementPositive"==className?"tableProgressElementNegative":"tableProgressElementPositive",progress=progress.toFixed(2),$(this).find("tr").eq(i).find("td").eq(0).append("<span class='"+className+"'> "+word+" "+progress+"</span>")}}})}$rootScope.showContent=!1,$scope.showPreLoad=!0,$rootScope.actualStats=[],$scope.acutalSelectedGroup=0,$scope.acutalSelectedGroupTest=[],$scope.dataViewAsTable=!0,$scope.acutalSelectedUserId="",$scope.showTestAndType=!1,$scope.userForm=0,$(document).ready(function(){$(window).width()<=768?$(".adw").each(function(){$(this).removeClass("adwWith"),$(this).addClass("adwWithout")}):$(".adw").each(function(){$(this).removeClass("adwWithout"),$(this).addClass("adwWith")})}),$scope.initUsersStats=function(){request.backend("getAllPlayers",{tmid:$rootScope.user.tmid},function(data){for(key in $scope.users=data,data)"ZAWODNIK"==data[key].roleName&&$("#selectUserToStat").append('<option value="'+data[key].usid+'">'+data[key].firstname+" "+data[key].lastname+"</option>");$rootScope.showContent=!0,Materialize.updateTextFields(),$("select").material_select()})},$(document).off("change","#selectUserToStat"),$(document).on("change","#selectUserToStat",function(){$scope.showTestAndType=!1,$scope.acutalSelectedUserId=$(this).val(),request.backend("getStats",{usid:$scope.acutalSelectedUserId,tmid:$rootScope.user.tmid},function(data){if($scope.$apply(function(){$scope.showContent=!0,$rootScope.actualStats=data.potential,$scope.userForm=data.form,$scope.showTestAndType=!0}),$("#selectPotential").html(""),$("#selectPotential").append("<option value='' disabled>Grupy testowe</option>"),$rootScope.actualStats)for(var i=0;i<$rootScope.actualStats.length;i++)0==i?$("#selectPotential").append("<option value='"+i+"'selected>"+$rootScope.actualStats[i].name+"</option>"):$("#selectPotential").append("<option value='"+i+"'>"+$rootScope.actualStats[i].name+"</option>");$("select").material_select(),setTimeout(function(){changePotential(),function(){if($scope.acutalSelectedGroupTest)new Chart($("#main-summary-chart"),{type:"doughnut",data:{datasets:[{data:[$scope.userForm,100-$scope.userForm],backgroundColor:["#ec1800","#4e4e4e"]}],labels:["Aktualna forma","Braki do maksimum"]},options:{tooltips:{callbacks:{afterLabel:item=>"%"}}}})}(),function(){for(var label=[],dataSe=[],i=0;i<$rootScope.actualStats.length;i++)label.push($rootScope.actualStats[i].name),dataSe.push($rootScope.actualStats[i].summary);new Chart($("#main-summary-chart-radar"),{type:"radar",data:{datasets:[{label:"Wyniki w poszczególnych kategoriach",data:dataSe,backgroundColor:"rgba(236, 24, 0, 0.2)",borderColor:"#ec1800"}],labels:label},options:{legend:{position:"top"},scale:{ticks:{beginAtZero:!0}}}})}()},50)})}),$(document).off("change","#selectPotential"),$(document).on("change","#selectPotential",function(){changePotential()}),$(document).off("change","#selectDataType"),$(document).on("change","#selectDataType",function(){$scope.dataViewAsTable="tabele"==$("#selectDataType").val(),$scope.initChart()}),$(document).off("click",".optionsToShow"),$(document).on("click",".optionsToShow",function(){$scope.initChart()}),$scope.initChart=function(){if(moment.locale("pl"),!$scope.dataViewAsTable&&$scope.acutalSelectedGroupTest)for(var i=0;i<$scope.acutalSelectedGroupTest.length;i++){var data=[],labels=[];if(null!=$scope.acutalSelectedGroupTest[i].scores){for(var j=0;j<$scope.acutalSelectedGroupTest[i].scores.length;j++){var thisDate=moment($scope.acutalSelectedGroupTest[i].scores[j].data);labels.push(thisDate.format("LL")),data.push({t:thisDate,y:$scope.acutalSelectedGroupTest[i].scores[j].wynik})}new Chart($("#chart-"+$scope.acutalSelectedGroupTest[i].id),{type:"line",data:{labels,datasets:[{label:"Wyniki testów",data,borderColor:"#ec1800"}],options:{scales:{xAxes:[{type:"time",distribution:"series",ticks:{source:"labels"}}]}}}})}}}}),app.controller("tabController",function($scope,auth,$rootScope,notify,request){$scope.lastId=0,$scope.posts=[],$scope.maxPost=5,$scope.showContent=!1,$scope.canGetMorePost=!1,$scope.morePost=function(){$scope.maxPost+=5,$scope.posts.length>$scope.maxPost?$scope.canGetMorePost=!0:$scope.canGetMorePost=!1},$scope.moreComment=function(id){for(var i=0;i<$scope.posts.length;i++)if($scope.posts[i].psid==id)return void($scope.posts[i].maxComment+=5)},$scope.getLastPost=function(){request.backend("getPost",{tmid:$rootScope.user.tmid},function(data){$scope.$apply(function(){$scope.showContent=!0,$scope.posts=[]}),data.length>5&&($scope.canGetMorePost=!0);for(var i=0;i<data.length;i++)$scope.$apply(function(){$scope.posts.push(data[i]),$scope.posts[i].maxComment=2});null!=data[0]&&null!=data[0].psid&&($scope.lastId=data[0].psid)})},$scope.addPost=function(){$("#errorNewPost").html("").hide();var message=$("#newPostInput").val();message.length<5||message.length>500?notify.localNotify("Walidacja","Wiadomosc musi być dłuższa niż 5 znaków oraz krótsza niż 500"):request.backend("addPost",{msg:message,tmid:$rootScope.user.tmid},function(data){$scope.getLastPost(),notify.addNew(new notify.Notification($rootScope.user.firstname+" "+$rootScope.user.lastname+" dodał post",null,"#!/tab",!0))},"Twój post został pomyślnie dodany")},$scope.addComment=function(psid){var message=$("#tx_"+psid).val();message.length<5||message.length>500?notify.localNotify("Walidacja","Komentarz musi zawierać od 5 do 500 znaków"):request.backend("addComment",{msg:message,post_id:psid},function(data){$scope.getLastPost()},"Twój komentarz został pomyślnie dodany")},$(document).off("keydown",".commentPostInput"),$(document).on("keydown",".commentPostInput",function(e){if(13==e.which){var postId=$(this).attr("id").split("_")[1];$scope.addComment(postId)}}),$scope.deletePost=function(id){request.backend("deletePost",{psid:id},function(data){$scope.getLastPost()},"Post został usunięty pomyślnie")},$scope.deleteComment=function(id){request.backend("deleteComment",{cmid:id},function(data){$scope.getLastPost()},"Komentarz został usunięty pomyślnie")}}),app.controller("timetableController",function($scope,auth,$rootScope,notify,request){$scope.showContent=!1,$scope.events=[],$scope.selectedColor="#de5c8a",$scope.initTimetable=function(){$rootScope.user.tmid&&""!=$rootScope.user.tmid?request.backend("getTimetableEvent",{tmid:$rootScope.user.tmid},function(data){$scope.$apply(function(){$scope.events=data,$scope.showContent=!0})}):$scope.showContent=!0},$scope.selectColor=function(color){$(".borderSelectedColor").css("border-color",color),$scope.selectedColor=color},$scope.iniTimetableSettings=function(){request.backend("getTimetableEventFull",{tmid:$rootScope.user.tmid},function(data){$scope.$apply(function(){$scope.events=data,$scope.showContent=!0})})},$scope.deleteTimetableEvent=function(id){$rootScope.showModalWindow("Nieodwracalne usunięcie zajęć z grafiku",function(){request.backend("deleteTimetableEvent",{id},function(data){$scope.iniTimetableSettings()},"Usunięto z grafiku")})},$scope.addTimetableEvent=function(){var title=$("#addTitleNews").val(),day=$("#dayName").val(),time=$("#timeEVENT").val(),timeEnd=$("#timeEventEnd").val();if(day&&time&&title&&timeEnd)if(!title||title.length<=3)notify.localNotify("Walidacja","Wpisz dłuższy tytuł");else{var regexp=/([01][0-9]|[02][0-3]):[0-5][0-9]/,correct=time.search(regexp)>=0,correctEnd=timeEnd.search(regexp)>=0;correct&&correctEnd?request.backend("addTimetableEvent",{title,day,time,color:$scope.selectedColor,tmid:$rootScope.user.tmid,timeEnd},function(data){$scope.iniTimetableSettings()},"Dodano pomyślnie"):notify.localNotify("Walidacja","Błędny format czasu (hh:mm)")}else notify.localNotify("Walidacja","Wpisz wszystkie dane")}}),app.controller("todoController",function($scope,auth,$rootScope,request,notify){function getMyTodo(){request.backend("getTodo",{},function(data){$scope.$apply(function(){$scope.todoList=data})})}function setInputColor(){$("#todoText").css("border-color",$scope.selectedColor),$("#todoButton").css("border-color",$scope.selectedColor)}$scope.todoList,$scope.selectedColor="#de5c8a",$scope.selectedKey=1,$scope.initToDo=function(){getMyTodo(),setInputColor()},$scope.addTodo=function(){var titlea=$("#todoText").val(),colora=$scope.selectedColor;if(titlea.length<=3)notify.localNotify("Walidacja","Wpisz dłuższy tekst");else if(titlea.length>50)notify.localNotify("Walidacja","Wpisz mniej tekstu");else{var dataToSend={usid:$rootScope.user.id,title:titlea,color:colora};request.backend("addTodo",dataToSend,function(){$("#todoText").val(""),$("#todoColor").val("#f44336"),getMyTodo()},"Twoje zadanie zostało dodane")}},$scope.endTodo=function(todoId){request.backend("endTodo",{tid:todoId},function(){for(var last=$scope.todoList,newTodo=[],i=0;i<last.length;i++)last[i].id!=todoId&&newTodo.push(last[i]);$scope.$apply(function(){$scope.todoList=newTodo})},"Twoje zadanie pomyślnie zakończone")},$scope.selectColor=function(value){$scope.selectedColor=value,setInputColor()}}),app.controller("conspectusCreatorController",function($scope,auth,$rootScope,notify,request,$location,$compile){$scope.selectedObjImg=null,$scope.selectedField=null,$scope.selectedArrow=null,$scope.arrowPointCount=0,$scope.shapePointCount=0,$scope.shapePoint=[],$scope.arrowPoint=[],$scope.lastSelected=null,$scope.fieldImage=null,$scope.onlyPlayer=!1,$scope.orientation="landscape",$scope.animId=-1,$scope.turnOnHelperNet=!1,$scope.turnOnRotation=!1,$scope.turnOnHekperFullScreen=!1,$scope.fullElement=null,$scope.iloscklatekPomiedzyGlownymi=40,$scope.jakoscAnimacji=40,$scope.iloscfps=30,$scope.selectedItemList=[],$scope.startPointSelectShape=null,$scope.endPointSelectShape=null,$scope.canAddItem=!1;var multiDragPositionStart={x:0,y:0};$("#animCreator").niceScroll({cursorborderradius:"0px",cursorborder:"none",scrollspeed:60,emulatetouch:!0,hwacceleration:!0,smoothscroll:!0,bouncescroll:!0,mousescrollstep:30,background:"transparent",cursorwidth:"4px",cursorcolor:"#a51100"}),$scope.objConfig={player:{confName:"player",text:" ",selectedColorText:"rgb(255,255,255)",selectedTextSize:"17",selectedColor:{background:"rgb(255, 255, 255)",border:"rgb(255, 255, 255)"},colors:[{background:"rgb(0,126,255)",border:"rgb(255, 255, 255)"},{background:"rgb(144, 0, 255)",border:"rgb(255, 255, 255)"},{background:"rgb(174, 174, 174)",border:"rgb(255, 255, 255)"},{background:"rgb(255, 48, 0)",border:"rgb(255, 255, 255)"},{background:"rgb(255, 204, 0)",border:"rgb(255, 255, 255)"},{background:"rgb(255, 255, 255)",border:"rgb(255, 255, 255)"}]},arrow:{confName:"arrow",text:" ",selectedColorText:"rgb(255,255,255)",selectedTextSize:"17",arrowTypes:["Podanie","Prowadzenie piłki","Bieg bez piłki","Linia pomocnicza","Odległość zawodników","Strzał"],arrowType:"Podanie"},shape:{confName:"shape",text:" ",selectedColorText:"rgb(255,255,255)",selectedTextSize:"17",selectedColor:{border:"rgb(255, 255, 255)",background:"rgba(255, 255, 255, 0.4)"},colors:[{border:"rgb(0, 126, 255)",background:"rgba(0, 126, 255, 0.4)"},{border:"rgb(202, 203, 203)",background:"rgba(202, 203, 203, 0.4)"},{border:"rgb(0, 126, 255)",background:"rgba(0, 126, 255, 0.4)"},{border:"rgb(144, 0, 255)",background:"rgba(144, 0, 255, 0.4)"},{border:"rgb(255, 48, 0)",background:"rgba(255, 48, 0, 0.4)"},{border:"rgb(255, 204, 0)",background:"rgba(255, 204, 0, 0.4)"}]},ball:{confName:"ball",text:" ",selectedColorText:"rgb(255,255,255)",selectedTextSize:"17",selectedColor:{background:"rgb(255, 255, 255)",border:"rgb(0, 0, 0)"},colors:[{background:"rgb(254,100,62)",border:"rgb(0, 0, 0)"},{background:"rgb(255, 255, 255)",border:"rgb(0, 0, 0)"}]},cones:{confName:"cones",text:" ",selectedColorText:"rgb(255,255,255)",selectedTextSize:"17",selectedColor:{background:"rgb(255, 255, 255)",border:"rgb(255,255,255)"},colors:[{background:"rgb(255, 255, 255)",border:"rgb(255,255,255)"},{background:"rgb(255, 204, 0)",border:"rgb(255,255,255)"},{background:"rgb(255, 48, 0)",border:"rgb(255,255,255)"},{background:"rgb(174, 174, 174)",border:"rgb(255,255,255)"},{background:"rgb(144, 0, 255)",border:"rgb(255,255,255)"},{background:"rgb(0, 126, 255)",border:"rgb(255,255,255)"}]},rings:{confName:"rings",text:" ",selectedColorText:"rgb(255,255,255)",selectedTextSize:"17",selectedColor:{background:"rgb(255, 255, 255)",border:"rgb(255, 255, 255)"},colors:[{background:"rgb(0,126,255)",border:"rgb(255, 255, 255)"},{background:"rgb(144, 0, 255)",border:"rgb(255, 255, 255)"},{background:"rgb(174, 174, 174)",border:"rgb(255, 255, 255)"},{background:"rgb(255, 48, 0)",border:"rgb(255, 255, 255)"},{background:"rgb(255, 204, 0)",border:"rgb(255, 255, 255)"},{background:"rgb(255, 255, 255)",border:"rgb(255, 255, 255)"}]},flags:{confName:"flags",text:" ",selectedColorText:"rgb(255,255,255)",selectedTextSize:"17",selectedColor:{background:"rgb(255, 255, 255)",border:"rgb(255, 255, 255)"},colors:[{background:"rgb(0,126,255)",border:"rgb(255, 255, 255)"},{background:"rgb(144, 0, 255)",border:"rgb(255, 255, 255)"},{background:"rgb(174, 174, 174)",border:"rgb(255, 255, 255)"},{background:"rgb(255, 48, 0)",border:"rgb(255, 255, 255)"},{background:"rgb(255, 204, 0)",border:"rgb(255, 255, 255)"},{background:"rgb(255, 255, 255)",border:"rgb(255, 255, 255)"}]},poles:{confName:"poles",text:" ",selectedColorText:"rgb(255,255,255)",selectedTextSize:"17",selectedColor:{background:"rgb(255, 255, 255)",border:"rgb(255, 255, 255)"},colors:[{background:"rgb(0,126,255)",border:"rgb(255, 255, 255)"},{background:"rgb(144, 0, 255)",border:"rgb(255, 255, 255)"},{background:"rgb(174, 174, 174)",border:"rgb(255, 255, 255)"},{background:"rgb(255, 48, 0)",border:"rgb(255, 255, 255)"},{background:"rgb(255, 204, 0)",border:"rgb(255, 255, 255)"},{background:"rgb(255, 255, 255)",border:"rgb(255, 255, 255)"}]},onlyText:{confName:"onlyText",text:" ",selectedColorText:"rgb(255,255,255)",selectedTextSize:"17"}},$scope.cwName="",$scope.arrowArrayPostionAnchor=[],$scope.shapeArrayPostionAnchor=[],$scope.gif="",$scope.tags="",$scope.cwFieldType="",$scope.cwMaxTime=0,$scope.cwMinTime=0,$scope.cwMaxPerson=0,$scope.cwMinPerson=0,$scope.cwOps="",$scope.cwWsk="",$scope.showAnimCreator=!1,$scope.selectedObjConfig=[],$scope.initObjList=function(){request.backend("getConspectAnimObj",{},function(data){$scope.$apply(function(){if(data.length>0){for(var i=0;i<data.length;i++){var content=$compile(data[i].category)($scope);if($("#categoryFromItemBox").append(content),data[i].obj){content=$compile(data[i].obj)($scope);$("#itemBoxFromCat").append(content)}}$(document).ready(function(){$(".tooltipped").tooltip({delay:50})})}})})},$rootScope.idFromAnimConspectToEdit&&""!=$rootScope.idFromAnimConspectToEdit&&null!=$rootScope.idFromAnimConspectToEdit&&($scope.animId=$rootScope.idFromAnimConspectToEdit,$rootScope.idFromAnimConspectToEdit=null,loadAnimation(function(){$scope.isSelectedField=!0,$scope.showAnimCreator=!0})),$scope.mouseActionType={MOVE:0,OBJECT_ADD:1,ARROW_ADD:2,FIELD_LIST:3,SHAPE_ADD:4},$scope.arrowType={FULL_2:1,FULL_3:2,STRIPED_2:3,STRIPED_3:4},$scope.shapeType={WHITE_3:1,WHITE_4:2,WHITE_5:3,GREY_3:4,GREY_4:5,GREY_5:6,BLUE_3:7,BLUE_4:8,BLUE_5:9,PURPLE_3:10,PURPLE_4:11,PURPLE_5:12,ORANGE_3:13,ORANGE_4:14,ORANGE_5:15,RED_3:16,RED_4:17,RED_5:18};var stageWidth=800,stageHeight=.6*stageWidth,selectedFrame=new Konva.Stage({container:"canvasPlayerContainer",width:stageWidth,height:stageHeight}),allObjectPerFrame=[];$scope.animName="",allObjectPerFrame.push({arrow:[],obj:[],shapes:[],text:[]}),$scope.selectedShape=null;var currentObjPerFrame=0,allAnimFrame=[],anchorHistory=[],actualPlayerFrame=0,pauseAnim=!1,fieldLayer=null,mainLayer=null,curveLayer=null,selectShapeLayer=null,anchorLayer=null,lineLayer=null,quadCurves=[],somethingIsDraw=!1,isPlayerOpen=!1;function onMuseUp(){$scope.actualMouseAction!=$scope.mouseActionType.MOVE||null==$scope.startPointSelectShape||null==$scope.endPointSelectShape||somethingIsDraw||function(){if(!$scope.startPointSelectShape||!$scope.endPointSelectShape)return;anchorLayer&&(anchorLayer.destroy(),anchorLayer=null);anchorLayer=new Konva.Layer,$scope.$apply(function(){var maxX=Math.max($scope.startPointSelectShape.x,$scope.endPointSelectShape.x),minX=Math.min($scope.startPointSelectShape.x,$scope.endPointSelectShape.x),maxY=Math.max($scope.startPointSelectShape.y,$scope.endPointSelectShape.y),minY=Math.min($scope.startPointSelectShape.y,$scope.endPointSelectShape.y);$scope.lastSelected=null,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null,$scope.selectedItemList=[];var isSameConfig=!0,confName="",shapes=selectedFrame.find(".movementObject");shapes.each(function(shape){shape.stroke("transparent");var x=shape.getAttr("x"),y=shape.getAttr("y");if(x>=minX&&x<=maxX&&y>=minY&&y<=maxY){$scope.selectedItemList.push(shape),shape.strokeWidth(1),shape.stroke("red");var config=shape.getAttr("config");config?""==confName?confName=config.confName:confName!=config.confName&&(isSameConfig=!1):isSameConfig=!1}});var shapes=selectedFrame.find(".arrow");shapes.each(function(shape){shape.stroke("white");var x=shape.getAttr("x"),y=shape.getAttr("y"),shapePoint=shape.getAttr("points"),isAllInSelectShape=!0;for(let a=0;a<shapePoint.length;a++)if(!(shapePoint[a].x+x>=minX&&shapePoint[a].x+x<=maxX&&shapePoint[a].y+y>=minY&&shapePoint[a].y+y<=maxY)){isAllInSelectShape=!1;break}if(isAllInSelectShape){$scope.selectedItemList.push(shape),shape.stroke("red");var config=shape.getAttr("config");config?""==confName?confName=config.confName:confName!=config.confName&&(isSameConfig=!1):isSameConfig=!1}});var shapes=selectedFrame.find(".shapes");shapes.each(function(shape){var fillColor=shape.getAttr("fill");fillColor.replace("0.4","1"),shape.stroke(fillColor);var x=shape.getAttr("x"),y=shape.getAttr("y"),shapePoint=shape.getAttr("arrowPoint"),isAllInSelectShape=!0;for(let a=0;a<shapePoint.length;a++)if(!(shapePoint[a].x+x>=minX&&shapePoint[a].x+x<=maxX&&shapePoint[a].y+y>=minY&&shapePoint[a].y+y<=maxY)){isAllInSelectShape=!1;break}if(isAllInSelectShape){$scope.selectedItemList.push(shape),shape.stroke("red");var config=shape.getAttr("config");config?""==confName?confName=config.confName:confName!=config.confName&&(isSameConfig=!1):isSameConfig=!1}}),isSameConfig&&$scope.selectedItemList.length>0&&($scope.lastSelected=$scope.selectedItemList[0],showInConfigObjData($scope.selectedItemList[0])),null!=selectShapeLayer&&(selectShapeLayer.destroy(),selectShapeLayer=null),$scope.showObjConfig(),selectedFrame.draw()})}()}function onMuseMove(){if($scope.actualMouseAction==$scope.mouseActionType.MOVE&&null!=$scope.startPointSelectShape){var scale=selectedFrame.getAttr("scaleX"),mousePos=selectedFrame.getPointerPosition();$scope.endPointSelectShape={x:mousePos.x/scale,y:mousePos.y/scale},somethingIsDraw||$scope.$apply(function(){null!=selectShapeLayer&&(selectShapeLayer.destroy(),selectShapeLayer=null),selectShapeLayer=new Konva.Layer;var start=$scope.startPointSelectShape,end=$scope.endPointSelectShape,poly=new Konva.Line({points:[start.x,start.y,end.x,start.y,end.x,end.y,start.x,end.y],fill:"rgba(63, 127, 191, 0.25)",stroke:"rgb(63, 127, 191)",strokeWidth:2,closed:!0});selectShapeLayer.add(poly),selectedFrame.add(selectShapeLayer)})}}function onMuseDown(){if($scope.actualMouseAction==$scope.mouseActionType.MOVE){var scale=selectedFrame.getAttr("scaleX"),mousePos=selectedFrame.getPointerPosition();$scope.startPointSelectShape={x:mousePos.x/scale,y:mousePos.y/scale}}}function configTextUpdate(obj){for(var id=obj.getAttr("id"),config=obj.getAttr("config"),txt=obj.getAttr("textObj"),i=0;i<allObjectPerFrame.length;i++){for(var j=0;j<allObjectPerFrame[i].obj.length;j++)if(allObjectPerFrame[i].obj[j].getAttr("id")==id){if(allObjectPerFrame[i].obj[j].setAttr("config",config),txt)(thisTxt=allObjectPerFrame[i].obj[j].getAttr("textObj")).setAttr("fill",txt.getAttr("fill")),thisTxt.setAttr("text",txt.getAttr("text")),thisTxt.setAttr("fontSize",txt.getAttr("fontSize"));break}for(j=0;j<allObjectPerFrame[i].arrow.length;j++)if(allObjectPerFrame[i].arrow[j].getAttr("id")==id){if(allObjectPerFrame[i].arrow[j].setAttr("config",config),txt)(thisTxt=allObjectPerFrame[i].arrow[j].getAttr("textObj")).setAttr("fill",txt.getAttr("fill")),thisTxt.setAttr("text",txt.getAttr("text")),thisTxt.setAttr("fontSize",txt.getAttr("fontSize"));break}for(j=0;j<allObjectPerFrame[i].shapes.length;j++)if(allObjectPerFrame[i].shapes[j].getAttr("id")==id){var thisTxt;if(allObjectPerFrame[i].shapes[j].setAttr("config",config),txt)(thisTxt=allObjectPerFrame[i].shapes[j].getAttr("textObj")).setAttr("fill",txt.getAttr("fill")),thisTxt.setAttr("text",txt.getAttr("text")),thisTxt.setAttr("fontSize",txt.getAttr("fontSize"));break}}}function configColorUpdate(obj){for(var id=obj.getAttr("id"),config=obj.getAttr("config"),i=0;i<allObjectPerFrame.length;i++){for(var j=0;j<allObjectPerFrame[i].obj.length;j++)if(allObjectPerFrame[i].obj[j].getAttr("id")==id){allObjectPerFrame[i].obj[j].setAttr("config",config);var src=allObjectPerFrame[i].obj[j].getAttr("image").src,srcExt=src.substring(src.length-4,src.length),back=allObjectPerFrame[i].obj[j].getAttr("config").selectedColor.background,border=allObjectPerFrame[i].obj[j].getAttr("config").selectedColor.border;src=(src=(src=(src=src.split("-rgb")[0])+"-"+back+border+srcExt).replace(/ /g,"")).replace(/\%20/g,"");var img=new Image;img.onload=function(){mainLayer.draw()},img.src=src,allObjectPerFrame[i].obj[j].setAttr("image",img)}for(j=0;j<allObjectPerFrame[i].arrow.length;j++)allObjectPerFrame[i].arrow[j].getAttr("id")==id&&allObjectPerFrame[i].arrow[j].setAttr("config",config);for(j=0;j<allObjectPerFrame[i].shapes.length;j++)allObjectPerFrame[i].shapes[j].getAttr("id")==id&&allObjectPerFrame[i].shapes[j].setAttr("config",config)}}function selectField(src){$scope.$apply(function(){$scope.selectedField=new Image,$scope.fieldImage=$scope.selectedField,$scope.selectedField.onload=function(){$scope.fieldImage=$scope.selectedField,drawNewStage()},$scope.actualMouseAction=$scope.mouseActionType.MOVE,$scope.selectedField.src=src})}function deleteCurrent(){if($scope.lastSelected&&$scope.selectedItemList.length<=0)deleteItem($scope.lastSelected);else if($scope.selectedItemList.length>0)for(let i=0;i<$scope.selectedItemList.length;i++)deleteItem($scope.selectedItemList[i])}function deleteItem(item){if(item){$scope.$apply(function(){selectObjStyle(null),$scope.changeCategories($scope.mouseActionType.MOVE)});var id=item.getAttr("id");for(let c=currentObjPerFrame;c<allObjectPerFrame.length;c++){for(var actual=-1,actualItem=null,i=0;i<allObjectPerFrame[c].obj.length;i++){if(allObjectPerFrame[c].obj[i].getAttr("id")==id){actual=i,actualItem=allObjectPerFrame[c].obj[i];break}}if(actual<0){for(i=0;i<allObjectPerFrame[c].arrow.length;i++){if(allObjectPerFrame[c].arrow[i].getAttr("id")==id){actual=i,actualItem=allObjectPerFrame[c].arrow[i];break}}if(actual>=0)allObjectPerFrame[c].arrow.splice(actual,1);else{for(i=0;i<allObjectPerFrame[c].shapes.length;i++){if(allObjectPerFrame[c].shapes[i].getAttr("id")==id){actual=i,actualItem=allObjectPerFrame[c].shapes[i];break}}if(actual>=0)allObjectPerFrame[c].shapes.splice(actual,1);else{for(i=0;i<allObjectPerFrame[c].text.length;i++){if(allObjectPerFrame[c].text[i].getAttr("id")==id){actual=i,actualItem=allObjectPerFrame[c].text[i];break}}actual>=0&&allObjectPerFrame[c].text.splice(actual,1)}}}else allObjectPerFrame[c].obj.splice(actual,1);if(deleteAnchor(c,id),deleteAnchor(c+1,id),null!=anchorLayer&&(anchorLayer.destroy(),anchorLayer=null),anchorLayer=new Konva.Layer,selectedFrame.add(anchorLayer),actualItem){var txt=actualItem.getAttr("textObj");txt&&txt.destroy(),actualItem.destroy(),$scope.$apply(function(){actualItem=null})}}selectedFrame.draw()}}function newId(){var id=(Math.floor(1e6*Math.random()+1)+Math.floor(1e6*Math.random()+1)+Math.floor(1e6*Math.random()+1))*Math.random();return Math.round(id)}function selectObjStyle(thisObj){selectedFrame.find(".movementObject").each(function(shape){shape.stroke("transparent")}),selectedFrame.find(".arrow").each(function(shape){shape.stroke("white")}),selectedFrame.find(".shapes").each(function(shape){var fillColor=shape.getAttr("fill");fillColor.replace("0.4","1"),shape.stroke(fillColor)}),thisObj&&(thisObj.stroke("#dd4213"),thisObj.strokeWidth(1),$scope.$apply(function(){$scope.lastSelected=thisObj}),showInConfigObjData(thisObj)),$scope.showObjConfig(),selectedFrame.draw()}function createAnchorToArrow(x,y,arrowObj,arrowArrayIndex){var anchor=new Konva.Circle({x:x+arrowObj.getAttr("x"),y:y+arrowObj.getAttr("y"),radius:5,stroke:"#ddd",fill:"#dda613",strokeWidth:1,visible:!0,draggable:!0});return anchor.on("mouseover touchstart",function(){document.body.style.cursor="pointer",this.setStrokeWidth(3),anchorLayer.draw()}),anchor.on("mouseout touchend",function(){document.body.style.cursor="default",this.setStrokeWidth(1),anchorLayer.draw()}),anchor.on("dragend",function(){$scope.arrowArrayPostionAnchor[arrowArrayIndex]={x:anchor.getAttr("x")-arrowObj.getAttr("x"),y:anchor.getAttr("y")-arrowObj.getAttr("y")},function(arrowObj){arrowObj.setAttr("points",$scope.arrowArrayPostionAnchor);var id=arrowObj.getAttr("id");for(let i=0;i<allObjectPerFrame.length;i++)for(let y=0;y<allObjectPerFrame[i].arrow.length;y++)id==allObjectPerFrame[i].arrow[y].getAttr("id")&&(allObjectPerFrame[i].arrow[y].setAttr("x",arrowObj.getAttr("x")),allObjectPerFrame[i].arrow[y].setAttr("y",arrowObj.getAttr("y")));var txtObj=arrowObj.getAttr("textObj");txtObj.setAttr("x",$scope.arrowArrayPostionAnchor[0].x+arrowObj.getAttr("x")),txtObj.setAttr("y",$scope.arrowArrayPostionAnchor[0].y+arrowObj.getAttr("y")),$scope.arrowArrayPostionAnchor[0].y<$scope.arrowArrayPostionAnchor[1].y?txtObj.setAttr("offsetY",50):txtObj.setAttr("offsetY",10);arrowObj.setAttr("textObj",txtObj),mainLayer.draw()}(arrowObj)}),anchor.on("dragstart",function(){somethingIsDraw=!0,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),anchor.on("touchstart",function(){somethingIsDraw=!0,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),anchor.on("mouseup",function(){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),anchor.on("touchend",function(){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),anchorLayer.add(anchor),anchor}function createAnchorToShape(x,y,shapeObj,shapeArrayIndex){var anchor=new Konva.Circle({x:x+shapeObj.getAttr("x"),y:y+shapeObj.getAttr("y"),radius:5,stroke:"#ddd",fill:"#dda613",strokeWidth:1,visible:!0,draggable:!0});return anchor.on("mouseover touchstart",function(){document.body.style.cursor="pointer",this.setStrokeWidth(3),anchorLayer.draw()}),anchor.on("mouseout touchend",function(){document.body.style.cursor="default",this.setStrokeWidth(1),anchorLayer.draw()}),anchor.on("dragend",function(){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null,$scope.shapeArrayPostionAnchor[shapeArrayIndex]={x:anchor.getAttr("x")-shapeObj.getAttr("x"),y:anchor.getAttr("y")-shapeObj.getAttr("y")},function(shapeObj){shapeObj.setAttr("arrowPoint",$scope.shapeArrayPostionAnchor);var id=shapeObj.getAttr("id");for(let i=0;i<allObjectPerFrame.length;i++)for(let y=0;y<allObjectPerFrame[i].shapes.length;y++)id==allObjectPerFrame[i].shapes[y].getAttr("id")&&(allObjectPerFrame[i].shapes[y].setAttr("x",shapeObj.getAttr("x")),allObjectPerFrame[i].shapes[y].setAttr("y",shapeObj.getAttr("y")));var txtObj=shapeObj.getAttr("textObj");txtObj.setAttr("x",$scope.shapeArrayPostionAnchor[0].x+shapeObj.getAttr("x")),txtObj.setAttr("y",$scope.shapeArrayPostionAnchor[0].y+shapeObj.getAttr("y")),$scope.shapeArrayPostionAnchor[0].y<$scope.shapeArrayPostionAnchor[1].y?txtObj.setAttr("offsetY",50):txtObj.setAttr("offsetY",10);shapeObj.setAttr("textObj",txtObj),mainLayer.draw(),mainLayer.draw()}(shapeObj)}),anchor.on("dragstart",function(){somethingIsDraw=!0,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),anchor.on("touchstart",function(){somethingIsDraw=!0,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),anchor.on("mouseup",function(){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),anchor.on("touchend",function(){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),anchorLayer.add(anchor),anchor}function createTextB(x,y,text){return new Konva.Text({x,y,offsetX:100,offsetY:30-$scope.selectedObjConfig.selectedTextSize,text,fontSize:$scope.selectedObjConfig.selectedTextSize,fontFamily:"Calibri",fill:$scope.selectedObjConfig.selectedColorText,padding:20,width:200,listening:!1,align:"center"})}function drawArrowStyle(context,obj,isHitRegion=!1){context.beginPath(),context.lineJoin="round",context.lineCap="round";var pkt=obj.getAttr("points");context.lineWidth=isHitRegion?10:obj.getAttr("strokeWidth"),isHitRegion&&obj.setAttr("strokeWidth",10),context.strokeStyle=obj.getAttr("stroke"),context.moveTo(pkt[0].x,pkt[0].y);for(var pkt1,pkt2,pkt3,poz=90,z=0;z<pkt.length;z+=2){if((ile=pkt.length-z)>=3)pkt1=pkt[z],pkt2=pkt[z+1],pkt3=pkt[z+2];else{if(2!=ile)break;pkt1=pkt[z],pkt3=pkt[z+1],pkt2={x:(pkt1.x+pkt3.x)/2,y:(pkt1.y+pkt3.y)/2}}for(var wykonanie=0,i=ubytek=1/((Math.sqrt(Math.pow(pkt2.x-pkt1.x,2)+Math.pow(pkt2.y-pkt1.y,2))+Math.sqrt(Math.pow(pkt3.x-pkt2.x,2)+Math.pow(pkt3.y-pkt2.y,2)))/10);i<=1-ubytek;i+=ubytek){switch(last=getPosOnCurves(pkt1,pkt2,pkt3,i),String(obj.getAttr("config").arrowType)){case"Odległość zawodników":case"Podanie":var pkts=getPosOnCurves(pkt1,pkt2,pkt3,i),pktsEnd=getPosOnCurves(pkt1,pkt2,pkt3,i+ubytek);context.quadraticCurveTo(pkts.x,pkts.y,pktsEnd.x,pktsEnd.y);break;case"Strzał":pkts=getPosOnCurves(pkt1,pkt2,pkt3,i),pktsEnd=getPosOnCurves(pkt1,pkt2,pkt3,i+ubytek);var angle=Math.atan((pktsEnd.y-pkts.y)/(pktsEnd.x-pkts.x)),newpx=parseFloat(5*Math.cos(angle+1.57)),newpy=parseFloat(5*Math.sin(angle+1.57));pkts.x+=newpx,pkts.y+=newpy,context.lineTo(pkts.x,pkts.y);break;case"Linia pomocnicza":case"Bieg bez piłki":if(wykonanie%2==0){context.beginPath();pkts=getPosOnCurves(pkt1,pkt2,pkt3,i),pktsEnd=getPosOnCurves(pkt1,pkt2,pkt3,i+ubytek);context.quadraticCurveTo(pkts.x,pkts.y,pktsEnd.x,pktsEnd.y),context.stroke(),context.fillStrokeShape(obj),context.closePath()}break;case"Prowadzenie piłki":pkts=getPosOnCurves(pkt1,pkt2,pkt3,i),pktsEnd=getPosOnCurves(pkt1,pkt2,pkt3,i+ubytek),angle=Math.atan((pktsEnd.y-pkts.y)/(pktsEnd.x-pkts.x)),newpx=parseFloat(10*Math.cos(angle+poz)),newpy=parseFloat(10*Math.sin(angle+poz));pkts.x+=newpx,pkts.y+=newpy,poz*=-1,context.lineTo(pkts.x,pkts.y)}wykonanie++}if("Linia pomocnicza"!=String(obj.getAttr("config").arrowType)&&ile-2<=1){context.stroke(),context.fillStrokeShape(obj),context.closePath(),context.beginPath(),context.moveTo(last.x,last.y);pktsEnd=getPosOnCurves(pkt1,pkt2,pkt3,1),angle=parseFloat(Math.atan((pktsEnd.y-last.y)/(pktsEnd.x-last.x))),newpx=parseFloat(3*Math.cos(angle+parseFloat(1.57))),newpy=parseFloat(3*Math.sin(angle+parseFloat(1.57)));var newPos={x:parseFloat(last.x+newpx),y:parseFloat(last.y+newpy)};context.lineTo(newPos.x,newPos.y),context.lineTo(pktsEnd.x,pktsEnd.y);newpx=parseFloat(3*Math.cos(angle-parseFloat(1.57))),newpy=parseFloat(3*Math.sin(angle-parseFloat(1.57))),newPos={x:parseFloat(last.x+newpx),y:parseFloat(last.y+newpy)};context.lineTo(newPos.x,newPos.y),context.lineTo(last.x,last.y),context.fillStyle="#ffffff",context.fill()}}if(context.stroke(),context.fillStrokeShape(obj),"Odległość zawodników"==String(obj.getAttr("config").arrowType)){pkt.length>=3?(pkt1=pkt[0],pkt2=pkt[1],pkt3=pkt[2]):2==pkt.length&&(pkt1=pkt[0],pkt3=pkt[1],pkt2={x:(pkt1.x+pkt3.x)/2,y:(pkt1.y+pkt3.y)/2});var ubytek=1/((Math.sqrt(Math.pow(pkt2.x-pkt1.x,2)+Math.pow(pkt2.y-pkt1.y,2))+Math.sqrt(Math.pow(pkt3.x-pkt2.x,2)+Math.pow(pkt3.y-pkt2.y,2)))/10);context.beginPath();var pktsStart=getPosOnCurves(pkt1,pkt2,pkt3,0);context.moveTo(pktsStart.x,pktsStart.y);var last=getPosOnCurves(pkt1,pkt2,pkt3,ubytek);angle=parseFloat(Math.atan((pktsStart.y-last.y)/(pktsStart.x-last.x))),newpx=parseFloat(3*Math.cos(angle+parseFloat(1.57))),newpy=parseFloat(3*Math.sin(angle+parseFloat(1.57))),newPos={x:parseFloat(last.x+newpx),y:parseFloat(last.y+newpy)};context.lineTo(newPos.x,newPos.y);newpx=parseFloat(3*Math.cos(angle-parseFloat(1.57))),newpy=parseFloat(3*Math.sin(angle-parseFloat(1.57))),newPos={x:parseFloat(last.x+newpx),y:parseFloat(last.y+newpy)};context.lineTo(newPos.x,newPos.y),context.lineTo(pktsStart.x,pktsStart.y),context.fillStyle="#ffffff",context.fill()}else if("Strzał"==String(obj.getAttr("config").arrowType)){context.stroke(),context.fillStrokeShape(obj),context.beginPath(),context.moveTo(pkt[0].x,pkt[0].y);for(z=0;z<pkt.length;z+=2){var ile;if((ile=pkt.length-z)>=3)pkt1=pkt[z],pkt2=pkt[z+1],pkt3=pkt[z+2];else{if(2!=ile)break;pkt1=pkt[z],pkt3=pkt[z+1],pkt2={x:(pkt1.x+pkt3.x)/2,y:(pkt1.y+pkt3.y)/2}}for(wykonanie=0,i=ubytek=1/((Math.sqrt(Math.pow(pkt2.x-pkt1.x,2)+Math.pow(pkt2.y-pkt1.y,2))+Math.sqrt(Math.pow(pkt3.x-pkt2.x,2)+Math.pow(pkt3.y-pkt2.y,2)))/10);i<=1-ubytek;i+=ubytek){last=getPosOnCurves(pkt1,pkt2,pkt3,i);pkts=getPosOnCurves(pkt1,pkt2,pkt3,i),pktsEnd=getPosOnCurves(pkt1,pkt2,pkt3,i+ubytek),angle=Math.atan((pktsEnd.y-pkts.y)/(pktsEnd.x-pkts.x)),newpx=parseFloat(5*Math.cos(angle-1.57)),newpy=parseFloat(5*Math.sin(angle-1.57));pkts.x+=newpx,pkts.y+=newpy,context.lineTo(pkts.x,pkts.y),wykonanie++}}}context.stroke(),context.fillStrokeShape(obj),isHitRegion&&obj.setAttr("strokeWidth",1)}function addToMultiSelect(obj){var id=obj.getAttr("id"),isIn=!1,pos=0;if($scope.lastSelected){for(let i=0;i<$scope.selectedItemList.length;i++)if($scope.lastSelected.getAttr("id")==$scope.selectedItemList[i].getAttr("id")){isIn=!0,pos=i;break}isIn||$scope.selectedItemList.push($scope.lastSelected),$scope.lastSelected=null}isIn=!1,pos=0;for(let i=0;i<$scope.selectedItemList.length;i++)if(id==$scope.selectedItemList[i].getAttr("id")){isIn=!0,pos=i;break}isIn?$scope.selectedItemList.splice(pos,1):$scope.selectedItemList.push(obj),$scope.lastSelected=null,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null;var isSameConfig=!0,confName="";selectedFrame.find(".movementObject").each(function(shape){shape.stroke("transparent");for(let i=0;i<$scope.selectedItemList.length;i++)if($scope.selectedItemList[i].getAttr("id")==shape.getAttr("id")){shape.strokeWidth(1),shape.stroke("red");var config=shape.getAttr("config");config?""==confName?confName=config.confName:confName!=config.confName&&(isSameConfig=!1):isSameConfig=!1}}),selectedFrame.find(".arrow").each(function(shape){shape.stroke("white");for(let i=0;i<$scope.selectedItemList.length;i++)if($scope.selectedItemList[i].getAttr("id")==shape.getAttr("id")){shape.stroke("red");var config=shape.getAttr("config");config?""==confName?confName=config.confName:confName!=config.confName&&(isSameConfig=!1):isSameConfig=!1}}),selectedFrame.find(".shapes").each(function(shape){var fillColor=shape.getAttr("fill");fillColor.replace("0.4","1"),shape.stroke(fillColor);for(let i=0;i<$scope.selectedItemList.length;i++)if($scope.selectedItemList[i].getAttr("id")==shape.getAttr("id")){shape.stroke("red");var config=shape.getAttr("config");config?""==confName?confName=config.confName:confName!=config.confName&&(isSameConfig=!1):isSameConfig=!1}}),isSameConfig&&$scope.selectedItemList.length>0&&($scope.lastSelected=$scope.selectedItemList[0]),null!=selectShapeLayer&&(selectShapeLayer.destroy(),selectShapeLayer=null),$scope.showObjConfig(),selectedFrame.draw()}function dragAllSelectedItem(idMain,offset){var isIn=!1;for(let x=0;x<$scope.selectedItemList.length;x++){if((id=$scope.selectedItemList[x].getAttr("id"))==idMain){isIn=!0;break}}if(isIn){for(let x=0;x<$scope.selectedItemList.length;x++){var id=$scope.selectedItemList[x].getAttr("id");for(let z=0;z<allObjectPerFrame[currentObjPerFrame].obj.length;z++)if(allObjectPerFrame[currentObjPerFrame].obj[z].getAttr("id")==id){if(idMain==allObjectPerFrame[currentObjPerFrame].obj[z].getAttr("id"))break;allObjectPerFrame[currentObjPerFrame].obj[z].setAttr("x",allObjectPerFrame[currentObjPerFrame].obj[z].getAttr("x")-offset.x),allObjectPerFrame[currentObjPerFrame].obj[z].setAttr("y",allObjectPerFrame[currentObjPerFrame].obj[z].getAttr("y")-offset.y),(txt=allObjectPerFrame[currentObjPerFrame].obj[z].getAttr("textObj")).setAttr("x",allObjectPerFrame[currentObjPerFrame].obj[z].getAttr("x")),txt.setAttr("y",allObjectPerFrame[currentObjPerFrame].obj[z].getAttr("y")+allObjectPerFrame[currentObjPerFrame].obj[z].height()/2*allObjectPerFrame[currentObjPerFrame].obj[z].scale().x)}for(let i=0;i<allObjectPerFrame.length;i++){var isFinded=!1;if(!isFinded)for(let z=0;z<allObjectPerFrame[i].arrow.length;z++)if(allObjectPerFrame[i].arrow[z].getAttr("id")==id){if(isFinded=!0,idMain==allObjectPerFrame[i].arrow[z].getAttr("id")&&i==currentObjPerFrame)break;allObjectPerFrame[i].arrow[z].setAttr("x",allObjectPerFrame[i].arrow[z].getAttr("x")-offset.x),allObjectPerFrame[i].arrow[z].setAttr("y",allObjectPerFrame[i].arrow[z].getAttr("y")-offset.y),(txt=allObjectPerFrame[i].arrow[z].getAttr("textObj")).setAttr("x",allObjectPerFrame[i].arrow[z].getAttr("points")[0].x+allObjectPerFrame[i].arrow[z].getAttr("x")),txt.setAttr("y",allObjectPerFrame[i].arrow[z].getAttr("points")[0].y+allObjectPerFrame[i].arrow[z].getAttr("y"))}if(!isFinded)for(let z=0;z<allObjectPerFrame[i].shapes.length;z++)if(allObjectPerFrame[i].shapes[z].getAttr("id")==id){if(idMain==allObjectPerFrame[i].shapes[z].getAttr("id")&&i==currentObjPerFrame)break;var txt;allObjectPerFrame[i].shapes[z].setAttr("x",allObjectPerFrame[i].shapes[z].getAttr("x")-offset.x),allObjectPerFrame[i].shapes[z].setAttr("y",allObjectPerFrame[i].shapes[z].getAttr("y")-offset.y),(txt=allObjectPerFrame[i].shapes[z].getAttr("textObj")).setAttr("x",allObjectPerFrame[i].shapes[z].getAttr("arrowPoint")[0].x+allObjectPerFrame[i].shapes[z].getAttr("x")),txt.setAttr("y",allObjectPerFrame[i].shapes[z].getAttr("arrowPoint")[0].y+allObjectPerFrame[i].shapes[z].getAttr("y"))}}}drawBeforePositionPoint(),updateNextFrameBeforePosition(),$scope.turnOnRotation&&rotateObject(),null!=anchorLayer&&(anchorLayer.destroy(),anchorLayer=null)}}function clickOnContent(){if($scope.startPointSelectShape=null,$scope.endPointSelectShape=null,$scope.actualMouseAction==$scope.mouseActionType.OBJECT_ADD&&$scope.selectedObjImg&&$scope.canAddItem){null!=anchorLayer&&(anchorLayer.destroy(),anchorLayer=null),anchorLayer=new Konva.Layer,selectedFrame.add(anchorLayer);var mousePos=selectedFrame.getPointerPosition(),scale=selectedFrame.getAttr("scaleX"),id=newId();(obj=new Konva.Image({x:mousePos.x/scale,y:mousePos.y/scale,offsetX:$scope.selectedObjImg.width/2,offsetY:$scope.selectedObjImg.height/2,image:$scope.selectedObjImg,config:$.extend(!0,{},$scope.selectedObjConfig),name:"movementObject",id,textObj:null})).hitFunc(function(context){context.beginPath();var width=this.getWidth()*this.scaleX(),height=this.getHeight()*this.scaleX();context.rect(-15,-15,width+30,height+30),context.closePath(),context.fillStrokeShape(this)}),$scope.$apply(function(){$scope.lastSelected=obj});var complexText=createTextB(mousePos.x/scale,mousePos.y/scale+obj.height()/2,$scope.selectedObjConfig&&$scope.selectedObjConfig.text?$scope.selectedObjConfig.text:"");mainLayer.add(complexText),obj.setAttr("textObj",complexText),obj.on("mousedown touchstart",function(){somethingIsDraw=!0,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null,obj.setAttr("draggable",!0),$scope.shiftPressed||$scope.selectedItemList.length<=0&&($scope.selectedItemList=[],selectObjStyle(this),drawBeforePositionPoint(),updateNextFrameBeforePosition(),$scope.turnOnRotation&&rotateObject())}),obj.on("click tap",function(){$scope.shiftPressed?addToMultiSelect(this):($scope.selectedItemList=[],selectObjStyle(this))}),obj.on("dragmove",function(){var offset={x:multiDragPositionStart.x-this.attrs.x,y:multiDragPositionStart.y-this.attrs.y};$scope.selectedItemList.length>0&&dragAllSelectedItem(this.getAttr("id"),offset),multiDragPositionStart={x:this.getAttr("x"),y:this.getAttr("y")};var txtObj=obj.getAttr("textObj");txtObj.setAttr("x",obj.getAttr("x")),txtObj.setAttr("y",obj.getAttr("y")+obj.height()/2*obj.scale().x),obj.setAttr("textObj",txtObj),mainLayer.draw()}),obj.on("dragstart",function(){multiDragPositionStart={x:this.getAttr("x"),y:this.getAttr("y")},somethingIsDraw=!0,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),obj.on("touchstart",function(){somethingIsDraw=!0,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),obj.on("mouseup",function(){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),obj.on("touchend",function(){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),obj.on("dragend",function(e){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null,$scope.selectedItemList.length<=1&&(drawBeforePositionPoint(),updateNextFrameBeforePosition(),$scope.turnOnRotation&&rotateObject())}),obj.strokeWidth(1),selectObjStyle(obj),mainLayer.add(obj),allObjectPerFrame[currentObjPerFrame].obj.push(obj);for(let z=currentObjPerFrame+1;z<allObjectPerFrame.length;z++)allObjectPerFrame[z].obj.push(createObjFromOther(obj));selectedFrame.find(".movementObject").each(function(shape){shape.on("mouseenter",function(){$scope.actualMouseAction==$scope.mouseActionType.MOVE&&(selectedFrame.container().style.cursor="move")}),shape.on("mouseleave",function(){selectedFrame.container().style.cursor="default"})}),selectedFrame.draw()}else if($scope.actualMouseAction==$scope.mouseActionType.ARROW_ADD){$scope.arrowPointCount++;scale=selectedFrame.getAttr("scaleX"),mousePos=selectedFrame.getPointerPosition();$scope.arrowPoint.push({x:mousePos.x/scale,y:mousePos.y/scale});for(var countLimit=10,pointsArray=[],index=0;index<$scope.arrowPoint.length;index++)pointsArray.push($scope.arrowPoint[index].x),pointsArray.push($scope.arrowPoint[index].y);if(2==$scope.arrowPointCount){id=newId();var arrow=new Konva.Shape({points:$scope.arrowPoint,stroke:"white",strokeWidth:1,id,textObj:null,name:"arrow",draggable:!0,config:$.extend(!0,{},$scope.selectedObjConfig),sceneFunc:function(context){drawArrowStyle(context,this)}});selectObjStyle(arrow),arrow.hitFunc(function(context){drawArrowStyle(context,this,!0)}),anchorLayer&&(anchorLayer.destroy(),anchorLayer=null),anchorLayer=new Konva.Layer,selectedFrame.add(anchorLayer);complexText=createTextB($scope.arrowPoint[0].x,$scope.arrowPoint[0].y,$scope.selectedObjConfig&&$scope.selectedObjConfig.text?$scope.selectedObjConfig.text:"");mainLayer.add(complexText),pointsArray[1]<pointsArray[3]?complexText.setAttr("offsetY",50):complexText.setAttr("offsetY",10),arrow.setAttr("textObj",complexText),$scope.arrowArrayPostionAnchor=$scope.arrowPoint;for(index=0;index<$scope.arrowPoint.length;index++)createAnchorToArrow($scope.arrowPoint[index].x,$scope.arrowPoint[index].y,arrow,index);selectedFrame.draw(),arrow.on("mousedown touchstart",function(){somethingIsDraw=!0,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null,$scope.shiftPressed||$scope.selectedItemList.length<=0&&($scope.selectedItemList=[],selectObjStyle(this)),anchorLayer&&(anchorLayer.destroy(),anchorLayer=null),anchorLayer=new Konva.Layer,selectedFrame.add(anchorLayer),$scope.arrowArrayPostionAnchor=this.getAttr("points");for(var index=0;index<$scope.arrowArrayPostionAnchor.length;index++)createAnchorToArrow($scope.arrowArrayPostionAnchor[index].x,$scope.arrowArrayPostionAnchor[index].y,this,index);selectedFrame.draw()}),arrow.on("dragmove",function(){somethingIsDraw=!0;var offset={x:multiDragPositionStart.x-this.attrs.x,y:multiDragPositionStart.y-this.attrs.y};$scope.selectedItemList.length>0&&dragAllSelectedItem(this.getAttr("id"),offset),multiDragPositionStart={x:this.getAttr("x"),y:this.getAttr("y")};var textObj=this.getAttr("textObj"),pt=this.getAttr("points");textObj.setAttr("x",this.getAttr("x")+pt[0].x),textObj.setAttr("y",this.getAttr("y")+pt[0].y),$scope.startPointSelectShape=null,$scope.endPointSelectShape=null,anchorLayer&&(anchorLayer.destroy(),anchorLayer=null),anchorLayer=new Konva.Layer,selectedFrame.add(anchorLayer),$scope.arrowArrayPostionAnchor=this.getAttr("points");for(var index=0;index<$scope.arrowArrayPostionAnchor.length;index++)createAnchorToArrow($scope.arrowArrayPostionAnchor[index].x,$scope.arrowArrayPostionAnchor[index].y,this,index);selectedFrame.draw()}),arrow.on("click tap",function(){$scope.shiftPressed?addToMultiSelect(this):($scope.selectedItemList=[],selectObjStyle(this))}),arrow.on("dragstart",function(){multiDragPositionStart={x:this.getAttr("x"),y:this.getAttr("y")},somethingIsDraw=!0,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),arrow.on("touchstart",function(){somethingIsDraw=!0,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),arrow.on("dragend",function(){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),arrow.on("mouseup",function(){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null;var id=this.getAttr("id");for(let i=0;i<allObjectPerFrame.length;i++)for(let y=0;y<allObjectPerFrame[i].arrow.length;y++)id==allObjectPerFrame[i].arrow[y].getAttr("id")&&(allObjectPerFrame[i].arrow[y].setAttr("x",this.getAttr("x")),allObjectPerFrame[i].arrow[y].setAttr("y",this.getAttr("y")))}),arrow.on("touchend",function(){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),mainLayer.add(arrow),allObjectPerFrame[currentObjPerFrame].arrow.push(arrow);for(let z=currentObjPerFrame+1;z<allObjectPerFrame.length;z++)allObjectPerFrame[z].arrow.push(createObjFromOther(arrow));selectedFrame.find(".arrow").each(function(shape){shape.on("mouseenter",function(){$scope.actualMouseAction==$scope.mouseActionType.MOVE&&(selectedFrame.container().style.cursor="move")}),shape.on("mouseleave",function(){selectedFrame.container().style.cursor="default"})}),mainLayer.draw()}else if($scope.arrowPointCount>2){$scope.lastSelected.setAttr("points",$scope.arrowPoint),null!=anchorLayer&&(anchorLayer.destroy(),anchorLayer=null),anchorLayer=new Konva.Layer,selectedFrame.add(anchorLayer),$scope.arrowArrayPostionAnchor=$scope.lastSelected.getAttr("points");for(index=0;index<$scope.arrowArrayPostionAnchor.length;index++)createAnchorToArrow($scope.arrowArrayPostionAnchor[index].x,$scope.arrowArrayPostionAnchor[index].y,$scope.lastSelected,index);selectedFrame.draw()}}else if($scope.actualMouseAction==$scope.mouseActionType.SHAPE_ADD&&$scope.selectedShape){$scope.shapePointCount++;scale=selectedFrame.getAttr("scaleX"),mousePos=selectedFrame.getPointerPosition();$scope.shapePoint.push({x:mousePos.x/scale,y:mousePos.y/scale});countLimit=0;var fillColor="#ffffff",strokeColor="#ffffff";switch($scope.selectedShape){case $scope.shapeType.WHITE_3:countLimit=3,fillColor="rgba(255,255,255,0.4)",strokeColor="rgba(255,255,255,1)";break;case $scope.shapeType.WHITE_4:countLimit=4,fillColor="rgba(255,255,255,0.4)",strokeColor="rgba(255,255,255,1)";break;case $scope.shapeType.WHITE_5:countLimit=5,fillColor="rgba(255,255,255,0.4)",strokeColor="rgba(255,255,255,1)";break;case $scope.shapeType.GREY_3:countLimit=3,fillColor="rgba(217,217,217,0.4)",strokeColor="rgba(217,217,217,1)";break;case $scope.shapeType.GREY_4:countLimit=4,fillColor="rgba(217,217,217,0.4)",strokeColor="rgba(217,217,217,1)";break;case $scope.shapeType.GREY_5:countLimit=5,fillColor="rgba(217,217,217,0.4)",strokeColor="rgba(217,217,217,1)";break;case $scope.shapeType.BLUE_3:countLimit=3,fillColor="rgba(0, 126, 255,0.4)",strokeColor="rgba(0, 126, 255,1)";break;case $scope.shapeType.BLUE_4:countLimit=4,fillColor="rgba(0, 126, 255,0.4)",strokeColor="rgba(0, 126, 255,1)";break;case $scope.shapeType.BLUE_5:countLimit=5,fillColor="rgba(0, 126, 255,0.4)",strokeColor="rgba(0, 126, 255,1)";break;case $scope.shapeType.PURPLE_3:countLimit=3,fillColor="rgba(144, 0, 255,0.4)",strokeColor="rgba(144, 0, 255,1)";break;case $scope.shapeType.PURPLE_4:countLimit=4,fillColor="rgba(144, 0, 255,0.4)",strokeColor="rgba(144, 0, 255,1)";break;case $scope.shapeType.PURPLE_5:countLimit=5,fillColor="rgba(144, 0, 255,0.4)",strokeColor="rgba(144, 0, 255,1)";break;case $scope.shapeType.ORANGE_3:countLimit=3,fillColor="rgba(255, 204, 0,0.4)",strokeColor="rgba(255, 204, 0,1)";break;case $scope.shapeType.ORANGE_4:countLimit=4,fillColor="rgba(255, 204, 0,0.4)",strokeColor="rgba(255, 204, 0,1)";break;case $scope.shapeType.ORANGE_5:countLimit=5,fillColor="rgba(255, 204, 0,0.4)",strokeColor="rgba(255, 204, 0,1)";break;case $scope.shapeType.RED_3:countLimit=3,fillColor="rgba(247, 49, 3,0.4)",strokeColor="rgba(247, 49, 3,1)";break;case $scope.shapeType.RED_4:countLimit=4,fillColor="rgba(247, 49, 3,0.4)",strokeColor="rgba(247, 49, 3,1)";break;case $scope.shapeType.RED_5:countLimit=5,fillColor="rgba(247, 49, 3,0.4)",strokeColor="rgba(247, 49, 3,1)"}if($scope.shapePointCount>=countLimit){var shapPointArr=$scope.shapePoint,triangle=(id=newId(),new Konva.Shape({arrowPoint:shapPointArr,sceneFunc:function(context){context.beginPath(),context.moveTo(shapPointArr[0].x,shapPointArr[0].y);for(var i=1;i<shapPointArr.length;i++)context.lineTo(shapPointArr[i].x,shapPointArr[i].y);context.closePath(),context.fillStrokeShape(this)},draggable:!0,name:"shapes",fill:fillColor,stroke:strokeColor,strokeWidth:2,id,textObj:null,config:$.extend(!0,{},$scope.selectedObjConfig)}));selectObjStyle(triangle);complexText=createTextB(shapPointArr[0].x,shapPointArr[0].y,$scope.selectedObjConfig&&$scope.selectedObjConfig.text?$scope.selectedObjConfig.text:"");mainLayer.add(complexText),shapPointArr[0].y<shapPointArr[1].y?complexText.setAttr("offsetY",50):complexText.setAttr("offsetY",10),triangle.setAttr("textObj",complexText),mainLayer.add(triangle),null!=anchorLayer&&(anchorLayer.destroy(),anchorLayer=null),anchorLayer=new Konva.Layer,selectedFrame.add(anchorLayer),$scope.shapeArrayPostionAnchor=$scope.shapePoint;for(index=0;index<$scope.shapePoint.length;index++)createAnchorToShape($scope.shapePoint[index].x,$scope.shapePoint[index].y,triangle,index);triangle.on("mousedown touchstart",function(){somethingIsDraw=!0,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null,$scope.shiftPressed||$scope.selectedItemList.length<=0&&($scope.selectedItemList=[],selectObjStyle(this)),null!=anchorLayer&&(anchorLayer.destroy(),anchorLayer=null),anchorLayer=new Konva.Layer,selectedFrame.add(anchorLayer),$scope.shapeArrayPostionAnchor=this.getAttr("arrowPoint");for(var index=0;index<$scope.shapeArrayPostionAnchor.length;index++)createAnchorToShape($scope.shapeArrayPostionAnchor[index].x,$scope.shapeArrayPostionAnchor[index].y,this,index);selectedFrame.draw()}),triangle.on("dragmove",function(){somethingIsDraw=!0;var offset={x:multiDragPositionStart.x-this.attrs.x,y:multiDragPositionStart.y-this.attrs.y};$scope.selectedItemList.length>0&&dragAllSelectedItem(this.getAttr("id"),offset),multiDragPositionStart={x:this.getAttr("x"),y:this.getAttr("y")};var textObj=this.getAttr("textObj"),pt=this.getAttr("arrowPoint");textObj.setAttr("x",this.getAttr("x")+pt[0].x),textObj.setAttr("y",this.getAttr("y")+pt[0].y),$scope.startPointSelectShape=null,$scope.endPointSelectShape=null,null!=anchorLayer&&(anchorLayer.destroy(),anchorLayer=null),anchorLayer=new Konva.Layer,selectedFrame.add(anchorLayer),$scope.shapeArrayPostionAnchor=this.getAttr("arrowPoint");for(var index=0;index<$scope.shapeArrayPostionAnchor.length;index++)createAnchorToShape($scope.shapeArrayPostionAnchor[index].x,$scope.shapeArrayPostionAnchor[index].y,this,index);selectedFrame.draw()}),triangle.on("click tap",function(){$scope.shiftPressed?addToMultiSelect(this):($scope.selectedItemList=[],selectObjStyle(this))}),triangle.on("dragstart",function(){multiDragPositionStart={x:this.getAttr("x"),y:this.getAttr("y")},somethingIsDraw=!0,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),triangle.on("touchstart",function(){somethingIsDraw=!0,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),triangle.on("dragend",function(){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null;var id=this.getAttr("id");for(let i=0;i<allObjectPerFrame.length;i++)for(let y=0;y<allObjectPerFrame[i].shapes.length;y++)id==allObjectPerFrame[i].shapes[y].getAttr("id")&&(allObjectPerFrame[i].shapes[y].setAttr("x",this.getAttr("x")),allObjectPerFrame[i].shapes[y].setAttr("y",this.getAttr("y")))}),triangle.on("mouseup",function(){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),triangle.on("touchend",function(){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),allObjectPerFrame[currentObjPerFrame].shapes.push(triangle);for(let z=currentObjPerFrame+1;z<allObjectPerFrame.length;z++)allObjectPerFrame[z].triangle.push(createObjFromOther(triangle));selectedFrame.find(".shapes").each(function(shape){shape.on("mouseenter",function(){$scope.actualMouseAction==$scope.mouseActionType.MOVE&&(selectedFrame.container().style.cursor="move")}),shape.on("mouseleave",function(){selectedFrame.container().style.cursor="default"})}),$scope.$apply(function(){$scope.changeCategories($scope.mouseActionType.MOVE)}),$scope.shapePointCount=0,$scope.shapePoint=[],anchorLayer.draw(),mainLayer.draw(),mainLayer.draw()}}else if($scope.actualMouseAction==$scope.mouseActionType.TEXT_ADD){null!=anchorLayer&&(anchorLayer.destroy(),anchorLayer=null),anchorLayer=new Konva.Layer,selectedFrame.add(anchorLayer);var obj;mousePos=selectedFrame.getPointerPosition(),scale=selectedFrame.getAttr("scaleX"),id=newId();selectObjStyle(obj=new Konva.Text({x:mousePos.x/scale,y:mousePos.y/scale,offsetX:140,offsetY:20,text:"Kliknij dwa razy, aby edytować",fontSize:20,fill:"white",align:"center",name:"movementObject",id})),mainLayer.add(obj),selectedFrame.draw(),obj.on("dblclick",function(){var textPosition=obj.getAbsolutePosition(),stageBox=selectedFrame.getContainer().getBoundingClientRect(),areaPosition_x=textPosition.x+stageBox.left,areaPosition_y=textPosition.y+stageBox.top,textarea=document.createElement("textarea");textarea.className="textToEditInCv",document.body.appendChild(textarea),textarea.value=obj.text(),textarea.style.position="absolute",textarea.style.top=areaPosition_y+5+"px",textarea.style.left=areaPosition_x-100+"px",textarea.style.zIndex="300",textarea.style.width="200px",textarea.style.color="white",textarea.style.backogrund="rgba(0, 0, 0, 0.34)",textarea.focus(),$(document).off("keydown",".textToEditInCv"),$(document).on("keydown",".textToEditInCv",function(e){13===e.keyCode&&(obj.text(textarea.value),selectedFrame.draw(),document.body.removeChild(textarea))})}),allObjectPerFrame[currentObjPerFrame].text.push(obj);for(let z=currentObjPerFrame+1;z<allObjectPerFrame.length;z++)allObjectPerFrame[z].text.push(createObjFromOther(text));$scope.$apply(function(){$scope.changeCategories($scope.mouseActionType.MOVE)})}}function createArrowObjFromOther(other,isNoObj=!1){var arrow;if(isNoObj){complexText=new Konva.Text({x:other.attrs.points[0].x,y:other.attrs.points[0].y,offsetX:100,offsetY:other.attrs.offsetY,text:other.attrs.config&&other.attrs.config.text?other.attrs.config.text:"",fontSize:18,fontFamily:"Calibri",fill:"#fff",padding:20,align:"center"});other.attrs.points[1]<other.attrs.points[3]?complexText.setAttr("offsetY",50):complexText.setAttr("offsetY",10),arrow=new Konva.Shape({x:other.attrs.x,y:other.attrs.y,points:other.attrs.points,stroke:other.attrs.stroke,strokeWidth:other.attrs.strokeWidth,sceneFunc:function(context){drawArrowStyle(context,this)},id:other.attrs.id,draggable:!0,textObj:complexText,name:"arrow",config:other.attrs.config})}else{var lastText=other.getAttr("textObj"),complexText=new Konva.Text({x:lastText.getAttr("x"),y:lastText.getAttr("y"),offsetX:lastText.getAttr("offsetX"),offsetY:lastText.getAttr("offsetY"),text:lastText.getAttr("text"),fontSize:lastText.getAttr("fontSize"),fontFamily:"Calibri",fill:lastText.getAttr("fill"),padding:20,width:200,align:"center"});other.getAttr("points")[1]<other.getAttr("points")[3]?complexText.setAttr("offsetY",50):complexText.setAttr("offsetY",10),arrow=new Konva.Shape({x:other.getAttr("x"),y:other.getAttr("y"),points:other.getAttr("points"),stroke:other.getAttr("stroke"),strokeWidth:other.getAttr("strokeWidth"),sceneFunc:function(context){drawArrowStyle(context,this)},id:other.getAttr("id"),textObj:complexText,draggable:!0,name:"arrow",config:other.getAttr("config")})}return mainLayer&&mainLayer.add(complexText),arrow.off("mousedown touchstart"),arrow.on("mousedown touchstart",function(){somethingIsDraw=!0,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null,$scope.shiftPressed||$scope.selectedItemList.length<=0&&($scope.selectedItemList=[],selectObjStyle(this)),null!=anchorLayer&&(anchorLayer.destroy(),anchorLayer=null),anchorLayer=new Konva.Layer,selectedFrame.add(anchorLayer),$scope.arrowArrayPostionAnchor=arrow.getAttr("points");for(var index=0;index<$scope.arrowArrayPostionAnchor.length;index++)createAnchorToArrow($scope.arrowArrayPostionAnchor[index].x,$scope.arrowArrayPostionAnchor[index].y,arrow,index);selectedFrame.draw()}),arrow.off("click tap"),arrow.on("click tap",function(){$scope.shiftPressed?addToMultiSelect(this):($scope.selectedItemList=[],selectObjStyle(this))}),arrow.off("dragmove"),arrow.on("dragmove",function(){somethingIsDraw=!0;var offset={x:multiDragPositionStart.x-this.attrs.x,y:multiDragPositionStart.y-this.attrs.y};$scope.selectedItemList.length>0&&dragAllSelectedItem(this.getAttr("id"),offset),multiDragPositionStart={x:this.getAttr("x"),y:this.getAttr("y")};var textObj=this.getAttr("textObj"),pt=this.getAttr("points");textObj.setAttr("x",this.getAttr("x")+pt[0].x),textObj.setAttr("y",this.getAttr("y")+pt[0].y),$scope.startPointSelectShape=null,$scope.endPointSelectShape=null,anchorLayer&&(anchorLayer.destroy(),anchorLayer=null),anchorLayer=new Konva.Layer,selectedFrame.add(anchorLayer),$scope.arrowArrayPostionAnchor=this.getAttr("points");for(var index=0;index<$scope.arrowArrayPostionAnchor.length;index++)createAnchorToArrow($scope.arrowArrayPostionAnchor[index].x,$scope.arrowArrayPostionAnchor[index].y,this,index);selectedFrame.draw()}),arrow.off("dragstart"),arrow.off("touchstart"),arrow.off("mouseup"),arrow.off("touchend"),arrow.off("dragend"),arrow.on("dragstart",function(){multiDragPositionStart={x:this.getAttr("x"),y:this.getAttr("y")},somethingIsDraw=!0,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),arrow.on("touchstart",function(){somethingIsDraw=!0,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),arrow.on("dragend",function(){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null;var id=this.getAttr("id");for(let i=0;i<allObjectPerFrame.length;i++)for(let y=0;y<allObjectPerFrame[i].arrow.length;y++)id==allObjectPerFrame[i].arrow[y].getAttr("id")&&(allObjectPerFrame[i].arrow[y].setAttr("x",this.getAttr("x")),allObjectPerFrame[i].arrow[y].setAttr("y",this.getAttr("y")))}),arrow.on("mouseup",function(){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),arrow.on("touchend",function(){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),arrow.hitFunc(function(context){drawArrowStyle(context,this,!0)}),arrow}function createObjFromOther(other,isNoObj=!1){var obj;if(isNoObj){var newImg=new Image;newImg.src=other.attrs.image;complexText=new Konva.Text({x:other.attrs.x,y:other.attrs.y+other.attrs.height/4,offsetX:100,offsetX:other.attrs.offsetX,offsetY:other.attrs.offsetY,text:other.attrs.config&&other.attrs.config.text?other.attrs.config.text:"",fontSize:other.attrs.config&&other.attrs.config.selectedTextSize?other.attrs.config.selectedTextSize:17,fontFamily:"Calibri",fill:other.attrs.config&&other.attrs.config.selectedColorText?other.attrs.config.selectedColorText:"rgb(255,255,255)",padding:20,listening:!1,align:"center"});obj=new Konva.Image({x:other.attrs.x,y:other.attrs.y,offsetX:other.attrs.offsetX,offsetY:other.attrs.offsetY,rotation:other.attrs.rotation,image:newImg,scale:{x:other.attrs.scaleX,y:other.attrs.scaleY},name:other.attrs.name,id:other.attrs.id,config:other.attrs.config,textObj:complexText})}else{var lastText=other.getAttr("textObj"),complexText=new Konva.Text({x:lastText.getAttr("x"),y:lastText.getAttr("y"),offsetX:lastText.getAttr("offsetX"),offsetY:lastText.getAttr("offsetY"),text:lastText.getAttr("text"),fontSize:lastText.getAttr("fontSize"),fontFamily:"Calibri",fill:lastText.getAttr("fill"),padding:20,width:200,align:"center"});obj=new Konva.Image({x:other.getAttr("x"),y:other.getAttr("y"),offsetX:other.getAttr("offsetX"),offsetY:other.getAttr("offsetY"),rotation:other.getAttr("rotation"),image:other.getAttr("image"),name:other.getAttr("name"),scale:other.getAttr("scale"),id:other.getAttr("id"),config:other.getAttr("config"),textObj:complexText})}return mainLayer&&mainLayer.add(complexText),obj.stroke("transparent"),obj.strokeWidth(1),obj.off("mousedown touchstart"),obj.on("mousedown touchstart",function(){somethingIsDraw=!0,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null,$scope.shiftPressed||$scope.selectedItemList.length<=0&&($scope.selectedItemList=[],selectObjStyle(this),drawBeforePositionPoint(),updateNextFrameBeforePosition(),$scope.turnOnRotation&&rotateObject())}),obj.hitFunc(function(context){context.beginPath();var width=this.getWidth()*this.scaleX(),height=this.getHeight()*this.scaleX();context.rect(-15,-15,width+30,height+30),context.closePath(),context.fillStrokeShape(this)}),obj.off("click tap"),obj.on("click tap",function(){$scope.shiftPressed?addToMultiSelect(this):($scope.selectedItemList=[],selectObjStyle(this))}),obj.off("dragmove"),obj.on("dragmove",function(){var offset={x:multiDragPositionStart.x-this.attrs.x,y:multiDragPositionStart.y-this.attrs.y};$scope.selectedItemList.length>0&&dragAllSelectedItem(this.getAttr("id"),offset),multiDragPositionStart={x:this.getAttr("x"),y:this.getAttr("y")};var txtObj=obj.getAttr("textObj");txtObj.setAttr("x",obj.getAttr("x")),txtObj.setAttr("y",obj.getAttr("y")+obj.height()/2),obj.setAttr("textObj",txtObj),mainLayer.draw()}),obj.off("dragstart"),obj.off("touchstart"),obj.off("mouseup"),obj.off("touchend"),obj.off("dragend"),obj.on("dragstart",function(){multiDragPositionStart={x:this.getAttr("x"),y:this.getAttr("y")},somethingIsDraw=!0,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),obj.on("touchstart",function(){somethingIsDraw=!0,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),obj.on("mouseup",function(){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),obj.on("touchend",function(){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),obj.on("dragend",function(){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null,$scope.selectedItemList.length<=1&&(drawBeforePositionPoint(),updateNextFrameBeforePosition(),$scope.turnOnRotation&&rotateObject())}),obj}function createShapeObjFromOther(other,isNoObj=!1){var shape;if(isNoObj){complexText=new Konva.Text({x:other.attrs.arrowPoint[0].x,y:other.attrs.arrowPoint[0].y,offsetX:100,offsetY:other.attrs.offsetY,text:other.attrs.config&&other.attrs.config.text?other.attrs.config.text:"",fontSize:18,fontFamily:"Calibri",fill:"#fff",padding:20,listening:!1,align:"center"});other.attrs.arrowPoint[0].y<other.attrs.arrowPoint[1].y?complexText.setAttr("offsetY",50):complexText.setAttr("offsetY",10),shape=new Konva.Shape({x:other.attrs.x,y:other.attrs.y,arrowPoint:other.attrs.arrowPoint,sceneFunc:function(context){context.beginPath(),context.moveTo(other.attrs.arrowPoint[0].x,other.attrs.arrowPoint[0].y);for(var i=1;i<other.attrs.arrowPoint.length;i++)context.lineTo(other.attrs.arrowPoint[i].x,other.attrs.arrowPoint[i].y);context.closePath(),context.fillStrokeShape(this)},name:other.attrs.name,fill:other.attrs.fill,draggable:!0,stroke:other.attrs.stroke,scale:{x:other.attrs.scaleX,y:other.attrs.scaleY},strokeWidth:other.attrs.strokeWidth,id:other.attrs.id,config:other.attrs.config,textObj:complexText})}else{var lastText=other.getAttr("textObj"),complexText=new Konva.Text({x:lastText.getAttr("x"),y:lastText.getAttr("y"),offsetX:lastText.getAttr("offsetX"),offsetY:lastText.getAttr("offsetY"),text:lastText.getAttr("text"),fontSize:lastText.getAttr("fontSize"),fontFamily:"Calibri",fill:lastText.getAttr("fill"),padding:20,width:200,align:"center"});other.getAttr("arrowPoint")[0].y<other.getAttr("arrowPoint")[1].y?complexText.setAttr("offsetY",50):complexText.setAttr("offsetY",10),shape=new Konva.Shape({x:other.getAttr("x"),y:other.getAttr("y"),arrowPoint:other.getAttr("arrowPoint"),sceneFunc:function(context){context.beginPath(),context.moveTo(other.getAttr("arrowPoint")[0].x,other.getAttr("arrowPoint")[0].y);for(var i=1;i<other.getAttr("arrowPoint").length;i++)context.lineTo(other.getAttr("arrowPoint")[i].x,other.getAttr("arrowPoint")[i].y);context.closePath(),context.fillStrokeShape(this)},name:other.getAttr("name"),fill:other.getAttr("fill"),stroke:other.getAttr("stroke"),scale:other.getAttr("scale"),strokeWidth:other.getAttr("strokeWidth"),id:other.getAttr("id"),config:other.getAttr("config"),draggable:!0,textObj:complexText})}return mainLayer&&mainLayer.add(complexText),shape.off("click tap"),shape.on("click tap",function(){$scope.shiftPressed?addToMultiSelect(this):($scope.selectedItemList=[],selectObjStyle(this))}),shape.off("mousedown touchstart"),shape.on("mousedown touchstart",function(){somethingIsDraw=!0,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null,$scope.shiftPressed||$scope.selectedItemList.length<=0&&($scope.selectedItemList=[],selectObjStyle(this)),null!=anchorLayer&&(anchorLayer.destroy(),anchorLayer=null),anchorLayer=new Konva.Layer,selectedFrame.add(anchorLayer),$scope.shapeArrayPostionAnchor=this.getAttr("arrowPoint");for(var index=0;index<$scope.shapeArrayPostionAnchor.length;index++)createAnchorToShape($scope.shapeArrayPostionAnchor[index].x,$scope.shapeArrayPostionAnchor[index].y,this,index);selectedFrame.draw()}),shape.off("dragmove"),shape.on("dragmove",function(){var offset={x:multiDragPositionStart.x-this.attrs.x,y:multiDragPositionStart.y-this.attrs.y};$scope.selectedItemList.length>0&&dragAllSelectedItem(this.getAttr("id"),offset),multiDragPositionStart={x:this.getAttr("x"),y:this.getAttr("y")};var textObj=this.getAttr("textObj"),pt=this.getAttr("arrowPoint");textObj.setAttr("x",this.getAttr("x")+pt[0].x),textObj.setAttr("y",this.getAttr("y")+pt[0].y),somethingIsDraw=!0,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null,null!=anchorLayer&&(anchorLayer.destroy(),anchorLayer=null),anchorLayer=new Konva.Layer,selectedFrame.add(anchorLayer),$scope.shapeArrayPostionAnchor=this.getAttr("arrowPoint");for(var index=0;index<$scope.shapeArrayPostionAnchor.length;index++)createAnchorToShape($scope.shapeArrayPostionAnchor[index].x,$scope.shapeArrayPostionAnchor[index].y,this,index);selectedFrame.draw()}),shape.off("dragstart"),shape.off("touchstart"),shape.off("mouseup"),shape.off("touchend"),shape.off("dragend"),shape.on("dragstart",function(){multiDragPositionStart={x:this.getAttr("x"),y:this.getAttr("y")},somethingIsDraw=!0,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),shape.on("touchstart",function(){somethingIsDraw=!0,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),shape.on("dragend",function(){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null;var id=this.getAttr("id");for(let i=0;i<allObjectPerFrame.length;i++)for(let y=0;y<allObjectPerFrame[i].shapes.length;y++)id==allObjectPerFrame[i].shapes[y].getAttr("id")&&(allObjectPerFrame[i].shapes[y].setAttr("x",this.getAttr("x")),allObjectPerFrame[i].shapes[y].setAttr("y",this.getAttr("y")))}),shape.on("mouseup",function(){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),shape.on("touchend",function(){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),shape}function createTextFromOther(other,isNoObj=!1){var obj;return(obj=isNoObj?new Konva.Text({x:other.attrs.x,y:other.attrs.y,offsetX:other.attrs.offsetX,offsetY:other.attrs.offsetY,rotation:other.attrs.rotation,fontSize:other.attrs.fontSize,text:other.attrs.text,fill:other.attrs.fill,align:other.attrs.align,scale:{x:other.attrs.scaleX,y:other.attrs.scaleY},name:other.attrs.name,id:other.attrs.id,config:other.attrs.config}):new Konva.Text({x:other.getAttr("x"),y:other.getAttr("y"),offsetX:other.getAttr("offsetX"),offsetY:other.getAttr("offsetY"),rotation:other.getAttr("rotation"),fontSize:other.getAttr("fontSize"),text:other.getAttr("text"),name:other.getAttr("name"),scale:other.getAttr("scale"),fill:other.getAttr("fill"),align:other.getAttr("align"),id:other.getAttr("id"),config:other.getAttr("config")})).off("mousedown touchstart"),obj.on("mousedown touchstart",function(){selectObjStyle(this)}),selectObjStyle(obj),obj.off("dblclick"),obj.on("dblclick",()=>{var textPosition=obj.getAbsolutePosition(),stageBox=selectedFrame.getContainer().getBoundingClientRect(),areaPosition_x=textPosition.x+stageBox.left,areaPosition_y=textPosition.y+stageBox.top,textarea=document.createElement("textarea");document.body.appendChild(textarea),textarea.value=obj.text(),textarea.style.position="absolute",textarea.style.top=areaPosition_y+5+"px",textarea.style.left=areaPosition_x-100+"px",textarea.style.zIndex="300",textarea.style.width="200px",textarea.style.color="white",textarea.style.backogrund="rgba(0, 0, 0, 0.34)",textarea.focus(),textarea.addEventListener("keydown",function(e){13===e.keyCode&&(obj.text(textarea.value),selectedFrame.draw(),document.body.removeChild(textarea))})}),obj}function changeFrame(count,frameContener=allObjectPerFrame){currentObjPerFrame=count,updateNextFrameBeforePosition(frameContener),$(".timeElement").each(function(){$(this).css("border-color","")}),$(".timeElement").eq(count).css("border-color","#dd4213")}function updateNextFrameBeforePosition(frameContener=allObjectPerFrame){if(frameContener==allObjectPerFrame)for(var i=0;i<frameContener[currentObjPerFrame].obj.length;i++){var objBef=frameContener[currentObjPerFrame].obj[i],objId=objBef.getAttr("id");isAnchorHistoryFor(currentObjPerFrame+1,objId)&&(getAnchorHistoryFor(currentObjPerFrame+1,objId).start={x:objBef.getAttr("x"),y:objBef.getAttr("y")})}}function isAnchorHistoryFor(frame,id){for(var i=0;i<anchorHistory.length;i++)if(anchorHistory[i].frame==frame){for(var x=0;x<anchorHistory[i].history.length;x++)if(anchorHistory[i].history[x].id==id)return!0;return!1}return!1}function getAnchorHistoryFor(frame,id){for(var i=0;i<anchorHistory.length;i++)if(anchorHistory[i].frame==frame)for(var x=0;x<anchorHistory[i].history.length;x++)if(anchorHistory[i].history[x].id==id)return anchorHistory[i].history[x].anchor}function deleteAnchor(frame,id){for(var i=0;i<anchorHistory.length;i++)if(anchorHistory[i].frame==frame)for(var x=0;x<anchorHistory[i].history.length;x++)if(anchorHistory[i].history[x].id==id)return anchorHistory[i].history[x].id=null,anchorHistory[i].history[x].anchor=null,void anchorHistory[i].history.splice(x,1)}function drawNewStage(container="canvasContainer",frameContainer=allObjectPerFrame){$scope.selectedItemList=[],$scope.onlyPlayer&&(container="canvasPlayerContainer"),null!=mainLayer&&(selectedFrame.off("contentClick contentTap"),selectedFrame.destroy(),selectedFrame=null),selectedFrame=new Konva.Stage({container,width:stageWidth,height:stageHeight}),null!=curveLayer&&(curveLayer.destroy(),curveLayer=null),curveLayer=new Konva.Layer,null!=lineLayer&&(lineLayer.destroy(),lineLayer=null),lineLayer=new Konva.Layer,null!=anchorLayer&&(anchorLayer.destroy(),anchorLayer=null),anchorLayer=new Konva.Layer,null!=mainLayer&&(mainLayer.destroy(),mainLayer=null),mainLayer=new Konva.Layer,null!=fieldLayer&&(fieldLayer.destroy(),fieldLayer=null),fieldLayer=new Konva.Layer;var conImg=new Konva.Image({x:0,y:0,image:$scope.fieldImage,width:selectedFrame.getWidth(),height:selectedFrame.getHeight(),id:"field"});mainLayer.add(conImg);for(var i=0;i<frameContainer[currentObjPerFrame].shapes.length;i++){var obj=createShapeObjFromOther(frameContainer[currentObjPerFrame].shapes[i]);frameContainer[currentObjPerFrame].shapes[i]=obj,mainLayer.add(obj)}for(i=0;i<frameContainer[currentObjPerFrame].obj.length;i++){obj=createObjFromOther(frameContainer[currentObjPerFrame].obj[i]);frameContainer[currentObjPerFrame].obj[i]=obj,mainLayer.add(frameContainer[currentObjPerFrame].obj[i])}for(i=0;i<frameContainer[currentObjPerFrame].arrow.length;i++){obj=createArrowObjFromOther(frameContainer[currentObjPerFrame].arrow[i]);frameContainer[currentObjPerFrame].arrow[i]=obj,mainLayer.add(obj)}for(i=0;i<frameContainer[currentObjPerFrame].text.length;i++){obj=createTextFromOther(frameContainer[currentObjPerFrame].text[i]);frameContainer[currentObjPerFrame].text[i]=obj,mainLayer.add(obj)}(selectedFrame.add(mainLayer),$scope.selectedObjImg=null,$scope.selectedArrow=null,$scope.arrowPointCount=0,$scope.arrowPoint=[],$scope.shapePointCount=0,$scope.shapePoint=[],$scope.lastSelected=null,$scope.actualMouseAction=$scope.mouseActionType.MOVE,$(".categories").each(function(){$(this).css("border-color","")}),$(".categories").eq(0).css("border-color","#dd4213"),"canvasContainer"==container)&&(selectedFrame.add(lineLayer),selectedFrame.add(curveLayer),selectedFrame.add(anchorLayer),selectedFrame.on("contentClick contentTap",function(e){clickOnContent()}),selectedFrame.on("mousedown touchstart",function(e){onMuseDown()}),selectedFrame.on("mousemove touchmove",function(e){onMuseMove()}),selectedFrame.on("mouseup touchend",function(e){onMuseUp()}),selectedFrame.find(".movementObject").each(function(shape){shape.on("mouseenter",function(){$scope.actualMouseAction==$scope.mouseActionType.MOVE&&(selectedFrame.container().style.cursor="move")}),shape.on("mouseleave",function(){selectedFrame.container().style.cursor="default"})}),selectedFrame.find(".arrow").each(function(shape){shape.on("mouseenter",function(){$scope.actualMouseAction==$scope.mouseActionType.MOVE&&(selectedFrame.container().style.cursor="move")}),shape.on("mouseleave",function(){selectedFrame.container().style.cursor="default"})}),selectedFrame.find(".shapes").each(function(shape){shape.on("mouseenter",function(){$scope.actualMouseAction==$scope.mouseActionType.MOVE&&(selectedFrame.container().style.cursor="move")}),shape.on("mouseleave",function(){selectedFrame.container().style.cursor="default"})}),selectedFrame.find(".movementObject").each(function(shape){shape.draggable(!0)}));!function(){if($scope.turnOnHelperNet){for(var helperLayer=new Konva.Layer,canvasWidth=selectedFrame.getAttr("width"),canvasHeight=selectedFrame.getAttr("height"),pos=canvasWidth/16;pos<canvasWidth;){var whiteLine=new Konva.Line({points:[pos,0,pos,canvasHeight],stroke:"white",strokeWidth:1,lineCap:"round",lineJoin:"round"});helperLayer.add(whiteLine),pos+=canvasWidth/16}for(pos=canvasHeight/10;pos<canvasHeight;){var whiteLine=new Konva.Line({points:[0,pos,canvasWidth,pos],stroke:"white",strokeWidth:1,lineCap:"round",lineJoin:"round"});helperLayer.add(whiteLine),pos+=canvasHeight/10}selectedFrame.add(helperLayer)}}(),resize()}function resize(){var container=isPlayerOpen||$scope.onlyPlayer?"canvasPlayerContainer":"canvasContainer";if($scope.onlyPlayer&&(container="canvasPlayerContainer"),container=document.querySelector("#"+container)){var containerWidth=container.offsetWidth;if($scope.orientation=$(window).width()>$(window).height()?"sd":"landscape","sd"==$scope.orientation&&isPlayerOpen)containerWidth=100*container.offsetHeight/60;var scale=containerWidth/stageWidth;selectedFrame.width(stageWidth*scale),selectedFrame.height(stageHeight*scale),selectedFrame.scale({x:scale,y:scale}),selectedFrame.draw()}}function drawBeforePositionPointAllVersion(itemToDrawBef){if(!(currentObjPerFrame<=0||null==itemToDrawBef||"movementObject"!==itemToDrawBef.getAttr("name"))){for(var id=itemToDrawBef.getAttr("id"),lastObj=null,i=0;i<allObjectPerFrame[currentObjPerFrame-1].obj.length;i++){if(allObjectPerFrame[currentObjPerFrame-1].obj[i].getAttr("id")==id){lastObj=allObjectPerFrame[currentObjPerFrame-1].obj[i];break}}if(lineLayer&&lineLayer.destroy(),anchorLayer&&anchorLayer.destroy(),anchorLayer&&curveLayer.destroy(),anchorLayer=new Konva.Layer,curveLayer=new Konva.Layer,selectedFrame.add(curveLayer),selectedFrame.add(anchorLayer),anchorLayer.off("beforeDraw"),anchorLayer.on("beforeDraw",function(){drawCurves(),updateDottedLines()}),null!==lastObj){var quadLine=new Konva.Line({dash:[10,10,0,10],strokeWidth:3,stroke:"black",lineCap:"round",id:"quadLine",opacity:.3,points:[0,0]});if(anchorLayer.add(quadLine),isAnchorHistoryFor(currentObjPerFrame,id)){var history=getAnchorHistoryFor(currentObjPerFrame,id),newo={x:itemToDrawBef.getAttr("x"),y:itemToDrawBef.getAttr("y")};quadCurves={start:createAnchorPoint(history.start.x,history.start.y,"start"),control:createAnchorPoint(history.control.x,history.control.y,"ster"),end:createAnchorPoint(newo.x,newo.y,"end")}}else{var last={x:lastObj.getAttr("x"),y:lastObj.getAttr("y")};newo={x:itemToDrawBef.getAttr("x"),y:itemToDrawBef.getAttr("y")};quadCurves={start:createAnchorPoint(last.x,last.y,"start"),control:createAnchorPoint(Math.min(last.x,newo.x)+Math.abs(last.x-newo.x)/2,Math.min(last.y,newo.y)+Math.abs(last.y-newo.y)/2,"ster"),end:createAnchorPoint(newo.x,newo.y,"end")}}if(saveAnchorPoint(currentObjPerFrame,itemToDrawBef,quadCurves),quadCurves.start.getAttr("x")==quadCurves.end.getAttr("x")&&quadCurves.start.getAttr("y")==quadCurves.end.getAttr("y"))return;$scope.turnOnRotation&&rotateObject(),selectedFrame.draw()}else quadCurves=null}}function drawBeforePositionPoint(){if($scope.selectedItemList.length>0)for(let d=0;d<$scope.selectedItemList.length;d++)drawBeforePositionPointAllVersion($scope.selectedItemList[d]);else drawBeforePositionPointAllVersion($scope.lastSelected)}function createAnchorPoint(x,y,type){var anchor=new Konva.Circle({x,y,radius:"end"==type||"start"==type?5:8,stroke:"ster"==type?"#ddd":"#dd4213",fill:"ster"==type?"#dda613":"#dd4213",strokeWidth:1,visible:"ster"==type||"start"==type,draggable:"ster"==type});return anchor.on("mouseover touchstart",function(){"ster"==type&&(document.body.style.cursor="pointer",this.setStrokeWidth(3),anchorLayer.draw())}),anchor.on("mouseout touchend",function(){"ster"==type&&(document.body.style.cursor="default",this.setStrokeWidth(1),anchorLayer.draw())}),anchor.on("dragend",function(){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null,"ster"==type&&(saveAnchorPoint(),drawCurves(),updateDottedLines(),$scope.turnOnRotation&&rotateObject())}),anchor.on("dragstart",function(){somethingIsDraw=!0,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),anchor.on("touchstart",function(){somethingIsDraw=!0,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),anchor.on("mouseup",function(){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),anchor.on("touchend",function(){somethingIsDraw=!1,$scope.startPointSelectShape=null,$scope.endPointSelectShape=null}),anchorLayer.add(anchor),anchor}function drawCurves(){if(quadCurves&&$scope.selectedItemList.length<=1){var context=curveLayer.getContext();context.clear(),context.beginPath();var scale=selectedFrame.getAttr("scaleX");context.moveTo(quadCurves.start.getAttr("x")*scale,quadCurves.start.getAttr("y")*scale),context.quadraticCurveTo(quadCurves.control.getAttr("x")*scale,quadCurves.control.getAttr("y")*scale,quadCurves.end.getAttr("x")*scale,quadCurves.end.getAttr("y")*scale),context.setAttr("strokeStyle","black"),context.setAttr("lineWidth",2),context.stroke(),context.setAttr("strokeStyle","white")}}function updateDottedLines(){if(quadCurves){var q=quadCurves;if(!(anchorLayer&&anchorLayer.get("#quadLine").length>0))return;anchorLayer.get("#quadLine")[0].setPoints([q.start.attrs.x,q.start.attrs.y,q.control.attrs.x,q.control.attrs.y,q.end.attrs.x,q.end.attrs.y])}}function saveAnchorPoint(currentFrame=null,element=null,quadCurv=null){if($scope.lastSelected||element){var quadCurvess=quadCurv||quadCurves,el=element||$scope.lastSelected;if(el&&(quadCurvess.start.getAttr("x")!=quadCurvess.end.getAttr("x")||quadCurvess.start.getAttr("y")!=quadCurvess.end.getAttr("y"))){var anchorToSave={start:{x:quadCurvess.start.getAttr("x"),y:quadCurvess.start.getAttr("y")},control:{x:quadCurvess.control.getAttr("x"),y:quadCurvess.control.getAttr("y")},end:{x:el.getAttr("x"),y:el.getAttr("y")}};!function(frame,id,anchor){for(var i=0;i<anchorHistory.length;i++)if(anchorHistory[i].frame==frame){for(var x=0;x<anchorHistory[i].history.length;x++)if(anchorHistory[i].history[x].id==id)return anchorHistory[i].history[x].anchor=anchor,!0;return anchorHistory[i].history.push({id,anchor}),!0}anchorHistory.push({frame,history:[{id,anchor}]})}(currentFrame||currentObjPerFrame,el.getAttr("id"),anchorToSave),$scope.turnOnRotation&&rotateObject(),selectedFrame.draw()}}}function getPosOnCurves(p1,p2,p3,percent){return t=percent,x=(1-t)*(1-t)*p1.x+2*(1-t)*t*p2.x+t*t*p3.x,y=(1-t)*(1-t)*p1.y+2*(1-t)*t*p2.y+t*t*p3.y,{x,y}}function rotateObject(id=null,obj=$scope.lastSelected){if($scope.selectedItemList.length>0)for(let x=0;x<$scope.selectedItemList.length;x++){id=$scope.selectedItemList[x].getAttr("id");if(isAnchorHistoryFor(currentObjPerFrame,id)){var p1=getPosOnCurves((actual=getAnchorHistoryFor(currentObjPerFrame,id)).start,actual.control,actual.end,.9),p2=getPosOnCurves(actual.start,actual.control,actual.end,1),rotOffset=0;p1.x>p2.x&&(rotOffset=180);var a=(p2.y-p1.y)/(p2.x-p1.x),degree=180*Math.atan(a)/Math.PI;$scope.selectedItemList[x].rotation(degree+rotOffset)}else if(isAnchorHistoryFor(currentObjPerFrame+1,id)){p1=getPosOnCurves((actual=getAnchorHistoryFor(currentObjPerFrame+1,id)).start,actual.control,actual.end,0),p2=getPosOnCurves(actual.start,actual.control,actual.end,.1),rotOffset=0;p1.x>p2.x&&(rotOffset=180);a=(p2.y-p1.y)/(p2.x-p1.x),degree=180*Math.atan(a)/Math.PI;$scope.selectedItemList[x].rotation(degree+rotOffset)}selectedFrame.draw(),showInConfigObjData($scope.selectedItemList[x])}else{if(null==id){if(!$scope.lastSelected||null==$scope.lastSelected)return;id=$scope.lastSelected.getAttr("id")}if(isAnchorHistoryFor(currentObjPerFrame,id)){p1=getPosOnCurves((actual=getAnchorHistoryFor(currentObjPerFrame,id)).start,actual.control,actual.end,.9),p2=getPosOnCurves(actual.start,actual.control,actual.end,1),rotOffset=0;p1.x>p2.x&&(rotOffset=180);a=(p2.y-p1.y)/(p2.x-p1.x),degree=180*Math.atan(a)/Math.PI;obj.rotation(degree+rotOffset)}else if(isAnchorHistoryFor(currentObjPerFrame+1,id)){var actual;p1=getPosOnCurves((actual=getAnchorHistoryFor(currentObjPerFrame+1,id)).start,actual.control,actual.end,0),p2=getPosOnCurves(actual.start,actual.control,actual.end,.1),rotOffset=0;p1.x>p2.x&&(rotOffset=180);a=(p2.y-p1.y)/(p2.x-p1.x),degree=180*Math.atan(a)/Math.PI;obj.rotation(degree+rotOffset)}selectedFrame.draw(),showInConfigObjData(obj)}}function showInConfigObjData(obj=$scope.lastSelected){if(null!=obj){var rot=obj.getAttr("rotation"),scl=obj.getAttr("scale").x;$("#rotationConfig").parent().find("span").first().html(rot+"'"),$("#scaleConfig").parent().find("span").first().html(scl),$("#rotationConfig").val(rot),$("#scaleConfig").val(scl)}}function createFrameToAnim(){selectObjStyle(null);for(var animationFrames=[],i=0;i<allObjectPerFrame.length;i++){var objs=allObjectPerFrame[i].obj,arrows=allObjectPerFrame[i].arrow,shapes=allObjectPerFrame[i].shapes,text=allObjectPerFrame[i].text;if(allObjectPerFrame[i+1])for(var x=0;x<$scope.iloscklatekPomiedzyGlownymi;x++){arrowsArray=[];for(var z=0;z<arrows.length;z++){var lastText=arrows[z].getAttr("textObj"),complexText=new Konva.Text({x:lastText.getAttr("x"),y:lastText.getAttr("y"),offsetX:lastText.getAttr("offsetX"),offsetY:lastText.getAttr("offsetY"),text:lastText.getAttr("text"),fontSize:lastText.getAttr("fontSize"),fontFamily:"Calibri",fill:lastText.getAttr("fill"),padding:20,width:200,align:"center"});arrows[z].getAttr("points")[0].y<arrows[z].getAttr("points")[1].y?complexText.setAttr("offsetY",50):complexText.setAttr("offsetY",10);var arrow=new Konva.Shape({x:arrows[z].getAttr("x"),y:arrows[z].getAttr("y"),offsetX:arrows[z].getAttr("offsetX"),offsetY:arrows[z].getAttr("offsetY"),points:arrows[z].getAttr("points"),stroke:arrows[z].getAttr("stroke"),strokeWidth:arrows[z].getAttr("strokeWidth"),sceneFunc:function(context){drawArrowStyle(context,this)},id:arrows[z].getAttr("id"),textObj:complexText,name:"arrow",config:arrows[z].getAttr("config")});arrowsArray.push(arrow)}shapesArray=[];for(z=0;z<shapes.length;z++){lastText=shapes[z].getAttr("textObj"),complexText=new Konva.Text({x:lastText.getAttr("x"),y:lastText.getAttr("y"),offsetX:lastText.getAttr("offsetX"),offsetY:lastText.getAttr("offsetY"),text:lastText.getAttr("text"),fontSize:lastText.getAttr("fontSize"),fontFamily:"Calibri",fill:lastText.getAttr("fill"),padding:20,width:200,align:"center"});var shape=new Konva.Shape({x:shapes[z].getAttr("x"),y:shapes[z].getAttr("y"),offsetX:shapes[z].getAttr("offsetX"),offsetY:shapes[z].getAttr("offsetY"),arrowPoint:shapes[z].getAttr("arrowPoint"),sceneFunc:shapes[z].getAttr("sceneFunc"),name:shapes[z].getAttr("name"),fill:shapes[z].getAttr("fill"),stroke:shapes[z].getAttr("stroke"),scale:shapes[z].getAttr("scale"),strokeWidth:shapes[z].getAttr("strokeWidth"),id:shapes[z].getAttr("id"),config:shapes[z].getAttr("config"),textObj:complexText});shapesArray.push(shape)}textArray=[];for(z=0;z<text.length;z++){var obj=new Konva.Text({x:text[z].getAttr("x"),y:text[z].getAttr("y"),offsetX:text[z].getAttr("offsetX"),offsetY:text[z].getAttr("offsetY"),rotation:text[z].getAttr("rotation"),fontSize:text[z].getAttr("fontSize"),text:text[z].getAttr("text"),name:text[z].getAttr("name"),fill:text[z].getAttr("fill"),align:text[z].getAttr("align"),scale:text[z].getAttr("scale"),id:text[z].getAttr("id"),config:text[z].getAttr("config")});textArray.push(obj)}objectArrays=[],objs=allObjectPerFrame[i+1].obj;for(z=0;z<objs.length;z++){if(isAnchorHistoryFor(i+1,objs[z].getAttr("id"))){var p1,p2,a,degree,history=getAnchorHistoryFor(i+1,objs[z].getAttr("id"));p1=getPosOnCurves(history.start,history.control,history.end,.9),p2=getPosOnCurves(history.start,history.control,history.end,1);var rotOffset=0;p1.x>p2.x&&(rotOffset=180),a=(p2.y-p1.y)/(p2.x-p1.x),degree=parseFloat(180*Math.atan(a)/Math.PI+rotOffset,2).toFixed(2);var lastDegreee=parseDeg(parseInt(degree)),isReRotation=parseDeg(parseInt(objs[z].getAttr("rotation")))!=lastDegreee;p1=getPosOnCurves(history.start,history.control,history.end,x/$scope.iloscklatekPomiedzyGlownymi),p2=getPosOnCurves(history.start,history.control,history.end,(x+1)/$scope.iloscklatekPomiedzyGlownymi);rotOffset=0;p1.x>p2.x&&(rotOffset=180),a=(p2.y-p1.y)/(p2.x-p1.x),degree=parseDeg(parseFloat(180*Math.atan(a)/Math.PI+rotOffset,2).toFixed(2)),isReRotation&&(degree=parseFloat(degree)+Math.abs(lastDegreee-parseDeg(parseInt(objs[z].getAttr("rotation")))));lastText=objs[z].getAttr("textObj"),complexText=new Konva.Text({x:p1.x,y:p1.y+objs[z].height()/2,offsetX:lastText.getAttr("offsetX"),offsetY:lastText.getAttr("offsetY"),text:lastText.getAttr("text"),fontSize:lastText.getAttr("fontSize"),fontFamily:"Calibri",fill:lastText.getAttr("fill"),padding:20,width:200,align:"center"}),obj=new Konva.Image({x:p1.x,y:p1.y,offsetX:objs[z].getAttr("offsetX"),offsetY:objs[z].getAttr("offsetY"),rotation:$scope.turnOnRotation?degree:objs[z].getAttr("rotation"),image:objs[z].getAttr("image"),scale:objs[z].getAttr("scale"),name:objs[z].getAttr("name"),id:objs[z].getAttr("id"),config:objs[z].getAttr("config"),textObj:complexText})}else lastText=objs[z].getAttr("textObj"),complexText=new Konva.Text({x:lastText.getAttr("x"),y:lastText.getAttr("y"),offsetX:lastText.getAttr("offsetX"),offsetY:lastText.getAttr("offsetY"),text:lastText.getAttr("text"),fontSize:lastText.getAttr("fontSize"),fontFamily:"Calibri",fill:lastText.getAttr("fill"),padding:20,width:200,align:"center"}),obj=new Konva.Image({x:objs[z].getAttr("x"),y:objs[z].getAttr("y"),offsetX:objs[z].getAttr("offsetX"),offsetY:objs[z].getAttr("offsetY"),rotation:objs[z].getAttr("rotation"),image:objs[z].getAttr("image"),scale:objs[z].getAttr("scale"),name:objs[z].getAttr("name"),id:objs[z].getAttr("id"),config:objs[z].getAttr("config"),textObj:complexText});objectArrays.push(obj)}animationFrames.push({arrow:arrowsArray,obj:objectArrays,shapes:shapesArray,text:textArray})}else{arrowsArray=[];for(z=0;z<arrows.length;z++){lastText=arrows[z].getAttr("textObj"),complexText=new Konva.Text({x:lastText.getAttr("x"),y:lastText.getAttr("y"),offsetX:lastText.getAttr("offsetX"),offsetY:lastText.getAttr("offsetY"),text:lastText.getAttr("text"),fontSize:lastText.getAttr("fontSize"),fontFamily:"Calibri",fill:lastText.getAttr("fill"),padding:20,width:200,align:"center"});arrows[z].getAttr("points")[0].y<arrows[z].getAttr("points")[1].y?complexText.setAttr("offsetY",50):complexText.setAttr("offsetY",10);arrow=new Konva.Shape({x:arrows[z].getAttr("x"),y:arrows[z].getAttr("y"),offsetX:arrows[z].getAttr("offsetX"),offsetY:arrows[z].getAttr("offsetY"),points:arrows[z].getAttr("points"),stroke:arrows[z].getAttr("stroke"),strokeWidth:arrows[z].getAttr("strokeWidth"),sceneFunc:function(context){drawArrowStyle(context,this)},id:arrows[z].getAttr("id"),textObj:complexText,name:"arrow",config:arrows[z].getAttr("config")});arrowsArray.push(arrow)}shapesArray=[];for(z=0;z<shapes.length;z++){lastText=shapes[z].getAttr("textObj"),complexText=new Konva.Text({x:lastText.getAttr("x"),y:lastText.getAttr("y"),offsetX:lastText.getAttr("offsetX"),offsetY:lastText.getAttr("offsetY"),text:lastText.getAttr("text"),fontSize:lastText.getAttr("fontSize"),fontFamily:"Calibri",fill:lastText.getAttr("fill"),padding:20,width:200,align:"center"}),shape=new Konva.Shape({x:shapes[z].getAttr("x"),y:shapes[z].getAttr("y"),offsetX:shapes[z].getAttr("offsetX"),offsetY:shapes[z].getAttr("offsetY"),arrowPoint:shapes[z].getAttr("arrowPoint"),sceneFunc:shapes[z].getAttr("sceneFunc"),name:shapes[z].getAttr("name"),fill:shapes[z].getAttr("fill"),scale:shapes[z].getAttr("scale"),stroke:shapes[z].getAttr("stroke"),strokeWidth:shapes[z].getAttr("strokeWidth"),id:shapes[z].getAttr("id"),config:shapes[z].getAttr("config"),textObj:complexText});shapesArray.push(shape)}textArray=[];for(z=0;z<text.length;z++){obj=new Konva.Text({x:text[z].getAttr("x"),y:text[z].getAttr("y"),offsetX:text[z].getAttr("offsetX"),offsetY:text[z].getAttr("offsetY"),rotation:text[z].getAttr("rotation"),fontSize:text[z].getAttr("fontSize"),text:text[z].getAttr("text"),name:text[z].getAttr("name"),fill:text[z].getAttr("fill"),align:text[z].getAttr("align"),scale:text[z].getAttr("scale"),id:text[z].getAttr("id"),config:text[z].getAttr("config")});textArray.push(obj)}objectArrays=[];for(z=0;z<objs.length;z++){lastText=objs[z].getAttr("textObj"),complexText=new Konva.Text({x:lastText.getAttr("x"),y:lastText.getAttr("y"),offsetX:lastText.getAttr("offsetX"),offsetY:lastText.getAttr("offsetY"),text:lastText.getAttr("text"),fontSize:lastText.getAttr("fontSize"),fontFamily:"Calibri",fill:lastText.getAttr("fill"),padding:20,width:200,align:"center"}),obj=new Konva.Image({x:objs[z].getAttr("x"),y:objs[z].getAttr("y"),offsetX:objs[z].getAttr("offsetX"),offsetY:objs[z].getAttr("offsetY"),rotation:objs[z].getAttr("rotation"),image:objs[z].getAttr("image"),scale:objs[z].getAttr("scale"),name:objs[z].getAttr("name"),id:objs[z].getAttr("id"),config:objs[z].getAttr("config"),textObj:complexText});objectArrays.push(obj)}animationFrames.push({arrow:arrowsArray,obj:objectArrays,shapes:shapesArray,text:textArray})}}return animationFrames}function parseDeg(deg){return(deg=parseFloat(deg))>=0?deg:360+deg}function playAnimate(){actualPlayerFrame>=allAnimFrame.length&&(actualPlayerFrame=0);var mainPlay=setInterval(function(){if(pauseAnim)window.clearInterval(mainPlay);else if(++actualPlayerFrame>=allAnimFrame.length)window.clearInterval(mainPlay),turnOnAllSter();else{setPlayerToFrame(actualPlayerFrame);currentObjPerFrame=actualPlayerFrame,drawNewStage("canvasPlayerContainer",allAnimFrame),$("#playerData p").first().text("Podgląd animacji - klatka: "+(actualPlayerFrame+1)+" / "+allAnimFrame.length)}},1e3/$scope.iloscfps)}function setPlayerToFrame(frame){var percent=Math.round(frame/(allAnimFrame.length-1)*100);return $("#animTime").css("width",percent+"%"),percent}function showPlayer(){pauseAnim=!1,isPlayerOpen=!0,allAnimFrame=null,allAnimFrame=createFrameToAnim(),$("#canvasPlayer").show(),actualPlayerFrame>=allAnimFrame.length&&(actualPlayerFrame=0),changeFrame(actualPlayerFrame,allAnimFrame),setPlayerToFrame(actualPlayerFrame),drawNewStage("canvasPlayerContainer",allAnimFrame),playAnimate()}function exitPlayer(){pauseAnim=!0,isPlayerOpen=!1,$("#canvasPlayer").hide(),turnOnAllSter(),changeFrame(allObjectPerFrame.length-1),drawNewStage()}function canClickSter(name){return $("#"+name).hasClass("animCotrollerButton")}function turnOnAllSter(){playerTurnOnSter("playAnim"),playerTurnOnSter("backwardAnim"),playerTurnOnSter("pauseAnim"),playerTurnOnSter("forwardAnim"),playerTurnOnSter("stopAnim")}function playerTurnOnSter(name){$("#"+name).removeClass("disableSter"),$("#"+name).addClass("animCotrollerButton")}function playerTurnOffSter(name){$("#"+name).removeClass("animCotrollerButton"),$("#"+name).addClass("disableSter")}function loadAnimation(callback){request.backend("loadConspectAnim",{id:$scope.animId},function(data){data.anchorHistory=JSON.parse(data.anchorHistory),data.animFrame=JSON.parse(data.animFrame),anchorHistory=null,anchorHistory=data.anchorHistory,allObjectPerFrame=null,allObjectPerFrame=[],$scope.cwName=data.name,$scope.cwFieldType=data.cwFieldType,$scope.cwMaxTime=parseInt(data.cwMaxTime),$scope.cwMinTime=parseInt(data.cwMinTime),$scope.cwMaxPerson=parseInt(data.cwMaxPerson),$scope.cwMinPerson=parseInt(data.cwMinPerson),$scope.cwOps=data.cwOps,$scope.cwWsk=data.cwWsk,$scope.iloscklatekPomiedzyGlownymi=parseInt(data.frameBeetween),$scope.jakoscAnimacji=parseInt(data.qualityAnim),$scope.iloscfps=parseInt(data.fps);for(var x=0;x<data.animFrame.length;x++){if(allObjectPerFrame.push({arrow:[],obj:[],shapes:[],text:[]}),data.animFrame[x].arrow)for(var i=0;i<data.animFrame[x].arrow.length;i++){var obj=createArrowObjFromOther(data.animFrame[x].arrow[i],!0);allObjectPerFrame[x].arrow.push(obj)}if(data.animFrame[x].obj)for(i=0;i<data.animFrame[x].obj.length;i++){obj=createObjFromOther(data.animFrame[x].obj[i],!0);allObjectPerFrame[x].obj.push(obj)}if(data.animFrame[x].shapes)for(i=0;i<data.animFrame[x].shapes.length;i++){obj=createShapeObjFromOther(data.animFrame[x].shapes[i],!0);allObjectPerFrame[x].shapes.push(obj)}if(data.animFrame[x].text)for(i=0;i<data.animFrame[x].text.length;i++){obj=createTextFromOther(data.animFrame[x].text[i],!0);allObjectPerFrame[x].text.push(obj)}if(0!=x){var count=$(".timeElement").length+1;$(".timeElement").last().after("<div class='timeElement' > "+count+" </div>")}}$scope.tags=data.tags.split(" ");for(var tagTo={data:[]},ind=0;ind<$scope.tags.length;ind++)tagTo.data.push({tag:$scope.tags[ind]});$(".chips-placeholder").material_chip(tagTo),data.fieldImage&&data.fieldImage.length>2&&(selectField(data.fieldImage),$scope.$apply(function(){callback(),$scope.changeCategories($scope.mouseActionType.MOVE),changeFrame(0),setTimeout(function(){resize()},500)}))})}function saveAnimation(){!function(){$scope.turnOnHelperNet=!1,isPlayerOpen=!0,allAnimFrame=null,allAnimFrame=createFrameToAnim(),$("#canvasPlayer").show(),changeFrame(actualPlayerFrame=0,allAnimFrame),setPlayerToFrame(actualPlayerFrame);var encoder=new GIFEncoder;encoder.setRepeat(0),encoder.setQuality($scope.jakoscAnimacji),encoder.setDelay(1e3/$scope.iloscfps),encoder.start();var mainPlay=setInterval(function(){if(actualPlayerFrame>=allAnimFrame.length){window.clearInterval(mainPlay),turnOnAllSter(),encoder.finish();var binary_gif=encoder.stream().getData();$scope.gif=encode64(binary_gif);for(var tags=$(".chips-placeholder").material_chip("data"),allTagString="",x=0;x<tags.length;x++)allTagString+=" ",allTagString+=tags[x].tag;for(var allObj=[],index=0;index<allObjectPerFrame.length;index++){for(allObj.push({obj:[],arrow:[],shapes:[],text:[]}),x=0;x<allObjectPerFrame[index].obj.length;x++)allObj[index].obj.push(allObjectPerFrame[index].obj[x].toObject()),allObj[index].obj[x].attrs.image=allObjectPerFrame[index].obj[x].getImage().src;for(x=0;x<allObjectPerFrame[index].arrow.length;x++)allObj[index].arrow.push(allObjectPerFrame[index].arrow[x].toObject());for(x=0;x<allObjectPerFrame[index].shapes.length;x++)allObj[index].shapes.push(allObjectPerFrame[index].shapes[x].toObject());for(x=0;x<allObjectPerFrame[index].text.length;x++)allObj[index].text.push(allObjectPerFrame[index].text[x].toObject())}currentObjPerFrame=0,drawNewStage("canvasPlayerContainer",allAnimFrame);var toSend={id:$scope.animId,name:$scope.animName,tags:allTagString,mainImg:allAnimFrame.length<=0?"":$scope.gif,mainImgShow:allAnimFrame.length<=0?"":selectedFrame.toCanvas().toDataURL("image/jpg").split(",")[1],animFrame:JSON.stringify(allObj),anchorHistory:JSON.stringify(anchorHistory),fieldImage:$scope.isSelectedField?$scope.fieldImage.src:"",cwFieldType:$scope.cwFieldType,cwMaxTime:$scope.cwMaxTime,cwMinTime:$scope.cwMinTime,cwMaxPerson:$scope.cwMaxPerson,cwMinPerson:$scope.cwMinPerson,cwOps:$scope.cwOps,cwWsk:$scope.cwWsk,usid:$rootScope.user.id,frameBeetween:$scope.iloscklatekPomiedzyGlownymi,qualityAnim:$scope.jakoscAnimacji,fps:$scope.iloscfps};request.backend("saveConspectAnim",toSend,function(data){exitPlayer(),-1!=$scope.animId?notify.localNotify("Sukces","Animacja pomyślnie edytowana"):notify.localNotify("Sukces","Animacja zapisana pomyślnie"),$scope.animId=data,$location.url("/conspectusAnimList")})}else setPlayerToFrame(actualPlayerFrame),currentObjPerFrame=actualPlayerFrame,drawNewStage("canvasPlayerContainer",allAnimFrame),encoder.addFrame(selectedFrame.toCanvas().getContext("2d")),$("#playerData p").first().text("Renderowanie animacji - klatka: "+(actualPlayerFrame+1)+" / "+allAnimFrame.length),actualPlayerFrame++},1e3/$scope.iloscfps)}()}$scope.shiftPressed=!1,$(window).resize(function(){resize()}),$(window).on("orientationchange",function(event){$scope.orientation=$(window).width()>$(window).height()?"sd":"landscape",resize()}),$scope.actualMouseAction=$scope.mouseActionType.FIELD_LIST,$scope.selectArrow=function(arrowTypw){$scope.actualMouseAction=$scope.mouseActionType.ARROW_ADD,$scope.arrowPointCount=0,$scope.arrowPoint=[]},$scope.selectShape=function(shapeType){$scope.selectedShape=shapeType,$scope.shapePointCount=0,$scope.shapePoint=[]},$scope.changeCategories=function(categoryType){($scope.actualMouseAction=categoryType,$scope.actualMouseAction==$scope.mouseActionType.MOVE)?selectedFrame.find(".movementObject").each(function(shape){shape.draggable(!0)}):selectedFrame.find(".movementObject").each(function(shape){shape.draggable(!1)});$scope.actualMouseAction==$scope.mouseActionType.ARROW_ADD?$scope.selectedArrow=null:$scope.actualMouseAction==$scope.mouseActionType.SHAPE_ADD&&($scope.selectedShape=null),$(".categories").each(function(){$(this).css("border-color","")}),$(".categories").eq(0).css("border-color","rgb(191, 72, 36)")},selectedFrame.on("contentClick contentTap",function(e){clickOnContent()}),selectedFrame.on("mousedown touchstart",function(e){onMuseDown()}),selectedFrame.on("mousemove touchmove",function(e){onMuseMove()}),selectedFrame.on("mouseup touchend",function(e){onMuseUp()}),$(document).ready(function(){$("#animCreator").off("keydown"),$("#animCreator").off("keyup"),$("#animCreator").on("keydown",function(e){16==e.keyCode&&($scope.shiftPressed=!0)}),$("#animCreator").on("keyup",function(e){$scope.shiftPressed=!1,46==e.keyCode&&$rootScope.showModalWindow("Nieodwracalnie usunie zaznaczone obiekty oraz wszystkie ich wystąpienia w następnych klatkach animacji",function(){deleteCurrent()})})}),$(document).off("click touch",".categories"),$(document).on("click touch",".categories",function(){$(window).width()>1e3&&$(".itemBoxWithItem").first().width(750),$(".categories").each(function(){$(this).css("border-color","")}),$(".categoryItems").each(function(){$(this).css("border-color","")}),$(this).css("border-color","rgb(191, 72, 36)"),$scope.selectedObjConfig=$(this).data("config")?$scope.objConfig[$(this).data("config")]:[],$scope.canAddItem=!1}),$(document).off("click touch",".confTitle"),$(document).on("click touch",".confTitle",function(){$(this).hasClass("hideIs")?($(this).removeClass("hideIs"),$(this).addClass("showIs"),$(this).next(".configleftContent").first().stop().show("slide",{direction:"up"},300)):($(this).addClass("hideIs"),$(this).removeClass("showIs"),$(this).next(".configleftContent").first().stop().hide("slide",{direction:"up"},300))}),$(document).off("click touch",".categoryItems"),$(document).on("click touch",".categoryItems",function(){$scope.arrowPointCount=0,$scope.arrowPoint=[],$(".categoryItems").each(function(){$(this).css("border-color","")}),$(this).css("border-color","rgb(191, 72, 36)"),$scope.actualMouseAction==$scope.mouseActionType.OBJECT_ADD&&($scope.selectedObjImg=new Image,$scope.selectedObjImg.src=$(this).find("img").attr("src")),$scope.canAddItem=!0,$scope.selectedObjConfig=$(this).find("img").data("config")?$scope.objConfig[$(this).find("img").data("config")]:[]}),$scope.showObjConfig=function(){if($("#lastSelectedConfig").first().html(""),$("#lastSelectedConfig").first().append("<div class='lastSelectedConfigContent'><p class='confInfo' >Brak dostępnych opcji konfiguracyjnych</p></div>"),($scope.lastSelected||!($scope.selectedItemList.length<=0))&&$scope.lastSelected){var config=$scope.lastSelected.getAttr("config");if(config){if((config.text||config.colors||config.arrowTypes)&&$(".lastSelectedConfigContent").first().html(""),config.text){var textEdit="<div class='configColorPickerForText'>";textEdit+="<p class='confInfo' style='width: 100%'>Kolor czcionki:</p>",textEdit+="<div class='configColorText' style='background-color:rgb(255,255,255); border-color:rgb(0,0,0)'></div>",textEdit+="<div class='configColorText' style='background-color:rgb(0,0,0); border-color:rgb(0,0,0)'></div>",textEdit+="<div class='configColorText' style='background-color:rgb(255,82,82); border-color:rgb(0,0,0)'></div>",textEdit+="<div class='configColorText' style='background-color:rgb(253,216,53); border-color:rgb(0,0,0)'></div>",textEdit+="</div>",textEdit+="<div class='textSizeChanger'>",textEdit+="<p class='confInfo' style='padding-bottom:0'>Rozmiar czcionki:</p>",textEdit+="<input style='height: 30px; margin-bottom:10px;text-align:center; color: #adadad' class='configTextSize' type='number' class='validate' value='"+config.selectedTextSize+"'></input>",textEdit+="</div>",textEdit+="<p class='confInfo' style='padding-bottom:0'>Tekst przy obiekcie</p>",textEdit+="<div style='margin-top:0' class='input-field col s12'>",textEdit+="<input style='height: 30px; margin-bottom:0;text-align:center' class='configEditText' placeholder='Treść' type='text' class='validate' value='"+config.text+"'></input>",textEdit+="</div>",$(".lastSelectedConfigContent").first().append(textEdit);var thisObj=$scope.lastSelected;thisObj=$scope.selectedItemList.length>0?$scope.selectedItemList:thisObj,$(document).off("click",".configColorText"),$(document).on("click",".configColorText",function(){if($.isArray(thisObj))for(let i=0;i<thisObj.length;i++){var configNow;(configNow=thisObj[i].getAttr("config")).selectedColorText=$(this).css("background-color"),thisObj[i].setAttr("config",configNow),thisObj[i].getAttr("textObj").setAttr("fill",$(this).css("background-color")),configTextUpdate(thisObj[i])}else(configNow=thisObj.getAttr("config")).selectedColorText=$(this).css("background-color"),thisObj.setAttr("config",configNow),thisObj.getAttr("textObj").setAttr("fill",$(this).css("background-color")),configTextUpdate(thisObj);mainLayer.draw()}),$(document).off("change",".configTextSize"),$(document).on("change",".configTextSize",function(){if($.isArray(thisObj))for(let i=0;i<thisObj.length;i++){var configNow,text;(configNow=thisObj[i].getAttr("config")).selectedTextSize=$(this).val(),thisObj[i].setAttr("config",configNow),(text=thisObj[i].getAttr("textObj")).setAttr("fontSize",$(this).val()),text.setAttr("offsetY",30-$(this).val()),configTextUpdate(thisObj[i])}else(configNow=thisObj.getAttr("config")).selectedTextSize=$(this).val(),thisObj.setAttr("config",configNow),(text=thisObj.getAttr("textObj")).setAttr("fontSize",$(this).val()),text.setAttr("offsetY",30-$(this).val()),configTextUpdate(thisObj);mainLayer.draw()}),$(document).off("change",".configEditText"),$(document).on("change",".configEditText",function(){if($.isArray(thisObj))for(let i=0;i<thisObj.length;i++){var val=$(this).val();(actualConf=thisObj[i].getAttr("config")).text=val,thisObj[i].setAttr("config",actualConf),(textObj=thisObj[i].getAttr("textObj")).setAttr("text",actualConf.text),thisObj[i].setAttr("textObj",textObj),configTextUpdate(thisObj[i])}else{var actualConf,textObj;val=$(this).val();(actualConf=thisObj.getAttr("config")).text=val,thisObj.setAttr("config",actualConf),(textObj=thisObj.getAttr("textObj")).setAttr("text",actualConf.text),thisObj.setAttr("textObj",textObj),configTextUpdate(thisObj)}mainLayer.draw()})}if(config.colors){var colorPicker="<div class='configColorPicker'>";colorPicker+="<p class='confInfo'>Wersja kolorystyczna obiektu:</p>";for(var i=0;i<config.colors.length;i++)colorPicker+="<div class='configColor' style='background-color:"+config.colors[i].background+"; border-color:"+config.colors[i].border+"'></div>";colorPicker+="</div>",$(".lastSelectedConfigContent").first().append(colorPicker);thisObj=$scope.lastSelected;thisObj=$scope.selectedItemList.length>0?$scope.selectedItemList:thisObj,$(document).off("click",".configColor"),$(document).on("click",".configColor",function(){if($.isArray(thisObj))for(let i=0;i<thisObj.length;i++){(configNow=thisObj[i].getAttr("config")).selectedColor={background:$(this).css("background-color"),border:$(this).css("border-color")},thisObj[i].setAttr("config",configNow);var back=$(this).css("background-color").replace(/ /g,""),border=$(this).css("border-color").replace(/ /g,"");switch(thisObj[i].getAttr("name")){case"movementObject":break;case"shapes":thisObj[i].setAttr("stroke",border),thisObj[i].setAttr("fill",back)}configColorUpdate(thisObj[i])}else{var configNow;(configNow=thisObj.getAttr("config")).selectedColor={background:$(this).css("background-color"),border:$(this).css("border-color")},thisObj.setAttr("config",configNow);back=$(this).css("background-color").replace(/ /g,""),border=$(this).css("border-color").replace(/ /g,"");switch(thisObj.getAttr("name")){case"movementObject":break;case"shapes":thisObj.setAttr("stroke",border),thisObj.setAttr("fill",back)}configColorUpdate(thisObj)}mainLayer.draw()})}if(config.arrowTypes){var arrowPicker="<div class='configArrowTypes'>";arrowPicker+="<form style='display: table;margin: 10px;'>",arrowPicker+="<p class='confInfo'>Typ akcji:</p>";for(i=0;i<config.arrowTypes.length;i++)config.arrowTypes[i]==config.arrowType?add="checked='checked'":add="",arrowPicker+="<p><input name='arrowTypeGroup' "+add+" type='radio' id='"+config.arrowTypes[i]+"' /><label for='"+config.arrowTypes[i]+"'>"+config.arrowTypes[i]+"</label></p>";arrowPicker+="</form>",arrowPicker+="</div>";thisObj=$scope.lastSelected;thisObj=$scope.selectedItemList.length>0?$scope.selectedItemList:thisObj,$(".lastSelectedConfigContent").first().append(arrowPicker),$("input[name=arrowTypeGroup]").on("change",function(){if($.isArray(thisObj))for(let i=0;i<thisObj.length;i++)config.arrowType=$(this).attr("id"),thisObj[i].setAttr("config",config),configTextUpdate(thisObj[i]);else config.arrowType=$(this).attr("id"),thisObj.setAttr("config",config),configTextUpdate(thisObj);mainLayer.draw()})}}}},$(document).off("click touch",".soccerField"),$(document).on("click touch",".soccerField",function(){$(".soccerField").each(function(){$(this).css("transform","")}),selectField($(this).find("img").attr("src"))}),$(document).off("click touch","#canActionPlay"),$(document).on("click touch","#canActionPlay",function(){showPlayer()}),$(document).off("change","#rotationConfig"),$(document).on("change","#rotationConfig",function(){!function(rot){if($scope.lastSelected&&$scope.selectedItemList.length<=0){var thisId=$scope.lastSelected.getAttr("id");for(let y=$scope.turnOnRotation?currentObjPerFrame:0;y<($scope.turnOnRotation?currentObjPerFrame+1:allObjectPerFrame.length);y++)for(let u=0;u<allObjectPerFrame[y].obj.length;u++)if(allObjectPerFrame[y].obj[u].getAttr("id")==thisId){allObjectPerFrame[y].obj[u].setAttr("rotation",rot);break}}else if($scope.selectedItemList.length>0)for(let i=0;i<$scope.selectedItemList.length;i++){var thisId=$scope.selectedItemList[i].getAttr("id");for(let y=$scope.turnOnRotation?currentObjPerFrame:0;y<($scope.turnOnRotation?currentObjPerFrame+1:allObjectPerFrame.length);y++)for(let u=0;u<allObjectPerFrame[y].obj.length;u++)if(allObjectPerFrame[y].obj[u].getAttr("id")==thisId){allObjectPerFrame[y].obj[u].setAttr("rotation",rot);break}}selectedFrame.draw()}($(this).val()),showInConfigObjData()}),$(document).off("change","#scaleConfig"),$(document).on("change","#scaleConfig",function(){!function(scale){var newScale={x:scale,y:scale};if($scope.lastSelected&&$scope.selectedItemList.length<=0){var thisId=$scope.lastSelected.getAttr("id");for(let y=$scope.turnOnRotation?currentObjPerFrame:0;y<($scope.turnOnRotation?currentObjPerFrame+1:allObjectPerFrame.length);y++)for(let u=0;u<allObjectPerFrame[y].obj.length;u++)if(allObjectPerFrame[y].obj[u].getAttr("id")==thisId){allObjectPerFrame[y].obj[u].scale(newScale);var txt=allObjectPerFrame[y].obj[u].getAttr("textObj");txt.setAttr("y",allObjectPerFrame[y].obj[u].getAttr("y")+allObjectPerFrame[y].obj[u].height()/2*newScale.x);break}}else if($scope.selectedItemList.length>0)for(let i=0;i<$scope.selectedItemList.length;i++){var thisId=$scope.selectedItemList[i].getAttr("id");for(let y=$scope.turnOnRotation?currentObjPerFrame:0;y<($scope.turnOnRotation?currentObjPerFrame+1:allObjectPerFrame.length);y++)for(let u=0;u<allObjectPerFrame[y].obj.length;u++)if(allObjectPerFrame[y].obj[u].getAttr("id")==thisId){allObjectPerFrame[y].obj[u].scale(newScale);var txt=allObjectPerFrame[y].obj[u].getAttr("textObj");txt.setAttr("y",allObjectPerFrame[y].obj[u].getAttr("y")+allObjectPerFrame[y].obj[u].height()/2*newScale.x);break}}selectedFrame.draw()}($(this).val()),showInConfigObjData()}),$(document).off("click touch","#canActionDel"),$(document).on("click touch","#canActionDel",function(){$rootScope.showModalWindow("Nieodwracalnie usunie zaznaczone obiekty oraz wszystkie ich wystąpienia w następnych klatkach animacji",function(){deleteCurrent()})}),$(document).off("click touch",".timeElement"),$(document).on("click touch",".timeElement",function(e){changeFrame($(this).index(".timeElement")),drawNewStage()}),$(document).off("click touch","#addFrame"),$(document).on("click touch","#addFrame",function(e){var count=$(".timeElement").length+1;$(".timeElement").last().after("<div class='timeElement' > "+count+" </div>"),$(".timeElement").each(function(){$(this).css("border-color","")}),$(".timeElement").last().css("border-color","#dd4213"),function(){$scope.selectedItemList=[],selectObjStyle(null),allObjectPerFrame.push({arrow:[],obj:[],shapes:[],text:[]});var beforeFrameNumber=allObjectPerFrame.length-2;currentObjPerFrame=allObjectPerFrame.length-1;for(var i=0;i<allObjectPerFrame[beforeFrameNumber].arrow.length;i++){var arrowBef=allObjectPerFrame[beforeFrameNumber].arrow[i],obj=createArrowObjFromOther(arrowBef);allObjectPerFrame[currentObjPerFrame].arrow.push(obj)}for(var i=0;i<allObjectPerFrame[beforeFrameNumber].obj.length;i++){var objBef=allObjectPerFrame[beforeFrameNumber].obj[i],obj=createObjFromOther(objBef);allObjectPerFrame[currentObjPerFrame].obj.push(obj)}for(var i=0;i<allObjectPerFrame[beforeFrameNumber].shapes.length;i++){var objBef=allObjectPerFrame[beforeFrameNumber].shapes[i],obj=createShapeObjFromOther(objBef);allObjectPerFrame[currentObjPerFrame].shapes.push(obj)}for(var i=0;i<allObjectPerFrame[beforeFrameNumber].text.length;i++){var objBef=allObjectPerFrame[beforeFrameNumber].text[i],obj=createTextFromOther(objBef);allObjectPerFrame[currentObjPerFrame].text.push(obj)}$scope.changeCategories($scope.mouseActionType.MOVE)}(),drawNewStage()}),$scope.deleteFrame=function(){allObjectPerFrame.length<=1?notify.localNotify("Uwaga","Nie można usunąć jedynej klatki animacji"):$rootScope.showModalWindow("Nieodwracalnie usunie klatkę animacji wraz z zawartością",function(){var frame=allObjectPerFrame.length-1;allObjectPerFrame.splice(frame,1),$(".timeElement").last().remove();for(let i=0;i<anchorHistory.length;i++)if(anchorHistory[i].frame==frame){anchorHistory.splice(i,1);break}changeFrame(frame-1),drawNewStage()})},$scope.endFromFull=function(endFromCreator=!0){endFromCreator&&($scope.showAnimCreator=!1),document.cancelFullScreen?document.cancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.mozCancelFullScreen&&document.mozCancelFullScreen()},$(document).off("click touch","#exitPlayer"),$(document).on("click touch","#exitPlayer",function(){exitPlayer()}),$(document).off("click touch","#playAnim"),$(document).on("click touch","#playAnim",function(){canClickSter("playAnim")&&(playAnimate(),pauseAnim=!1,turnOnAllSter(),playerTurnOffSter("backwardAnim"),playerTurnOffSter("forwardAnim"),playerTurnOffSter("playAnim"))}),$(document).off("click touch","#pauseAnim"),$(document).on("click touch","#pauseAnim",function(){canClickSter("pauseAnim")&&(pauseAnim=!0,turnOnAllSter(),playerTurnOffSter("pauseAnim"))}),$(document).off("click touch","#stopAnim"),$(document).on("click touch","#stopAnim",function(){pauseAnim=!0,actualPlayerFrame=0,changeFrame(0,allAnimFrame),setPlayerToFrame(0),drawNewStage("canvasPlayerContainer",allAnimFrame),turnOnAllSter()}),$(document).off("click touch","#backwardAnim"),$(document).on("click touch","#backwardAnim",function(){canClickSter("backwardAnim")&&(!function(){if(0==actualPlayerFrame)return;changeFrame(--actualPlayerFrame,allAnimFrame),setPlayerToFrame(actualPlayerFrame),drawNewStage("canvasPlayerContainer",allAnimFrame)}(),$("#playerData p").first().text("Podgląd animacji - klatka: "+(actualPlayerFrame+1)+" / "+allAnimFrame.length))}),$(document).off("click touch","#forwardAnim"),$(document).on("click touch","#forwardAnim",function(){canClickSter("forwardAnim")&&(!function(){if(actualPlayerFrame>=allAnimFrame.length-1)return;changeFrame(++actualPlayerFrame,allAnimFrame),setPlayerToFrame(actualPlayerFrame),drawNewStage("canvasPlayerContainer",allAnimFrame)}(),$("#playerData p").first().text("Podgląd animacji - klatka: "+(actualPlayerFrame+1)+" / "+allAnimFrame.length))}),$(document).off("change","#turnOnHelperNet"),$(document).on("change","#turnOnHelperNet",function(){drawNewStage()}),$(document).off("change","#turnOnHekperFullScreen"),$(document).on("change","#turnOnHekperFullScreen",function(){$scope.turnOnHekperFullScreen?($scope.fullElement=document.getElementById("animCreator"),$scope.fullElement.requestFullScreen?$scope.fullElement.requestFullscreen():$scope.fullElement.webkitRequestFullScreen?$scope.fullElement.webkitRequestFullScreen():$scope.fullElement.mozRequestFullScreen&&$scope.fullElement.mozRequestFullScreen()):$scope.endFromFull(!1)}),$scope.saveAnim=function(){$scope.animName=$("#cwName").val(),$scope.tags=$(".chips-placeholder").material_chip("data"),$scope.cwFieldType=$("#cwFieldType").val(),$scope.cwMaxTime=parseInt($("#maxTime").val()),$scope.cwMinTime=parseInt($("#minTime").val()),$scope.cwMaxPerson=parseInt($("#maxPerson").val()),$scope.cwMinPerson=parseInt($("#minPerson").val()),$scope.cwOps=$("#opCw").val(),$scope.cwWsk=$("#wskCw").val(),$scope.animName&&""!=$scope.animName&&" "!=$scope.animName&&null!=$scope.animName?!$scope.cwFieldType||$scope.cwFieldType.length<=0?notify.localNotify("Walidacja","Wpisz poprawnie pole gry"):!$scope.cwMinTime||$scope.cwMinTime.length<=0||$scope.cwMinTime<=0||!$.isNumeric($scope.cwMinTime)?notify.localNotify("Walidacja","Wpisz poprawnie minimalny czas trwania ( więcej niż 0 )"):!$scope.cwMaxTime||$scope.cwMaxTime.length<=0||$scope.cwMaxTime<$scope.cwMinTime||$scope.cwMaxTime>1e3||!$.isNumeric($scope.cwMaxTime)?notify.localNotify("Walidacja","Wpisz poprawnie maksymalny czas trwania ( wiecej niż "+$scope.cwMinTime+" mniej niż 1000 )"):!$scope.cwMinPerson||$scope.cwMinPerson.length<=0||$scope.cwMinPerson<=0||!$.isNumeric($scope.cwMinPerson)?notify.localNotify("Walidacja","Wpisz poprawnie minimalną ilość zawodników ( więcej niż 0 )"):!$scope.cwMaxPerson||$scope.cwMaxPerson.length<=0||$scope.cwMaxPerson<$scope.cwMinPerson||$scope.cwMaxPerson>100||!$.isNumeric($scope.cwMaxPerson)?notify.localNotify("Walidacja","Wpisz poprawnie maksymalną ilość zawodników ( wiecej niż "+$scope.cwMinPerson+" mniej niż 100 )"):!$scope.tags||$scope.tags.length<2?notify.localNotify("Walidacja","Wpisz przynajmniej dwie frazy, z którymi będzie kojarzone dane ćwiczenie"):saveAnimation():notify.localNotify("Walidacja","Wpisz nazwę danego ćwiczenia")},$scope.loadAndPlay=function(id){$scope.onlyPlayer=!0,currentObjPerFrame=0,$scope.animId=id,$rootScope.idFromAnimConspectToEdit=null,loadAnimation(function(){showPlayer()})}}),app.controller("shareList",function($scope,auth,$rootScope,notify,request,$location,$compile){$scope.showContent=!1,$scope.shareList=[],$scope.loadSharedList=function(){request.backend("getSharedListForAnim",{aid:$rootScope.sharedAnimId},function(data){$scope.$apply(function(){$scope.shareList=data,request.backend("getAvailableSharedMasterForAnim",{aid:$rootScope.sharedAnimId},function(data){$("#autocompleteMaster").autocomplete({data,limit:20,minLength:1,onAutocomplete:function(val){var usid;console.log(val),$usid=val.split("-")[1],usid=$usid,request.backend("addSharedForAnim",{aid:$rootScope.sharedAnimId,usid},function(data){$scope.loadSharedList()},"Dodano pozwolenie na wgląd")}})}),$scope.showContent=!0})})},$scope.loadSharedListC=function(){request.backend("getSharedListForConsp",{aid:$rootScope.sharedConspId},function(data){$scope.$apply(function(){$scope.shareList=data,request.backend("getAvailableSharedMasterForConsp",{aid:$rootScope.sharedConspId},function(data){$("#autocompleteMaster").autocomplete({data,limit:20,minLength:1,onAutocomplete:function(val){var usid;console.log(val),$usid=val.split("-")[1],usid=$usid,request.backend("addSharedForConsp",{aid:$rootScope.sharedConspId,usid},function(data){$scope.loadSharedListC()},"Dodano pozwolenie na wgląd")}})}),$scope.showContent=!0})})},$scope.deleteFromShared=function(usid){$rootScope.showModalWindow("Usunięcie pozwolenia na wgląd",function(){request.backend("deleteSharedForAnim",{aid:$rootScope.sharedAnimId,usid},function(data){$scope.loadSharedList()},"Usunięto pozwolenie na wgląd")})},$scope.deleteFromSharedC=function(usid){$rootScope.showModalWindow("Usunięcie pozwolenia na wgląd",function(){request.backend("deleteSharedForConsp",{aid:$rootScope.sharedConspId,usid},function(data){$scope.loadSharedListC()},"Usunięto pozwolenie na wgląd")})}}),app.controller("showConspectController",function($scope,auth,$rootScope,notify,request,$location,$compile){$scope.showContent=!1,$scope.conspect=null,$scope.initConspect=function(){$rootScope.consepectShowId&&null!=$rootScope.consepectShowId&&$rootScope.consepectShowId>=0&&($scope.loadConspect($rootScope.consepectShowId),$rootScope.consepectShowId=null)},$scope.loadConspect=function(id){request.backend("getFullConspectById",{id},function(data){$scope.$apply(function(){$scope.conspect=data,$scope.conspect.tags=$scope.conspect.tags.replace("  "," "),$scope.conspect.tags=$scope.conspect.tags.split(" "),$scope.showContent=!0}),setTimeout(function(){$(".gifplayer").each(function(){$(this).hasClass("isGifed")||($(this).addClass("isGifed"),$(this).gifplayer())})},500)})}}),app.controller("TrainingConspectusController",function($scope,auth,$rootScope,notify,request,$location,$compile){$scope.showContent=!1,$scope.animArray=[],$scope.showAnimCreator=!1,$scope.allCoElement=[],$scope.conspectArray=[],$rootScope.lastPlaceInConspect=null,$rootScope.sharedAnimId=null,$rootScope.sharedConspId=null,$scope.coActualId=-1,$scope.coName="",$scope.coMaster="",$scope.coDate="",$scope.coPlace="",$scope.sezon="",$scope.coTeam="",$scope.coOp="",$scope.coPower="",$scope.coUserCount="",$scope.coTags="",$rootScope.widgetInterval&&clearInterval($rootScope.widgetInterval),$rootScope.widgetInterval=setInterval(function(){$rootScope.widgetResponse&&null!=$rootScope.widgetResponse&&($scope.addCwCo({place:$rootScope.lastPlaceInConspect,name:$rootScope.widgetResponse.name,id:$rootScope.widgetResponse.id}),$rootScope.widgetResponse=null)},200),$scope.loadConspect=function(id){request.backend("getConspectById",{id},function(data){$scope.$apply(function(){$scope.coActualId=id,$scope.coName=data.name,$scope.coMaster=data.master,$scope.coDate=data.date,$scope.coPlace=data.place,$scope.sezon=data.sezon,$scope.coTeam=data.team,$scope.coOp=data.about,$scope.coPower=data.powerCount,$scope.coUserCount=data.userCount,$scope.coTags=data.tags.split(" ")});for(var tagTo={data:[]},ind=0;ind<$scope.coTags.length;ind++)tagTo.data.push({tag:$scope.coTags[ind]});$(".chips-placeholder").material_chip(tagTo);for(var fullFieldData=JSON.parse(data.data),i=0;i<fullFieldData.length;i++)if("simple"==fullFieldData[i].type)$scope.addSimpleFieldCo(fullFieldData[i].data.place),$scope.allCoElement[$scope.allCoElement.length-1].data={content:fullFieldData[i].data.content,timeMin:fullFieldData[i].data.timeMin,timeMax:fullFieldData[i].data.timeMax,wsk:fullFieldData[i].data.wsk,place:fullFieldData[i].data.place};else{var fieldData={id:fullFieldData[i].data.id,name:fullFieldData[i].data.name,place:fullFieldData[i].data.place};$scope.addCwCo(fieldData)}})},$scope.selectFromWidget=function(place){$rootScope.lastPlaceInConspect=place,$rootScope.showWidget("selectTraining","TrainingConspectus")},$rootScope.editConspectWithId&&null!=$rootScope.editConspectWithId&&$rootScope.editConspectWithId>=0&&($scope.loadConspect($rootScope.editConspectWithId),$rootScope.editConspectWithId=null),$scope.goToEditConspect=function(id){$rootScope.editConspectWithId=id,$location.url("/conspectusAdd")},$scope.initConsectusCreate=function(){$scope.showContent=!0},$scope.initConsAnimList=function(){request.backend("getListOfAnimConspect",{usid:$rootScope.user.id},function(data){$scope.$apply(function(){$scope.animArray=data;for(var i=0;i<$scope.animArray.length;i++){var tags=$scope.animArray[i].tags.replace("  "," ").split(" ");$scope.animArray[i].tags=[];for(var x=0;x<tags.length;x++)$scope.animArray[i].tags.push(tags[x])}$scope.showContent=!0,$rootScope.idFromAnimConspectToEdit=null,setInterval(function(){$(".gifplayer").each(function(){$(this).hasClass("isGifed")||($(this).addClass("isGifed"),$(this).gifplayer())})},500)})})},$scope.initConspectusAdd=function(){$scope.showContent=!0},$scope.initConspectusList=function(){request.backend("getAllConspectList",{usid:$rootScope.user.id},function(data){$scope.conspectArray=data;for(var i=0;i<$scope.conspectArray.length;i++){var tags=$scope.conspectArray[i].tags.replace("  "," ").split(" ");$scope.conspectArray[i].tags=[];for(var x=0;x<tags.length;x++)$scope.conspectArray[i].tags.push(tags[x])}$scope.showContent=!0})},$scope.editAnimCon=function(id){$rootScope.idFromAnimConspectToEdit=id,$location.url("/conspectusAnim")},$scope.deleteAnimCon=function(id){$rootScope.showModalWindow("Nieodwracalne usunięcie ćwiczenia",function(){request.backend("deleteAnimConspect",{id},function(data){$scope.initConsAnimList()},"Pomyślnie usunięto")})},$scope.showShareWidget=function(aid,isConspect=!1){isConspect?($rootScope.sharedConspId=aid,$rootScope.showWidget("shareListC","TrainingConspectus")):($rootScope.sharedAnimId=aid,$rootScope.showWidget("shareList","TrainingConspectus"))},$scope.addSimpleFieldCo=function(placeId){var thisId=$scope.allCoElement.length;$scope.allCoElement.push({id:thisId,type:"simple",status:"on",data:{content:"",timeMin:1,timeMax:2,wsk:"",place:placeId}});var el="<div class='coElement' id='"+thisId+"-simpleField'><div ng-click='deleteField("+thisId+");' style='position: absolute; top: 9px; right: 20px; color: white; font-size: 20px; cursor: pointer'><i class='fa fa-times' aria-hidden='true' ></i></div><div class='form-group'><div class='row'><div class='input-field col s12 m6'><input id='"+thisId+"-simpleContent' type='text' placeholder='Treść' class='validate' ng-model='allCoElement["+thisId+"].data.content' required><label for='"+thisId+"-simpleContent'>Treść</label></div><div class='input-field col s12 m3'><input id='"+thisId+"-simpleMinTime' type='text' ng-model='allCoElement["+thisId+"].data.timeMin' placeholder='Czas min' class='validate' required><label for='"+thisId+"-simpleMinTime'>Czas min</label></div><div class='input-field col s12 m3'><input id='"+thisId+"-simpleMaxTime' type='text' ng-model='allCoElement["+thisId+"].data.timeMax' placeholder='Czas max' class='validate' required><label for='"+thisId+"-simpleMaxTime'>Czas max</label></div><div class='input-field col s12'><textarea id='"+thisId+"-simpleWsk' placeholder='Wskazówki' ng-model='allCoElement["+thisId+"].data.wsk' class='materialize-textarea' data-length='255'></textarea><label for='"+thisId+"-simpleWsk'>Wskazówki</label></div></div></div></div>",element=angular.element($("#"+placeId).find(".data").first()),generated=element.html(element.html()+el);$compile(generated.contents())($scope),Materialize.updateTextFields()},$scope.addCwCo=function(response){var thisId=$scope.allCoElement.length;$scope.allCoElement.push({id:thisId,type:"training",status:"on",data:{id:response.id,name:response.name,place:response.place}});var el="<div class='coElement' id='"+thisId+"-simpleField'><div ng-click='deleteField("+thisId+");' style='position: absolute; top: 9px; right: 20px; color: white; font-size: 20px; cursor: pointer'><i class='fa fa-times' aria-hidden='true' ></i></div> <b>Ćwiczenie: </b>"+response.name+"  </div>",element=angular.element($("#"+response.place).find(".data").first()),generated=element.html(element.html()+el);$compile(generated.contents())($scope),Materialize.updateTextFields()},$scope.deleteField=function(id){$scope.allCoElement[id].status="off",$("#"+id+"-simpleField").hide(200)},$scope.saveConspect=function(){if($scope.coName=$("#coName").val(),$scope.coDate=$("#coDate").val(),$scope.coPlace=$("#coPlace").val(),$scope.sezon=$("#sezon").val(),$scope.coTeam=$("#coTeam").val(),$scope.coOp=$("#coOp").val(),$scope.coPower=$("#coPower").val(),$scope.coUserCount=$("#coUserCount").val(),$scope.coTags=$(".chips-placeholder").material_chip("data"),$scope.coName&&""!=$scope.coName&&" "!=$scope.coName&&null!=$scope.coName)if($scope.coDate&&""!=$scope.coDate&&" "!=$scope.coDate&&null!=$scope.coDate)if($scope.coPlace&&""!=$scope.coPlace&&" "!=$scope.coPlace&&null!=$scope.coPlace)if($scope.coTeam&&""!=$scope.coTeam&&" "!=$scope.coTeam&&null!=$scope.coTeam)if(!$scope.coTags||$scope.coTags.length<2)notify.localNotify("Walidacja","Wpisz przynajmniej dwie frazy, z którymi będzie kojarzony dany konspekt");else{for(var dataToSend=[],isError=!1,i=0;i<$scope.allCoElement.length;i++)if("on"==$scope.allCoElement[i].status){if("simple"==$scope.allCoElement[i].type){""==$scope.allCoElement[i].data.content&&(notify.localNotify("Walidacja","Wpisz treść wszystkich prostych pól w konspekcie"),isError=!0);var minT=parseInt($scope.allCoElement[i].data.timeMin);0==minT&&(notify.localNotify("Walidacja","Wpisz poprawnie wszystkie minimalne wartosci czasu w prostych polach"),isError=!0);var maxT=parseInt($scope.allCoElement[i].data.timeMax);if((0==maxT||maxT<=minT)&&(notify.localNotify("Walidacja","Wpisz poprawnie wszystkie maksymalne wartosci czasu w prostych polach"),isError=!0),isError)return}dataToSend.push({type:$scope.allCoElement[i].type,data:$scope.allCoElement[i].data,place:$scope.allCoElement[i].place})}for(var allTagString="",x=0;x<$scope.coTags.length;x++)allTagString+=" ",allTagString+=$scope.coTags[x].tag;var toSend={id:$scope.coActualId,coName:$scope.coName,id_user:$rootScope.user.id,coDate:$scope.coDate,coPlace:$scope.coPlace,sezon:$scope.sezon,coTeam:$scope.coTeam,coOp:$scope.coOp,powerCount:$scope.coPower,userCount:$scope.coUserCount,coTags:allTagString,data:JSON.stringify(dataToSend)};request.backend("saveConspect",toSend,function(data){$location.url("/conspectusList")},"Pomyślnie zapisano")}else notify.localNotify("Walidacja","Wpisz przedział wiekowy");else notify.localNotify("Walidacja","Wpisz miejsce");else notify.localNotify("Walidacja","Wpisz date");else notify.localNotify("Walidacja","Wpisz nazwę danego konspektu")},$scope.showThisContent=function(id){$rootScope.consepectShowId=id,$location.url("/showConspect")},$scope.deleteCon=function(id){$rootScope.showModalWindow("Nieodwracalne usunięcie konspektu",function(){request.backend("deleteConspect",{id},function(data){$scope.initConspectusList()},"Pomyślnie usunięto")})}}),app.controller("TrainingListAdditionalController",function($scope,auth,$rootScope,notify,request,$location,$compile){$scope.showContent=!1,$scope.initConsAnimList=function(){request.backend("getListOfAnimConspect",{usid:$rootScope.user.id},function(data){$scope.$apply(function(){$scope.animArray=data;for(var i=0;i<$scope.animArray.length;i++){var tags=$scope.animArray[i].tags.split(" ");$scope.animArray[i].tags=[];for(var x=0;x<tags.length;x++)$scope.animArray[i].tags.push(tags[x])}$scope.showContent=!0,$rootScope.idFromAnimConspectToEdit=null,setInterval(function(){$(".gifplayer").each(function(){$(this).hasClass("isGifed")||($(this).addClass("isGifed"),$(this).gifplayer())})},500)})})},$scope.initConspectusList=function(){request.backend("getAllConspectList",{usid:$rootScope.user.id},function(data){$scope.conspectArray=data;for(var i=0;i<$scope.conspectArray.length;i++){var tags=$scope.conspectArray[i].tags.split(" ");$scope.conspectArray[i].tags=[];for(var x=0;x<tags.length;x++)$scope.conspectArray[i].tags.push(tags[x])}$scope.showContent=!0})},$scope.editAnimCon=function(id){$rootScope.idFromAnimConspectToEdit=id,$location.url("/conspectusAnim")},$scope.deleteAnimCon=function(id){$rootScope.showModalWindow("Nieodwracalne usunięcie animacji",function(){request.backend("deleteAnimConspect",{id},function(data){$scope.initConsAnimList()},"Pomyślnie usunięto")})},$scope.addSimpleFieldCo=function(placeId){var thisId=$scope.allCoElement.length;$scope.allCoElement.push({id:thisId,type:"simple",status:"on",data:{content:"",timeMin:1,timeMax:2,wsk:"",place:placeId}});var el="<div class='coElement' id='"+thisId+"-simpleField'><div ng-click='deleteField("+thisId+");' style='position: absolute; top: 9px; right: 20px; color: white; font-size: 20px; cursor: pointer'><i class='fa fa-times' aria-hidden='true' ></i></div><div class='form-group'><div class='row'><div class='input-field col s12 m6'><input id='"+thisId+"-simpleContent' type='text' placeholder='Treść' class='validate' ng-model='allCoElement["+thisId+"].data.content' required><label for='"+thisId+"-simpleContent'>Treść</label></div><div class='input-field col s12 m3'><input id='"+thisId+"-simpleMinTime' type='text' ng-model='allCoElement["+thisId+"].data.timeMin' placeholder='Czas min' class='validate' required><label for='"+thisId+"-simpleMinTime'>Czas min</label></div><div class='input-field col s12 m3'><input id='"+thisId+"-simpleMaxTime' type='text' ng-model='allCoElement["+thisId+"].data.timeMax' placeholder='Czas max' class='validate' required><label for='"+thisId+"-simpleMaxTime'>Czas max</label></div><div class='input-field col s12'><textarea id='"+thisId+"-simpleWsk' placeholder='Wskazówki' ng-model='allCoElement["+thisId+"].data.wsk' class='materialize-textarea' data-length='255'></textarea><label for='"+thisId+"-simpleWsk'>Wskazówki</label></div></div></div></div>",element=angular.element($("#"+placeId).find(".data").first()),generated=element.html(element.html()+el);$compile(generated.contents())($scope),Materialize.updateTextFields()},$scope.addCwCo=function(response){var thisId=$scope.allCoElement.length;$scope.allCoElement.push({id:thisId,type:"training",status:"on",data:{id:response.id,name:response.name,place:response.place}});var el="<div class='coElement' id='"+thisId+"-simpleField'><div ng-click='deleteField("+thisId+");' style='position: absolute; top: 9px; right: 20px; color: white; font-size: 20px; cursor: pointer'><i class='fa fa-times' aria-hidden='true' ></i></div> <b>Ćwiczenie: </b>"+response.name+"  </div>",element=angular.element($("#"+response.place).find(".data").first()),generated=element.html(element.html()+el);$compile(generated.contents())($scope),Materialize.updateTextFields()},$scope.deleteField=function(id){$scope.allCoElement[id].status="off",$("#"+id+"-simpleField").hide(200)},$scope.saveConspect=function(){if($scope.coName=$("#coName").val(),$scope.coMaster=$("#coMaster").val(),$scope.coDate=$("#coDate").val(),$scope.coSezon=$("#coSezon").val(),$scope.coTeam=$("#coTeam").val(),$scope.coOp=$("#coOp").val(),$scope.coTags=$(".chips-placeholder").material_chip("data"),$scope.coName&&""!=$scope.coName&&" "!=$scope.coName&&null!=$scope.coName)if($scope.coMaster&&""!=$scope.coMaster&&" "!=$scope.coMaster&&null!=$scope.coMaster)if($scope.coDate&&""!=$scope.coDate&&" "!=$scope.coDate&&null!=$scope.coDate)if($scope.coSezon&&""!=$scope.coSezon&&" "!=$scope.coSezon&&null!=$scope.coSezon)if($scope.coTeam&&""!=$scope.coTeam&&" "!=$scope.coTeam&&null!=$scope.coTeam)if(!$scope.coTags||$scope.coTags.length<2)notify.localNotify("Walidacja","Wpisz przynajmniej dwie frazy, z którymi będzie kojarzony dany konspekt");else{for(var dataToSend=[],isError=!1,i=0;i<$scope.allCoElement.length;i++)if("on"==$scope.allCoElement[i].status){if("simple"==$scope.allCoElement[i].type){""==$scope.allCoElement[i].data.content&&(notify.localNotify("Walidacja","Wpisz treść wszystkich prostych pól w konspekcie"),isError=!0);var minT=parseInt($scope.allCoElement[i].data.timeMin);0==minT&&(notify.localNotify("Walidacja","Wpisz poprawnie wszystkie minimalne wartosci czasu w prostych polach"),isError=!0);var maxT=parseInt($scope.allCoElement[i].data.timeMax);if((0==maxT||maxT<=minT)&&(notify.localNotify("Walidacja","Wpisz poprawnie wszystkie maksymalne wartosci czasu w prostych polach"),isError=!0),isError)return}dataToSend.push({type:$scope.allCoElement[i].type,data:$scope.allCoElement[i].data,place:$scope.allCoElement[i].place})}for(var allTagString="",x=0;x<$scope.coTags.length;x++)allTagString+=" ",allTagString+=$scope.coTags[x].tag;var toSend={id:$scope.coActualId,coName:$scope.coName,coMaster:$scope.coMaster,coDate:$scope.coDate,coSezon:$scope.coSezon,coTeam:$scope.coTeam,coOp:$scope.coOp,coTags:allTagString,data:JSON.stringify(dataToSend),usid:$rootScope.user.id};request.backend("saveConspect",toSend,function(data){$location.url("/conspectusList")},"Pomyślnie zapisano")}else notify.localNotify("Walidacja","Wpisz przedział wiekowy");else notify.localNotify("Walidacja","Wpisz nazwę sezonu");else notify.localNotify("Walidacja","Wpisz date");else notify.localNotify("Walidacja","Wpisz imie, nazwisko trenera");else notify.localNotify("Walidacja","Wpisz nazwę danego konspektu")},$scope.showThisContent=function(id){$rootScope.consepectShowId=id,$location.url("/showConspect")},$scope.deleteCon=function(id){$rootScope.showModalWindow("Nieodwracalne usunięcie konspektu",function(){request.backend("deleteConspect",{id},function(data){$scope.initConspectusList()},"Pomyślnie usunięto")})}}),app.controller("showAnalizeController",function($scope,auth,$rootScope,notify,request){$scope.showContent=!1,$scope.fragmentList=[],$scope.loadAnalizeById=function(){request.backend("getAnalizeFragment",{id:$rootScope.analizeId},function(data){$scope.$apply(function(){for(let i=0;i<data.length;i++){var isExist=!1;for(let x=0;x<$scope.fragmentList.length;x++)if($scope.fragmentList[x].name==data[i].name){$scope.fragmentList[x].list.push({start_time:data[i].start_time,end_time:data[i].end_time,url:data[i].url}),isExist=!0;break}isExist||$scope.fragmentList.push({name:data[i].name,list:[{start_time:data[i].start_time,end_time:data[i].end_time,url:data[i].url}]})}$scope.showContent=!0})})},$scope.showInPlayer=function(url){$("#videoPlayerContMain").show(),$("#videoPlayerContMain video").first().attr("src",url),$("#videoPlayerContMain video")[0].load()}}),app.controller("videoController",function($scope,auth,$rootScope,notify,request,$location){$scope.showContent=!1,$scope.showVideoPlayer=!1,$scope.fragmentName="",$scope.fragmentList=[],$scope.endFragmentSelect=!1,$scope.showSendProgressBar=!1,$scope.stillIsSending=!0,$scope.analizeList=[],$scope.iconList=[],$scope.selectedList=[];var start,end,fullTime,player,progressBar,cutterStart=null,cutterEnd=null;function updatePointPosition(){var parent=$("#endIconPoint").parent().parent();$("#endIconPoint").css("left",cutterEnd/end*parent.width()),$("#startIconPoint").css("left",cutterStart/end*parent.width())}function addArrowPoint(thisEl,isRed,isEnd=!1){var player=thisEl,currTimeElement=player.next().next().find(".currentTime").first(),positionForArrow={top:-10,left:currTimeElement.width()};isEnd&&(positionForArrow.left=player.next().next().width());var colorClass=isRed?"arrowRed":"arrowGreen",id=isRed?"endIconPoint":"startIconPoint";$("#"+id).remove();var element="<div id='"+id+"' class='arrow-up "+colorClass+"'><i class='fa fa-arrows-v fa-2x' aria-hidden='true'></i></div>";isRed?(cutterEnd=player[0].currentTime,isEnd&&(cutterEnd=end)):cutterStart=player[0].currentTime,element=currTimeElement.append(element),$("#"+id).css("top",positionForArrow.top),$("#"+id).css("left",positionForArrow.left)}function stopPlayer(player,interval){$(player).next().find("i").first().removeClass("fa-pause-circle"),$(player).next().find("i").first().addClass("fa-play-circle"),player.pause(),clearInterval(interval)}function playPlayer(player,end,progressBar,start,fullTime){var thisInterval;return $(player).next().find("i").first().removeClass("fa-play-circle"),$(player).next().find("i").first().addClass("fa-pause-circle"),player.play(),player.currentTime<cutterStart&&(player.currentTime=cutterStart),(player.currentTime>=end||null!=cutterEnd&&player.currentTime>=cutterEnd)&&(player.currentTime=start,null!=cutterStart&&(player.currentTime=cutterStart)),thisInterval=setInterval(function(){player.currentTime>=end||null!=cutterEnd&&player.currentTime>=cutterEnd?stopPlayer(player,thisInterval):updateProgressAndTime(player,progressBar.find(".currentTime").first(),start,fullTime)},30)}function updateProgressAndTime(player,progressBar,start,fullTime){var actualTime=Math.ceil(player.currentTime)-start;actualTime=actualTime>fullTime?fullTime:actualTime;var percent=(player.currentTime-start)/fullTime*100;actualTime=(actualTime/100).toFixed(2),fullTime=(fullTime/100).toFixed(2),$(player).next().next().next().html(actualTime+"<span>/</span>"+fullTime),percent=percent>100?100:percent,progressBar.css("width",percent+"%")}$scope.initVideo=function(){request.backend("getVideoIconFull",{},function(data){$scope.$apply(function(){$scope.showContent=!0,$scope.iconList=data}),setTimeout(()=>{$(".tooltipped").tooltip({delay:50})},500)})},$scope.initOptionsVid=function(){request.backend("getVideoIcon",{},function(data){$scope.$apply(function(){$scope.showContent=!0,$scope.iconList=data})})},$scope.deleteIcon=function(id){request.backend("deleteVideoIcon",{id},function(data){$scope.initOptionsVid()},"Usuwanie przebiegło pomyślnie")},$(document).off("change","#iconAdder"),$(document).on("change","#iconAdder",function(){request.backend("addVideoIcon",new FormData($("#iconAdderForm")[0]),function(data){$scope.initOptionsVid()},"Dodano nową ikonę",!0)}),$(document).off("change",".analizeChecked"),$(document).on("change",".analizeChecked",function(){const thisElement=$(this);$scope.$apply(function(){const id=thisElement.attr("id").split("-")[1];"all"!=id?thisElement.is(":checked")?function(id){for(let i=0;i<$scope.selectedList.length;i++)if($scope.selectedList[i]==id)return;$scope.selectedList.push(id)}(id):function(id){for(let i=0;i<$scope.selectedList.length;i++)if($scope.selectedList[i]==id)return void $scope.selectedList.splice(i,1)}(id):thisElement.is(":checked")?($scope.selectedList=[],$(".analizeChecked").each(function(){const id=$(this).attr("id").split("-")[1];$(this).prop("checked",!0),"all"!=id&&$scope.selectedList.push(id)})):($scope.selectedList=[],$(".analizeChecked").each(function(){$(this).attr("id").split("-")[1];$(this).prop("checked",!1)}))})}),$scope.deleteList=function(){$rootScope.showModalWindow("Nieodwracalne usunięcie analiz w liczbie: "+$scope.selectedList.length,function(){for(let i=0;i<$scope.selectedList.length;i++){request.backend("deleteAnalize",{id:$scope.selectedList[i]},function(data){});for(let j=0;j<$scope.analizeList.length;j++)if($scope.analizeList[j].id==$scope.selectedList[i]){$scope.$apply(function(){$scope.analizeList.splice(j,1)});break}}})},$(document).off("change",".iconInput"),$(document).on("change",".iconInput",function(){var id=$(this).attr("id").split("-")[1],value=$(this).val();$scope.saveIcon(id,value)}),$scope.saveIcon=function(id,value){request.backend("saveVideoIcon",{id,value},function(data){})},$(document).off("click",".oneIconfToAnalizer"),$(document).on("click",".oneIconfToAnalizer",function(){var name=$(this).data("analize-name");$(".oneIconfToAnalizer").each(function(){$(this).removeClass("oneIconfToAnalizerActive")}),$(this).addClass("oneIconfToAnalizerActive"),$("#fragmentName").val(name),$scope.$apply(function(){$scope.addFragment()})}),$(document).off("change","#videoToAnalize"),$(document).on("change","#videoToAnalize",function(){var source=$("#playerVid");source.on("loadedmetadata",function(){$scope.$apply(function(){$scope.showVideoPlayer=!0}),setTimeout(()=>{start=0,end=parseFloat(this.duration).toFixed(3),fullTime=end-start,progressBar=$(this).next().next();var mainInterval,playStopButton=$(this).next().find("i").first(),resetButton=$(this).next().find("i").eq(1);(player=this).currentTime=start,addArrowPoint($(this),!1),addArrowPoint($(this),!0,!0),$("#startIconPoint").draggable({axis:"x",opacity:.5,stop:function(e,ui){var element=$("#startIconPoint"),parent=$("#startIconPoint").parent().parent();parseFloat(element.css("left"))<0?element.css("left",0):parseFloat(element.css("left"))>parent.width()&&element.css("left",parent.width());var maxWidth=parent.width(),position=parseFloat(element.css("left"));cutterStart=(start+position/maxWidth*fullTime).toFixed(3),player.currentTime=cutterStart,updateProgressAndTime(player,progressBar.find(".currentTime").first(),start,fullTime)}}),$("#endIconPoint").draggable({axis:"x",opacity:.5,stop:function(e,ui){var element=$("#endIconPoint"),parent=$("#endIconPoint").parent().parent();parseFloat(element.css("left"))<0?element.css("left",0):parseFloat(element.css("left"))>parent.width()&&element.css("left",parent.width());var maxWidth=parent.width(),position=parseFloat(element.css("left"));cutterEnd=(start+position/maxWidth*fullTime).toFixed(3),player.currentTime=cutterEnd,updateProgressAndTime(player,progressBar.find(".currentTime").first(),start,fullTime)}}),progressBar.on("click",function(e){var offset=$(this).offset(),position=e.pageX-offset.left,maxWidth=$(this).width(),time=(start+position/maxWidth*fullTime).toFixed(3);player.currentTime=time,updateProgressAndTime(player,progressBar.find(".currentTime").first(),start,fullTime)}),resetButton.on("click",function(e){player.currentTime=start,cutterStart=start,cutterEnd=end,updateProgressAndTime(player,progressBar.find(".currentTime").first(),start,fullTime),stopPlayer(player,mainInterval)}),playStopButton.on("click",function(){$(this).hasClass("fa-play-circle")?mainInterval=playPlayer(player,end,progressBar,start,fullTime):stopPlayer(player,mainInterval)}),updateProgressAndTime(player,progressBar.find(".currentTime").first(),start,fullTime)},300)}),source[0].src=URL.createObjectURL(this.files[0])}),$scope.saveAnalize=function(){if($("#analizeName").val().length<=3)notify.localNotify("Walidacja","Podaj dłuższą nazwę analizy");else if($("#analizeName").val().length>100)notify.localNotify("Walidacja","Podaj krótszą nazwę analizy");else if($("#analizeDescription").val().length>500)notify.localNotify("Walidacja","Podaj krótszy opis");else if($scope.fragmentList.length<=0)notify.localNotify("Walidacja","Nie wyznaczyłeś żadnych fragmentów z danego klipu video. Wyznacz przynajmniej jeden.");else{$scope.showSendProgressBar=!0;var countChunk=0,fileSize=$("#videoToAnalize").prop("files")[0].size,chunkSize=fileSize<3e6?fileSize/2:3e6,maxChunk=Math.ceil(fileSize/chunkSize);$("#videoToAnalize").fileupload({maxChunkSize:chunkSize,files:$("#videoToAnalize").prop("files")[0],url:"backend/saveVideoClip"}).on("fileuploadchunkdone",function(e,data){countChunk++,$(".progresBarSender").find("span").first().html(parseInt(countChunk/maxChunk*100)+"%"),$(".progresBarSenderPrc").first().css("width",parseInt(countChunk/maxChunk*100)+"%")}),$("#videoToAnalize").fileupload("send",{maxChunkSize:chunkSize,files:$("#videoToAnalize").prop("files")[0],url:"backend/saveVideoClip",singleFileUploads:!0,multipart:!1,acceptFileTypes:/(\.|\/)(gif|jpe?g|png|mp4)$/i}).error(function(result,textStatus,jqXHR){notify.localNotify("Błąd podczas przesyłania","Przepraszamy nie możemy teraz obsłużyć tego żadania"),console.log($("#videoToAnalize").prop("files"))}).complete(function(result,textStatus,jqXHR){notify.localNotify("Zapis na serwerze","Twój film został właśnie zapisany na serwerze. Poczekaj jeszcze chwilkę"),$scope.stillIsSending=!1,request.backend("saveFragments",{usid:$rootScope.user.id,frName:$("#analizeName").val(),frDescription:$("#analizeDescription").val(),frList:$scope.fragmentList,videoName:$("#videoToAnalize").prop("files")[0].name},function(data){$scope.$apply(function(){$location.url("/analizeList")})},"Zapis zakończony")})}},$scope.deleteAnalize=function(id){$rootScope.showModalWindow("Nieodwracalne usunięcie analizay video",function(){request.backend("deleteAnalize",{id},function(data){$scope.$apply(function(){for(let i=0;i<$scope.analizeList.length;i++)if($scope.analizeList[i].id==id){$scope.analizeList.splice(i,1);break}})},"Pomyślnie usunięto")})},$scope.showAnalize=function(id){$rootScope.analizeId=id,$rootScope.showWidget("showAnalize","VideoAnalizer")},$scope.loadAnalize=function(){request.backend("getAnalizeList",{},function(data){$scope.$apply(function(){$scope.showContent=!0,$scope.analizeList=data})})},$scope.addFragment=function(){if($("#fragmentName").val().length<=3)notify.localNotify("Walidacja","Podaj dłuższą nazwę fragmentu");else if($("#fragmentName").val().length>100)notify.localNotify("Walidacja","Podaj krótszą nazwę fragmentu");else{fragmentName=$("#fragmentName").val();var finded=!1;for(let i=0;i<$scope.fragmentList.length;i++)if($scope.fragmentList[i].name==fragmentName){$scope.fragmentList[i].list.push({start:(parseFloat(cutterStart)/100).toFixed(3),end:(parseFloat(cutterEnd)/100).toFixed(3)}),finded=!0;break}finded||$scope.fragmentList.push({name:fragmentName,list:[{start:(parseFloat(cutterStart)/100).toFixed(3),end:(parseFloat(cutterEnd)/100).toFixed(3)}]})}},$scope.editFragment=function(name,index){var time=null,ins=0;for(let i=0;i<$scope.fragmentList.length;i++)if($scope.fragmentList[i].name==name){ins=i,time=$scope.fragmentList[i].list[index]?$scope.fragmentList[i].list[index]:null;break}time&&($("#playerVid")[0].currentTime=(100*time.start).toFixed(3),cutterStart=(100*time.start).toFixed(3),cutterEnd=(100*time.end).toFixed(3),updatePointPosition(),$("#fragmentName").val(name),$scope.fragmentList[ins].list.splice(index,1),0==$scope.fragmentList[ins].list.length&&$scope.fragmentList.splice(ins,1),playPlayer($("#playerVid")[0],end,progressBar,start,fullTime),$(".oneIconfToAnalizer").each(function(){$(this).removeClass("oneIconfToAnalizerActive"),$(this).data("analize-name")==name&&$(this).addClass("oneIconfToAnalizerActive")}))},$(window).resize(function(){updatePointPosition()})}),app.controller("loginController",function($scope,auth,request){$scope.isActiveApplayer=!1,$scope.initLogin=function(){auth.checkIsLogged()&&(document.location="panel");request.sync("POST","backend/isApplayerActive",{},function(reqData){reqData.success&&($scope.isActiveApplayer=reqData.data)},function(jqXHR,textStatus){console.log("Bład podczas komunikacji z serverem: "+textStatus),!1})},$scope.login=function(email,password){if(null==email||null==password)$(".error").html("<p> Podaj poprawnie dane </p>");else{var req=auth.logIn(email,password);req.success?document.location="panel":$(".error").html("<p>"+req.error+"</p>")}},$scope.registerNewAccount=function(){var firstname=$("#registerFristname").val(),lastname=$("#registerLastname").val(),email=$("#registerEmail").val();if(!firstname||firstname.length<3||firstname.length>30)$(".errorRegister").html("<p> Podaj poprawnie imię ( min 3 maks 30 znaków ) </p>");else if(!lastname||lastname.length<3||lastname.length>30)$(".errorRegister").html("<p> Podaj poprawnie nazwisko ( min 3 maks 30 znaków ) </p>");else if(!email||email.length<3)$(".errorRegister").html("<p> Podaj poprawnie adres email </p>");else{var dataToSend={firstname,lastname,email};request.sync("POST","backend/registerNewApplayer",dataToSend,function(reqData){reqData.success?$(".successRegister").html("<p> Twoje konto zostało utworzone. Wysłaliśmy wiadomość na Twój adres email. Znajduję się w nim hasło, po uzyskaniu go możesz skorzystać z panelu logowania obok. </p>"):$(".errorRegister").html("<p> "+reqData.error+" </p>")},function(jqXHR,textStatus){console.log("Bład podczas komunikacji z serverem: "+textStatus),!1})}}}),app.controller("mainController",function($scope,auth,$rootScope,$route,notify,request,$compile,$location){$rootScope.viewPerm=["TRENER","ZAWODNIK","KOORD","STAFF"],$scope.contentLoaded=!1,$rootScope.newNotify=[],$rootScope.allNotify=[],$rootScope.lastNotId=0,$rootScope.notifyCount=0,$rootScope.mainSettings=[],$scope.showAllNewsNotify=!1,$rootScope.editConspectWithId=null,$rootScope.consepectShowId=null,$rootScope.widgetResponse=null,$rootScope.teamNameStr="",$rootScope.showAdw=!0,$rootScope.user={email:"",token:"",role:"",firstname:"",lastname:"",birthdate:"",imgPath:"",id:"",tmid:"",height:"",tel:"",parentTel:"",weight:"",mainLeg:"",mainPosition:"",address:"",bodyType:"",license_type:""},$rootScope.feedType="opinia",$scope.turnOffAdw=function(){$rootScope.showAdw=!1},$scope.goFeed=function(type){$rootScope.feedType=type,$location.url("/feedback")},$scope.showNotifications=function(isMainClik=!0){isMainClik?(0==$scope.showAllNewsNotify?$scope.showAllNewsNotify=!0:$scope.showAllNewsNotify=!1,notify.setNewOff()):$scope.showAllNewsNotify=!1},$rootScope.closeWidget=function(response=null){$rootScope.widgetResponse=response,$("#widgetContainer").hide("slide",{},200)},$rootScope.dayToDate=function(date){var a=moment(),diffDays=moment([date.split("/")[2],date.split("/")[1]-1,date.split("/")[0]]).diff(a,"days"),color=diffDays>30?"#30a42e":diffDays<14?"#a32d1f":"#eab233";return $(".licenseEndDay").css("color",color),diffDays},$rootScope.showWidget=function(widgetName,moduleName){$.get("modules/"+moduleName+"/assets/widget/"+widgetName+".html",function(data){var content=$compile(data="<button class='waves-effect waves-light btn widgetClose' style='width:100%' ng-click='closeWidget();' >Zamknij okno</button>"+data)($scope);$(".widgetContentContainer").html(""),$(".widgetContentContainer").append(content),$("#widgetContainer").show("slide",{},200)})},$rootScope.showModalWindow=function(text,agreeFunction,disagreeFunction=null){var content=$compile("<h5 style='padding: 10px 20px;'>Czy jesteś pewny tego działania ?</h5><p style='padding: 0 20px 20px;'>"+text+"</p><button class='waves-effect waves-light btn widgetClose' style='width:calc(50% - 40px); float:left; margin: 0 20px 20px;' id='widgetAgree' >Tak, wykonaj</button><button class='waves-effect waves-light btn widgetClose' style='width:calc(50% - 40px); float:left; margin: 0 20px 20px;' id='widgetDisagree' >Anuluj</button>")($scope);$(".widgetContentContainer").html(""),$(".widgetContentContainer").append(content),$("#widgetContainer").show("slide",{},200),$(document).off("click","#widgetAgree"),$(document).on("click","#widgetAgree",function(){$rootScope.closeWidget(),agreeFunction()}),$(document).off("click","#widgetDisagree"),$(document).on("click","#widgetDisagree",function(){$rootScope.closeWidget(),disagreeFunction&&disagreeFunction()})},$(document).keyup(function(e){27===e.keyCode&&$rootScope.closeWidget()}),$scope.mainInit=function(){auth.checkIsLogged()?auth.getUserData().success?(request.backend("getMainPageSettings",{},function(data){$rootScope.$apply(function(){$rootScope.mainSettings=data})}),request.backend("getTeams",{},function(data){if(0==data.length)notify.localNotify("Uwaga","Twoje konto będzie ograniczone dopóki nie zostaniesz przypisany do sekcji");else{$("#teamSelect").html(""),$("#teamSelect").append("<option value='' disabled> Wybierz sekcję </option>");for(var i=0;i<data.length;i++)$("#teamSelect").append("<option value='"+data[i].tmid+"'"+(0==i?"selected":"")+">"+data[i].name+"</option>");null!=data[0]&&null!=data[0].tmid&&($rootScope.user.tmid=data[0].tmid,$rootScope.teamNameStr=data[0].name)}setTimeout(function(){$("#loadingContent").hide("slide",{},1e3),$("#mainContent").show("fade",{},1e3),document.location.href="/panel#!/",$route.reload(),notify.getNew(!0),setInterval(function(){notify.getNew()},5e3)},500),$("select").material_select()})):document.location="login":auth.logout()},$(document).on("click","#printButton",function(){$("body").prepend($("#main-content-in"));$("body>div").each(function(){"main-content-in"!=$(this).attr("id")&&$(this).addClass("noPrint")});$(".ng-hide").each(function(){$(this).addClass("noPrint")}),window.print(),$("#main-content").prepend($("#main-content-in")),$(".ng-hide").each(function(){$(this).removeClass("noPrint")})}),$(document).on("change","#teamSelect",function(){$rootScope.user.tmid=$("option:selected",this).val(),$rootScope.teamNameStr=$("option:selected",this).text(),document.location.href="/panel#!/",$route.reload()}),$(".closeVideoPlayer i").off("click"),$(".closeVideoPlayer i").on("click",function(){$("#videoPlayerContMain video")[0].pause(),$("#videoPlayerContMain").hide()}),$rootScope.toggleCardOptions=function(id){$(".cardOptions").each(function(){var tId=$(this).attr("id");(!tId||tId&&tId!=id)&&$(this).stop().hide("slide",{direction:"up"})}),$("#"+id)&&$("#"+id).first().stop().toggle("slide",{direction:"up"})}}),app.config(function($routeProvider){$.ajax({url:"backend/getModulesFrontRoutes",type:"POST",data:[],async:!0,success:function(msg){if(msg.success)for(var x=0;x<msg.data.length;x++)"badPerm"==msg.data[x].url?$routeProvider.otherwise({templateUrl:msg.data[x].templateSrc}):$routeProvider.when("/"==msg.data[x].url?"/":"/"+msg.data[x].url,{templateUrl:msg.data[x].templateSrc,controller:msg.data[x].controllerName});else msg.error&&$.gritter.add({title:"Bład",text:msg.error,image:"",sticky:!0,time:3,class_name:"my-sticky-class"})},error:function(jqXHR,textStatus){$.gritter.add({title:"Bład",text:"Blad podczas laczenia z serverem: "+textStatus,image:"",sticky:!0,time:3,class_name:"my-sticky-class"})}})});